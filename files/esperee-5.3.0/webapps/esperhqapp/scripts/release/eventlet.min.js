function HQEventletChart(){this.sources=null;this.composition=null;this.parameters=null;this.containerEventTarget=null;this.plot=null;this.mapSourceToSeriesConfig={};this.mapResourceToSourceId={};this.mapSourceToXYFunc={};this.mapLabelToSeriesSettings={};this.mapLabelToData={};this.mapGroupToValue={};this.arrayGroupKeySorted=[];this.dirty=false}
HQEventletChart.prototype.eventletConfigure=function(hqEventletActivation){this.sources=hqEventletActivation.sources;this.composition=hqEventletActivation.composition;this.parameters=hqEventletActivation.parameters;for(var s=0;s<this.sources.length;s++){var source=this.sources[s];this.mapResourceToSourceId[source.resourceId]=source.sourceId}};
HQEventletChart.prototype.eventletInitialize=function(hqEventletContext){this.containerEventTarget=hqEventletContext.containerEventTarget;hqEventletContext.containerEventTarget.addListener(HQ_EVENTTARGET_TYPE.CLEAR.name,function(){this.doMenuClear()}.bind(this));var chartData=this.composition.data;var seriesArray=chartData.series;var i,j,seriesEntry,sourceId,series;var seriesPointSources=[];for(i=0;i<seriesArray.length;i++){series=seriesArray[i];seriesEntry=new SeriesEntry;seriesEntry.functionsPerSource=
{};seriesEntry.label=series.label;seriesEntry.seriesConfig=this.getPerSeriesSettings(series);seriesPointSources.push(seriesEntry);for(j=0;j<series.pointsources.length;j++){var pointsource=series.pointsources[j];this.mapSourceToSeriesConfig[pointsource.sourceId]=seriesEntry.seriesConfig;this.addSeriesPointSource(sourceId,pointsource,seriesEntry)}}var sourceEntry;var mapSourceToXYFunc={};var mapLabelToData={};var mapLabelToSeriesSettings={};for(i=0;i<seriesPointSources.length;i++){seriesEntry=seriesPointSources[i];
for(sourceId in seriesEntry.functionsPerSource){if(!seriesEntry.functionsPerSource.hasOwnProperty(sourceId))continue;sourceEntry=mapSourceToXYFunc[sourceId];if(sourceEntry==null){sourceEntry=new SourceEntry;sourceEntry.sourceXYFuncs=[];mapSourceToXYFunc[sourceId]=sourceEntry}var sourceXYFuncs=new SourceXYFuncEntry;var dataarray=null;if(seriesEntry.label!=null){if(mapLabelToData.hasOwnProperty(seriesEntry.label))dataarray=mapLabelToData[seriesEntry.label];else{dataarray=[];mapLabelToData[seriesEntry.label]=
dataarray}mapLabelToSeriesSettings[seriesEntry.label]=seriesEntry.seriesConfig}else dataarray=[];sourceXYFuncs.dataprovider=dataarray;sourceXYFuncs.lastValue=0;sourceXYFuncs.functions=seriesEntry.functionsPerSource[sourceId];sourceEntry.sourceXYFuncs.push(sourceXYFuncs)}}this.mapSourceToXYFunc=mapSourceToXYFunc;this.mapLabelToData=mapLabelToData;this.mapLabelToSeriesSettings=mapLabelToSeriesSettings;var placeholder=HQJqueryUtil.findElementById(hqEventletContext.rootDOM,"eventlet_chart_div");HQSizeUtil.setSize(placeholder.parent(),
this.parameters,200,180);var config={series:this.getSeriesSettings(this.composition),grid:{hoverable:true,clickable:true},xaxis:this.getXAxisSettings(this.composition),yaxis:this.getYAxisSettings(this.composition),legend:this.getLegendSettings(this.composition)};this.plot=$.plot(placeholder,[],config);var showTooltip=function(x,y,contents){$("\x3cdiv id\x3d'tooltip'\x3e"+contents+"\x3c/div\x3e").css({position:"absolute",display:"none",top:y+5,left:x+5,border:"1px solid #fdd",padding:"2px","background-color":"#fee",
opacity:0.8,"z-index":9E3}).appendTo("body").fadeIn(200)};var previousPoint=null;var myself=this;placeholder.bind("plothover",function(event,pos,item){if(item){if(previousPoint!=item.dataIndex+1024*item.seriesIndex){previousPoint=item.dataIndex+1024*item.seriesIndex;$("#tooltip").remove();var label=item.series.label;if(label==null)label=item.series.data[item.dataIndex][0];var x,y;if(myself.composition.stack==true){var p=item.series.data[item.dataIndex];x=p[0];y=p[1]}else{x=item.datapoint[0];y=item.datapoint[1]}var xrendered=
HQPushUtil.renderPropertyValueNoMetadata(x);showTooltip(item.pageX,item.pageY,label+" of "+xrendered+" \x3d "+y)}}else{$("#tooltip").remove();previousPoint=null}});var myplot=this.plot;placeholder.bind("plotclick",function(event,pos,item){if(item){myplot.highlight(item.series,item.datapoint);if(myself.composition.clickCallback!=null)HQEventletUtil.invokeClickCallback(myself.composition.clickCallback,"item",item,myself.containerEventTarget)}})};
HQEventletChart.prototype.doMenuClear=function(){$.each(this.mapLabelToData,function(key,value){value.length=0});this.mapGroupToValue={};this.arrayGroupKeySorted=[]};
HQEventletChart.prototype.getPerSeriesSettings=function(series){var def={};if(this.composition.type=="area"||series.type=="area"||series.type=="line"){def.lines={show:true};if(this.composition.type=="area"||series.type=="area"){def.lines.fill=true;if(this.composition.opacity!=null)def.lines.fill=this.composition.opacity;if(series.opacity!=null)def.lines.fill=series.opacity}if(series.strokeWeight!=null)def.lines.lineWidth=series.strokeWeight;if(series.strokeColor!=null)def.color=series.strokeColor}else if(series.type==
"column"){def.bars={show:true};if(this.composition.opacity!=null)def.bars.fill=this.composition.opacity;if(series.opacity!=null)def.bars.fill=series.opacity;if(series.strokeWeight!=null)def.bars.lineWidth=series.strokeWeight}if(series.markerType!=null)if(series.markerType.toLowerCase().trim()=="none")def.points={show:false};else def.points={symbol:series.markerType};if(series.fillColor!=null)def.fillColor=series.fillColor;return def};
HQEventletChart.prototype.getSeriesSettings=function(composition){var def={shadowSize:0};var showPoints=this.hasMarkerTypeAnySeries(composition.data.series);if(showPoints)def.points={show:true,radius:5};if(composition.type=="column"){def.bars={show:true,barWidth:0.6,align:"center"};if(this.composition.opacity!=null)def.bars.fill=this.composition.opacity;if(this.composition.stack==true)def.stack=true}else if(composition.type=="pie")def.pie={show:true};else if(this.composition.stack==true)def.stack=
true;return def};
HQEventletChart.prototype.getXAxisSettings=function(composition){var def={show:true};if(composition.type=="column"){def.mode="categories";def.tickLength=0}else if(composition.type=="pie");else if(composition.xaxis.type=="datetime"){def.mode="time";def.timezone="browser"}if(composition.xaxis.label!=null)def.axisLabel=composition.xaxis.label;if(composition.xaxis.placement=="top")def.position="top";if(composition.xaxis.minimum!=null)def.min=composition.xaxis.minimum;if(composition.xaxis.maximum!=null)def.max=
composition.xaxis.maximum;return def};HQEventletChart.prototype.getYAxisSettings=function(composition){var def={show:true};if(composition.yaxis.label!=null)def.axisLabel=composition.yaxis.label;if(composition.yaxis.placement=="right")def.position="right";if(composition.yaxis.minimum!=null)def.min=composition.yaxis.minimum;if(composition.yaxis.maximum!=null)def.max=composition.yaxis.maximum;return def};
HQEventletChart.prototype.getLegendSettings=function(composition){var def={position:"ne"};if(composition.legendPlacement==null)return def;switch(composition.legendPlacement){case "top":return{position:"ne"};case "bottom":return{position:"sw"};case "left":return{position:"nw"};case "right":return{position:"se"};case "ne":case "nw":case "se":case "sw":return{position:composition.legendPlacement}}return def};
HQEventletChart.prototype.eventletUpdate=function(update){var entries=update.entries;for(var u=0;u<entries.length;u++){var upd=entries[u];this.doProcessEntry(upd)}this.renderChart()};
HQEventletChart.prototype.eventletExpire=function(expire){var rowIdOffset=expire.rowIdOffset;$.each(this.mapLabelToData,function(key,value){var indexSplice=-1;for(var i=0;i<value.length;i++){var rowId=value[i][2].rowid;if(rowId<rowIdOffset)indexSplice=i}if(indexSplice!=-1)value.splice(0,indexSplice)});var groupToValue=this.mapGroupToValue;var arrayGroupKeySorted=this.arrayGroupKeySorted;$.each(this.mapGroupToValue,function(key,value){if(value.rowid<rowIdOffset){delete groupToValue[key];HQCollectionUtil.removeFromArrayFirst(arrayGroupKeySorted,
key)}});this.dirty=true;var myself=this;var render=function(){if(myself.dirty)myself.renderChart()};setTimeout(render,1E3)};HQEventletChart.prototype.eventletManifest=function(manifest){};
HQEventletChart.prototype.renderChart=function(){var i,j,key,data=[];if(this.composition.type=="column")if(this.composition.stack==true){var numValuesPerKey=this.getNumValuesPerKeyStacked(this.mapGroupToValue);for(i=0;i<numValuesPerKey;i++){var stackPartData=[];for(j=0;j<this.arrayGroupKeySorted.length;j++){var itemData=[];stackPartData.push(itemData);key=this.arrayGroupKeySorted[j];var val=this.getValuesForKeyStacked(this.mapGroupToValue,key,i);itemData.push(key);itemData.push(val)}var lbl=this.composition.data.series[i].label;
var color=this.composition.data.series[i].fillColor;data.push({data:stackPartData,label:lbl,color:color})}}else{for(i=0;i<this.arrayGroupKeySorted.length;i++){key=this.arrayGroupKeySorted[i];data.push([key,this.mapGroupToValue[key].y])}data=[data]}else if(this.composition.type=="pie")for(i=0;i<this.arrayGroupKeySorted.length;i++){key=this.arrayGroupKeySorted[i];data.push({label:key,data:this.mapGroupToValue[key].y})}else{var mapSettings=this.mapLabelToSeriesSettings;$.each(this.mapLabelToData,function(key,
value){var series=mapSettings[key];series.label=key;series.data=value;data.push(series)})}this.plot.setData(data);this.plot.setupGrid();this.plot.draw();this.dirty=false};
HQEventletChart.prototype.doProcessEntry=function(entry){var resourceIds=entry.resourceIds;var newEvents=entry.newRows;for(var r=0;r<resourceIds.length;r++){var sourceId=this.mapResourceToSourceId[resourceIds[r]];if(sourceId==null)continue;if(newEvents!=null)for(var j=0;j<newEvents.length;j++){var eventObject=newEvents[j];this.handleEventObject(sourceId,eventObject,entry.arrivalTime)}}};
HQEventletChart.prototype.handleEventObject=function(sourceId,event,arrivalTime){var sourceEntry=this.mapSourceToXYFunc[sourceId];if(sourceEntry==null)return;if(sourceEntry.unmapInstruction==null)this.handleEventObjectInternal(sourceId,event,sourceEntry,arrivalTime);else{var copy=JSON.parse(JSON.stringify(event));var map=event[sourceEntry.unmapInstruction.property];for(var key in map){var value=map[key];copy[sourceEntry.unmapInstruction.key]=key;copy[sourceEntry.unmapInstruction.value]=value;this.handleEventObjectInternal(sourceId,
copy,sourceEntry,arrivalTime)}}};
HQEventletChart.prototype.handleEventObjectInternal=function(sourceId,event,sourceEntry,arrivalTime){for(var i=0;i<sourceEntry.sourceXYFuncs.length;i++){var sourceXYFunc=sourceEntry.sourceXYFuncs[i];for(var j=0;j<sourceXYFunc.functions.length;j++){var functions=sourceXYFunc.functions[j];if(functions.labelfunc==null)this.doApply(sourceXYFunc.dataprovider,functions,event,arrivalTime,i);else{var label=functions.labelfunc(event,arrivalTime);var data=this.mapLabelToData[label];if(data==null){data=[];this.mapLabelToData[label]=
data;var series=this.mapSourceToSeriesConfig[sourceId];this.mapLabelToSeriesSettings[label]=JSON.parse(JSON.stringify(series))}this.doApply(data,functions,event,arrivalTime,i)}}}};
HQEventletChart.prototype.doApply=function(seriesDataprovider,fe,event,arrivalTime,sourceXYFuncIndex){var x=fe.xfunc(event,arrivalTime);var y=fe.yfunc(event,arrivalTime);var row=[x,y,{rowid:event.__rowid}];var categorized=this.composition.type=="column"||this.composition.type=="pie";if(!categorized)seriesDataprovider.push(row);else if(this.composition.stack==true){var data;if(!this.mapGroupToValue.hasOwnProperty(x)){this.arrayGroupKeySorted.push(x);this.arrayGroupKeySorted.sort();data=[];this.mapGroupToValue[x]=
data}else data=this.mapGroupToValue[x];data[sourceXYFuncIndex]={y:y,rowid:event.__rowid}}else{if(!this.mapGroupToValue.hasOwnProperty(x)){this.arrayGroupKeySorted.push(x);this.arrayGroupKeySorted.sort()}this.mapGroupToValue[x]={y:y,rowid:event.__rowid}}};
HQEventletChart.prototype.addSeriesPointSource=function(sourceId,pointsource,seriesEntry){var xfunc=this.getPointsourceCallback(pointsource.x,false);var yfunc=this.getPointsourceCallback(pointsource.y,pointsource.incremental);var fe=new FunctionEntry;fe.xfunc=xfunc.callback;fe.xname=xfunc.name;fe.yfunc=yfunc.callback;fe.yname=yfunc.name;if(pointsource.label!=null){var labelfunc=this.getPointsourceCallback(pointsource.label,false);fe.labelfunc=labelfunc.callback;fe.labelname=labelfunc.name}var array=
seriesEntry.functionsPerSource[pointsource.sourceId];if(array==null){array=[];seriesEntry.functionsPerSource[pointsource.sourceId]=array}array.push(fe)};
HQEventletChart.prototype.getPointsourceCallback=function(pointsourceCoordName,incremental){if(pointsourceCoordName==HQ_BUILTIN_PROPERTIES_TYPE.EVENTARRIVALTIME.code)return new NameFunctionPair(HQ_BUILTIN_PROPERTIES_TYPE.EVENTARRIVALTIME.name,function(event,arrivalTime){return arrivalTime});if(pointsourceCoordName==HQ_BUILTIN_PROPERTIES_TYPE.EVENTARRIVALTIMEUTC.code){var timezoneOffsetMsec=HQDateUtil.getTimezoneOffset();return new NameFunctionPair(HQ_BUILTIN_PROPERTIES_TYPE.EVENTARRIVALTIMEUTC.name,
function(event,arrivalTime){return arrivalTime+timezoneOffsetMsec})}if(incremental==null||incremental==false)return new NameFunctionPair(pointsourceCoordName,function(event,arrivalTime){return event[pointsourceCoordName]});var lastValueHolder={};var incrementalFunction=function(event,arrivalTime){var number=event[pointsourceCoordName];if(!isNaN(number))if(lastValueHolder.lastValue==null){lastValueHolder.lastValue=number;return null}else{var diff=number-lastValueHolder.lastValue;lastValueHolder.lastValue=
number;return diff}return null};return new NameFunctionPair("incremental "+pointsourceCoordName,incrementalFunction)};HQEventletChart.prototype.getNumValuesPerKeyStacked=function(mapGroupToValue){var max=-1;for(var key in mapGroupToValue)if(mapGroupToValue.hasOwnProperty(key)){var data=mapGroupToValue[key];if(data!=null)if(max<data.length)max=data.length}if(max==-1)return 0;return max};
HQEventletChart.prototype.getValuesForKeyStacked=function(mapGroupToValue,key,index){var row=mapGroupToValue[key];if(row==null)return 0;if(row.length<index+1)return 0;return row[index].y};HQEventletChart.prototype.hasMarkerTypeAnySeries=function(series){for(var i=0;i<series.length;i++){var mt=series[i].markerType;if(mt==null||mt.toLowerCase().trim()!="none")return true}return false};function SourceEntry(){this.sourceXYFuncs=null;this.unmapInstruction=null}
function FunctionEntry(){this.xfunc=null;this.xname=null;this.yfunc=null;this.yname=null;this.labelfunc=null;this.labelname=null}function SourceXYFuncEntry(){this.dataprovider=null;this.lastValue=null;this.functions=null}function SeriesEntry(){this.functionsPerSource=null;this.label=null;this.seriesConfig=null};HQ_EVENTLET_GAUGE_MARGIN=10;function HQEventletGauge(){this.sources=null;this.composition=null;this.containerEventTarget=null;this.content_div=null;this.screenWidth=null;this.screenHeight=null;this.gauge=null;this.gaugeLastRow=null;this.mapResourceIdSource={}}
HQEventletGauge.prototype.eventletConfigure=function(hqEventletActivation){this.sources=hqEventletActivation.sources;this.composition=hqEventletActivation.composition;for(var i=0;i<this.sources.length;i++)this.mapResourceIdSource[this.sources[i].resourceId]=this.sources[i]};
HQEventletGauge.prototype.eventletInitialize=function(hqEventletContext){this.containerEventTarget=hqEventletContext.containerEventTarget;hqEventletContext.containerEventTarget.addListener(HQ_EVENTTARGET_TYPE.CLEAR.name,function(){this.doMenuClear()}.bind(this));this.content_div=hqEventletContext.rootDOM.find("#content__div");this.screenWidth=Math.max(HQ_TIMELINE_MIN_WIDTH,HQ_TIMELINE_SCREENWIDTH_FACTOR*this.content_div.width());this.screenHeight=Math.max(HQ_TIMELINE_MIN_HEIGHT,this.content_div.height());
var size=this.screenWidth>this.screenHeight?this.screenHeight:this.screenWidth;size-=2*HQ_EVENTLET_GAUGE_MARGIN;if(this.composition.size!=null)size=this.composition.size;var clickCallback=null;var myself=this;if(this.composition.clickCallback!=null)clickCallback=function(){HQEventletUtil.invokeClickCallback(myself.composition.clickCallback,"event",myself.gaugeLastRow,myself.containerEventTarget)};var config={size:size,label:this.composition.caption,minorTicks:this.composition.minorTicks,majorTicks:this.composition.majorTicks,
min:this.composition.minimum,max:this.composition.maximum,clickCallback:clickCallback};config.redZones=[];config.redZones.push({from:this.composition.redFrom,to:this.composition.redTo});config.yellowZones=[];config.yellowZones.push({from:this.composition.yellowFrom,to:this.composition.yellowTo});this.gauge=new Gauge(this.content_div.get(0),config);this.gauge.render()};HQEventletGauge.prototype.doMenuClear=function(){this.gauge.redraw(this.composition.minimum)};
HQEventletGauge.prototype.eventletUpdate=function(update){var entries=update.entries;for(var i=0;i<entries.length;i++){var entry=entries[i];var src=null;for(var r=0;r<entry.resourceIds.length;r++){src=this.mapResourceIdSource[entry.resourceIds[r]];if(src!=null)break}if(src==null)continue;for(var j=0;j<entry.newRows.length;j++){var row=entry.newRows[j];for(var k=0;k<this.composition.pointsources.length;k++){var ps=this.composition.pointsources[k];if(ps.sourceId!=src.sourceId)continue;var valuePoint=
row[ps.x];if(valuePoint==null)continue;this.doEnterValue(src.sourceId,valuePoint);this.gaugeLastRow=row}}}};HQEventletGauge.prototype.doEnterValue=function(sourceId,valuePoint){var val;if(typeof valuePoint=="number")val=valuePoint;else if(typeof(valuePoint=="string"))val=parseInt(valuePoint);this.gauge.redraw(val)};HQEventletGauge.prototype.eventletExpire=function(expire){var rowIdOffset=expire.rowIdOffset;if(rowIdOffset>=this.gaugeLastRow.__rowid)this.gauge.redraw(this.composition.minimum)};
HQEventletGauge.prototype.eventletManifest=function(manifest){};
function Gauge(placeholderDiv,configuration){this.placeholderDiv=placeholderDiv;var self=this;this.configure=function(configuration){this.config=configuration;this.config.size=this.config.size*0.9;this.config.raduis=this.config.size*0.97/2;this.config.cx=this.config.size/2;this.config.cy=this.config.size/2;this.config.min=configuration.min||0;this.config.max=configuration.max||100;this.config.range=this.config.max-this.config.min;this.config.majorTicks=configuration.majorTicks||5;this.config.minorTicks=
configuration.minorTicks||2;this.config.greenColor=configuration.greenColor||"#109618";this.config.yellowColor=configuration.yellowColor||"#FF9900";this.config.redColor=configuration.redColor||"#DC3912"};this.render=function(){var myself=this;var clickCallback=function(){if(myself.config.clickCallback!=null)myself.config.clickCallback()};this.body=d3.select(this.placeholderDiv).append("svg:svg").attr("class","gauge").attr("width",this.config.size).attr("height",this.config.size).on("click",clickCallback);
this.body.append("svg:circle").attr("cx",this.config.cx).attr("cy",this.config.cy).attr("r",this.config.raduis).style("fill","#ccc").style("stroke","#000").style("stroke-width","0.5px");this.body.append("svg:circle").attr("cx",this.config.cx).attr("cy",this.config.cy).attr("r",0.9*this.config.raduis).style("fill","#fff").style("stroke","#e0e0e0").style("stroke-width","2px");for(var index in this.config.greenZones)this.drawBand(this.config.greenZones[index].from,this.config.greenZones[index].to,self.config.greenColor);
for(var index in this.config.yellowZones)this.drawBand(this.config.yellowZones[index].from,this.config.yellowZones[index].to,self.config.yellowColor);for(var index in this.config.redZones)this.drawBand(this.config.redZones[index].from,this.config.redZones[index].to,self.config.redColor);if(undefined!=this.config.label){var fontSize=Math.round(this.config.size/9);this.body.append("svg:text").attr("x",this.config.cx).attr("y",this.config.cy/2+fontSize/2).attr("dy",fontSize/2).attr("text-anchor","middle").text(this.config.label).style("font-size",
fontSize+"px").style("fill","#333").style("stroke-width","0px")}var point1,point2,point;fontSize=Math.round(this.config.size/16);var majorDelta=this.config.range/(this.config.majorTicks-1);var maxTextDone=false;for(var major=this.config.min;major<=this.config.max;major+=majorDelta){var minorDelta=majorDelta/this.config.minorTicks;for(var minor=major+minorDelta;minor<Math.min(major+majorDelta,this.config.max);minor+=minorDelta){point1=this.valueToPoint(minor,0.75);point2=this.valueToPoint(minor,0.85);
this.body.append("svg:line").attr("x1",point1.x).attr("y1",point1.y).attr("x2",point2.x).attr("y2",point2.y).style("stroke","#666").style("stroke-width","1px")}point1=this.valueToPoint(major,0.7);point2=this.valueToPoint(major,0.85);this.body.append("svg:line").attr("x1",point1.x).attr("y1",point1.y).attr("x2",point2.x).attr("y2",point2.y).style("stroke","#333").style("stroke-width","2px");if(major==this.config.min||major==this.config.max){point=this.valueToPoint(major,0.63);if(major==this.config.max)maxTextDone=
true;this.body.append("svg:text").attr("x",point.x).attr("y",point.y).attr("dy",fontSize/3).attr("text-anchor",major==this.config.min?"start":"end").text(major).style("font-size",fontSize+"px").style("fill","#333").style("stroke-width","0px")}}if(!maxTextDone){point=this.valueToPoint(this.config.max,0.63);this.body.append("svg:text").attr("x",point.x).attr("y",point.y).attr("dy",fontSize/3).attr("text-anchor","end").text(this.config.max).style("font-size",fontSize+"px").style("fill","#333").style("stroke-width",
"0px")}var pointerContainer=this.body.append("svg:g").attr("class","pointerContainer");this.drawPointer(0);pointerContainer.append("svg:circle").attr("cx",this.config.cx).attr("cy",this.config.cy).attr("r",0.12*this.config.raduis).style("fill","#4684EE").style("stroke","#666").style("opacity",1)};this.redraw=function(value){this.drawPointer(value)};this.drawBand=function(start,end,color){if(0>=end-start)return;this.body.append("svg:path").style("fill",color).attr("d",d3.svg.arc().startAngle(this.valueToRadians(start)).endAngle(this.valueToRadians(end)).innerRadius(0.65*
this.config.raduis).outerRadius(0.85*this.config.raduis)).attr("transform",function(){return"translate("+self.config.cx+", "+self.config.cy+") rotate(270)"})};this.drawPointer=function(value){var delta=this.config.range/13;var head=this.valueToPoint(value,0.85);var head1=this.valueToPoint(value-delta,0.12);var head2=this.valueToPoint(value+delta,0.12);var tailValue=value-this.config.range*(1/(270/360))/2;var tail=this.valueToPoint(tailValue,0.28);var tail1=this.valueToPoint(tailValue-delta,0.12);
var tail2=this.valueToPoint(tailValue+delta,0.12);var data=[head,head1,tail2,tail,tail1,head2,head];var line=d3.svg.line().x(function(d){return d.x}).y(function(d){return d.y}).interpolate("basis");var pointerContainer=this.body.select(".pointerContainer");var pointer=pointerContainer.selectAll("path").data([data]);pointer.enter().append("svg:path").attr("d",line).style("fill","#dc3912").style("stroke","#c63310").style("fill-opacity",0.7);pointer.transition().attr("d",line);var fontSize=Math.round(this.config.size/
10);pointerContainer.selectAll("text").data([value]).text(Math.round(value)).enter().append("svg:text").attr("x",this.config.cx).attr("y",this.config.size-this.config.cy/4-fontSize).attr("dy",fontSize/2).attr("text-anchor","middle").text(Math.round(value)).style("font-size",fontSize+"px").style("fill","#000").style("stroke-width","0px")};this.valueToDegrees=function(value){return value/this.config.range*270-45};this.valueToRadians=function(value){return this.valueToDegrees(value)*Math.PI/180};this.valueToPoint=
function(value,factor){var point={x:this.config.cx-this.config.raduis*factor*Math.cos(this.valueToRadians(value)),y:this.config.cy-this.config.raduis*factor*Math.sin(this.valueToRadians(value))};return point};this.configure(configuration)};HQEventletGrid_AlwaysUseDatatables=true;HQEventletGrid_AlwaysUseDivs=false;function HQEventletGrid(){this.sources=null;this.typeDataByTypeId={};this.typeNameByTypeId={};this.typeCount=0;this.mapResourceIdSource={};this.sourceInfoDescs=[];this.griddiv=null;this.gridAtomicContext=null;this.compositeGridDesc=null;this.updateNumber=0;this.gridComposite=null}
HQEventletGrid.prototype.eventletConfigure=function(hqEventletActivation){this.sources=hqEventletActivation.sources;for(var i=0;i<this.sources.length;i++){var source=this.sources[i];this.mapResourceIdSource[source.resourceId]=source;if(source.hasOwnProperty("manifest"))this.processManifest(source.manifest);var srcInfo=new SourceInfoDesc;srcInfo.sourceId=source.sourceId;if(source.manifest!=null){var typeName=HQPushUtil.getTargetName(source.manifest.target);if(this.typeNameByTypeId[source.manifest.typeId]==
null)this.typeCount++;this.typeNameByTypeId[source.manifest.typeId]=typeName;srcInfo.props=source.manifest.definition.properties}this.sourceInfoDescs.push(srcInfo)}this.compositeGridDesc=CompatibilityUtil.makeCompositionDesc(hqEventletActivation.composition,this.sourceInfoDescs)};
HQEventletGrid.prototype.eventletInitialize=function(hqEventletContext){this.griddiv=HQJqueryUtil.findElementById(hqEventletContext.rootDOM,"eventlet_grid");hqEventletContext.containerEventTarget.addListener(HQ_EVENTTARGET_TYPE.CLEAR.name,function(){this.doMenuClear()}.bind(this));this.gridAtomicContext=new GridAtomicContext(this.sources,this.compositeGridDesc,hqEventletContext.containerEventTarget);var topLevelFactory=GridCompositeBuilder.make(this.compositeGridDesc,this.gridAtomicContext,null);
this.gridComposite=topLevelFactory.make();var rootDOM=this.gridComposite.getRootDOM();this.griddiv.empty();this.griddiv.append(rootDOM)};HQEventletGrid.prototype.doMenuClear=function(){var updatedTables={};this.gridComposite.clearAllData(updatedTables);this.renderTables(updatedTables)};
HQEventletGrid.prototype.eventletUpdate=function(update){var entries=update.entries;this.updateNumber++;var updatedTables={};for(var i=0;i<entries.length;i++){var entry=entries[i];var src=null;for(var r=0;r<entry.resourceIds.length;r++){src=this.mapResourceIdSource[entry.resourceIds[r]];if(src!=null)break}if(src==null)continue;if(entry.newRows==null)continue;for(var j=0;j<entry.newRows.length;j++){var row=entry.newRows[j];this.processEvent(this.updateNumber,src.sourceId,entry.typeId,row,entry.arrivalTime,
updatedTables)}}this.renderTables(updatedTables)};HQEventletGrid.prototype.eventletExpire=function(expire){var rowIdOffset=expire.rowIdOffset;var updatedTables={};this.gridComposite.expireRows(rowIdOffset,updatedTables);this.renderTables(updatedTables)};
HQEventletGrid.prototype.eventletManifest=function(manifest){var entries=manifest.manifests;console.log("Received controller manifest "+entries);for(var i=0;i<entries.length;i++){var m=entries[i];this.processManifest(m.manifest);var typeName=HQPushUtil.getTargetName(m.manifest.target);if(this.typeNameByTypeId[m.manifest.typeId]==null)this.typeCount++;this.typeNameByTypeId[m.manifest.typeId]=typeName;this.gridAtomicContext.lateManifest(m.manifest.definition.properties)}};
HQEventletGrid.prototype.renderTables=function(updatedTables){for(var tableuuid in updatedTables)if(updatedTables.hasOwnProperty(tableuuid)){var tableEntry=updatedTables[tableuuid];this.updateTable(this.updateNumber,tableEntry)}};
HQEventletGrid.prototype.processEvent=function(updateNumber,sourceId,typeId,event,arrivalTime,updatedTables){event[GridBuiltinFieldEnum.TIMESTAMP_PROP_NAME]=(new Date).getTime();event[GridBuiltinFieldEnum.ARRIVALTIME_PROP_NAME]=HQDateUtil.printDate(arrivalTime);event[GridBuiltinFieldEnum.SOURCE_PROP_NAME]=this.typeNameByTypeId[typeId];event[GridBuiltinFieldEnum.UPDATENUM_PROP_NAME]=updateNumber;var target=this.typeDataByTypeId[typeId];if(target!=null)HQPushUtil.rerenderProperties(event,target.properties);
this.gridComposite.processRow(sourceId,event,updateNumber,updatedTables)};
HQEventletGrid.prototype.updateTable=function(updateNumber,table){var data=[];var highlighted=[];var columnDefs=table.columns;var rows=table.rows;var i,j,coldef,col,value,therow;if(table.datatable){for(i=0;i<rows.length;i++){var datarow=[];therow=rows[i];data.push(datarow);if(therow[GridBuiltinFieldEnum.UPDATENUM_PROP_NAME]==updateNumber)highlighted.push(i);for(j=0;j<columnDefs.length;j++){coldef=columnDefs[j];if(coldef.isDatatableColumn){col=coldef.datafield;value=therow[col];datarow.push(HQStringUtil.emptyString(HQPushUtil.renderPropertyValueNoMetadata(value)))}}}table.datatable.fnClearTable();
table.datatable.fnAddData(data);var nodes=table.datatable.fnGetNodes();for(i=0;i<highlighted.length;i++)$(nodes[highlighted[i]]).addClass("eventlet-grid-inplace-highlighted")}else{var body=table.htmltable.find("tbody");body.empty();for(i=0;i<rows.length;i++){body.append("\x3ctr\x3e\x3c/tr\x3e");var tr=$(body.children()[i]);therow=rows[i];for(j=0;j<columnDefs.length;j++){coldef=columnDefs[j];if(!coldef.isHtmlTableVisible)continue;col=coldef.datafield;value=therow[col];tr.append("\x3ctd\x3e"+value+
"\x3c/td\x3e")}}}};HQEventletGrid.prototype.processManifest=function(manifest){var typeDef=new HQEventletTargetEntry(manifest);this.typeDataByTypeId[manifest.typeId]=typeDef};SourceInfoDesc=function(){this.sourceId=null;this.props=null};CompositeGridDesc=function(){this.atomicType=null;this.clickCallback=null;this.style=null;this.ckeys=[];this.displayCol=null};CompatibilityUtil=function(){};
CompatibilityUtil.makeCompositionDesc=function(composition,sourceInfoDescs){var spec=null;if(composition.hasOwnProperty("appendgrid")){spec=new CompositeGridDesc;spec.atomicType=GridAtomicTypeEnum.TYPE_APPENDTOP;spec.clickCallback=composition.appendgrid.clickCallback}else if(composition.hasOwnProperty("inplacegrid")){var inplacegrid=composition.inplacegrid;if(inplacegrid.keys.length==0)throw new Error("No grid keys have been provided by the grid configuration object, grid key names are required.");
spec=new CompositeGridDesc;spec.atomicType=GridAtomicTypeEnum.TYPE_INPLACEUPD;spec.clickCallback=inplacegrid.clickCallback;spec.ckeys=[];for(var i=0;i<inplacegrid.keys.length;i++){var inplaceKey=inplacegrid.keys[i];var ckey=new CompositeGridKey;ckey.nestingType=NestingTypeEnum.TYPE_INPLACE;ckey.pointsources=[];for(var j=0;j<sourceInfoDescs.length;j++){var src=sourceInfoDescs[j];var ps1={x:inplaceKey,sourceId:src.sourceId};ckey.pointsources.push(ps1)}spec.ckeys.push(ckey)}}else if(composition.hasOwnProperty("compositegrid"))spec=
composition.compositegrid;else if(composition==null)throw new Error("No composition provided");return spec};CompositeGridKey=function(){this.nestingType=null;this.pointsources=[];this.style=null};GridAtomicTypeEnum={TYPE_APPENDTOP:"appendtop",TYPE_APPENDEND:"appendend",TYPE_LASTUPD:"lastvalue",TYPE_INPLACEUPD:"inplace"};NestingTypeEnum={TYPE_COLUMN:"col",TYPE_ROW:"row",TYPE_TAB:"tab",TYPE_INPLACE:"inplace"};
GridBuiltinFieldEnum={TIMESTAMP_PROP_NAME:"__ts",STYLEUTIL_PROP_NAME:"__sutil",STYLENAMEGRID_PROP_NAME:"__sgname",STYLENAMEINPL_PROP_NAME:"__siname",KEY_PROP_NAME:"__key",ARRIVALTIME_PROP_NAME:"__arrival",SOURCE_PROP_NAME:"__source",ROWNUM_PROP_NAME:"__rownum",EVENTNUM_PROP_NAME:"__eventnum",UPDATENUM_PROP_NAME:"__updnum"};NestingTypeEnum.getNestedKeys=function(ckeys){var result=[];if(ckeys==null)return result;for(var i=0;i<ckeys.length;i++){var ckey=ckeys[i];if(ckey.nestingType!=NestingTypeEnum.TYPE_INPLACE)result.push(ckey)}return result};
NestingTypeEnum.getInplaceKeys=function(ckeys){var result=[];if(ckeys==null)return result;for(var i=0;i<ckeys.length;i++){var ckey=ckeys[i];if(ckey.nestingType==NestingTypeEnum.TYPE_INPLACE)result.push(ckey)}return result};
function GridAtomicContext(activationSources,spec,containerEventTarget){this._dataGridsAtomic=[];this._dataGridColumns=[];this._columnsDef=[];this._spec=spec;this._containerEventTarget=containerEventTarget;this._inplacestyle=null;this._useHTMLTables=spec.hasOwnProperty("ckeys")&&spec.ckeys.length>0;var i,j,ps,s;if(GridAtomicTypeEnum.TYPE_INPLACEUPD==spec.atomicType){var inplaceKeys=NestingTypeEnum.getInplaceKeys(spec.ckeys);for(i=0;i<inplaceKeys.length;i++){var key=inplaceKeys[i];if(key.style!=null)_inplacestyle=
key.style}}if(spec.ckeys!=null)for(i=0;i<spec.ckeys.length;i++){var ckey=spec.ckeys[i];if(ckey.nestingType==NestingTypeEnum.TYPE_INPLACE){ps=ckey.pointsources[0];var propertyDesc=this.getPropertyByName(activationSources,ps.x);if(propertyDesc!=null){this._columnsDef.push(new ColumnDef(HQPushUtil.computeDatafieldName(propertyDesc),propertyDesc.propertyName,true,true,true));this._dataGridColumns[propertyDesc.propertyName]=true}else{this._columnsDef.push(new ColumnDef(ps.x,ps.x,true,true,true));this._dataGridColumns[ps.x]=
true}}if(ckey.pointsources!=null)for(j=0;j<ckey.pointsources.length;j++){ps=ckey.pointsources[j];this._dataGridColumns[ps.x]=true}}this._columnsDef.push(new ColumnDef(GridBuiltinFieldEnum.TIMESTAMP_PROP_NAME,"__ts",false,true,false));this._columnsDef.push(new ColumnDef(GridBuiltinFieldEnum.KEY_PROP_NAME,"__key",false,false,false));var timeVisible=spec.displayTime==null||spec.displayTime;this._columnsDef.push(new ColumnDef(GridBuiltinFieldEnum.ARRIVALTIME_PROP_NAME,"Last Update",timeVisible,timeVisible,
timeVisible));var srcVisible=spec.displaySource==null||spec.displaySource;this._columnsDef.push(new ColumnDef(GridBuiltinFieldEnum.SOURCE_PROP_NAME,"Source",srcVisible,srcVisible,srcVisible));var rownumVisible=GridAtomicTypeEnum.TYPE_INPLACEUPD!=spec.atomicType;rownumVisible=rownumVisible&&(spec.displayRowNum==null||spec.displayRowNum);this._columnsDef.push(new ColumnDef(GridBuiltinFieldEnum.ROWNUM_PROP_NAME,"Row Number",rownumVisible,rownumVisible,rownumVisible));var eventnumVisible=spec.displayEventNum!=
null&&spec.displayEventNum;this._columnsDef.push(new ColumnDef(GridBuiltinFieldEnum.EVENTNUM_PROP_NAME,"Event Number",eventnumVisible,eventnumVisible,eventnumVisible));var updnumVisible=spec.displayUpdNum!=null&&spec.displayUpdNum;this._columnsDef.push(new ColumnDef(GridBuiltinFieldEnum.UPDATENUM_PROP_NAME,"Update Number",updnumVisible,updnumVisible,updnumVisible));if(activationSources!=null)for(s=0;s<activationSources.length;s++){var sourceDesc=activationSources[s];if(sourceDesc.manifest!=null)this.doManifestColumns(sourceDesc.manifest.definition.properties)}}
GridAtomicContext.prototype.newGrid=function(atomic,datatableconfig){this._dataGridsAtomic.push(atomic);var html='\x3cdiv class\x3d"eventlet_grid_tablediv"\x3e                        \x3ctable class\x3d"eventlet_grid_table"\x3e                        \x3cthead\x3e                        \x3c/thead\x3e                        \x3ctbody\x3e                        \x3c/tbody\x3e                        \x3c/table\x3e                        \x3c/div\x3e';var tableDiv=$(html);return this.initializeGrid(tableDiv,
datatableconfig)};
GridAtomicContext.prototype.initializeGrid=function(tableDiv,datatableconfig){var useHTMLOnly=this._useHTMLTables&&!HQEventletGrid_AlwaysUseDatatables;var table=tableDiv.find("table");HQTableUtil.populateTableHeader(table,this._columnsDef,useHTMLOnly);table.find("tbody").empty();if(useHTMLOnly)return{datatable:null,div:tableDiv,htmltable:table};else{var invisible=[];for(var i=0;i<this._columnsDef.length;i++){var def=this._columnsDef[i];if(!def.isDatatableColumn)continue;if(def.isDatatableVisible==false)invisible.push(i)}var config=
{"bPaginate":false,"bLengthChange":false,"bFilter":false,"bInfo":false,"aoColumnDefs":[{"bVisible":false,"aTargets":invisible}],"bAutoWidth":false};HQObjectUtil.mergeObject(datatableconfig,config);var datatable=$(table).dataTable(config);return{datatable:datatable,div:tableDiv,htmltable:table}}};GridAtomicContext.prototype.clearHistory=function(){for(var i=0;i<this._dataGridsAtomic.length;i++){var dga=this._dataGridsAtomic[i];dga.clearAll()}};
GridAtomicContext.prototype.lateManifest=function(propertyArray){var added=this.doManifestColumns(propertyArray);if(added.length==0)return;for(var i=0;i<this._dataGridsAtomic.length;i++){var dga=this._dataGridsAtomic[i];dga.addColumns(added)}};GridAtomicContext.prototype.inplaceStyle=function(){return this._inplacestyle};GridAtomicContext.prototype.showRowNum=function(){return this._spec.displayCol==null||this._spec.displayCol.rownum};
GridAtomicContext.prototype.getPropertyByName=function(activationSources,propertyName){if(activationSources==null)return null;for(var i=0;i<activationSources.length;i++){var sourceDesc=activationSources[i];if(sourceDesc.manifest!=null)for(var j=0;j<sourceDesc.manifest.definition.properties.length;j++){var p=sourceDesc.manifest.definition.properties[j];if(p.propertyName==propertyName)return p}}return null};
GridAtomicContext.prototype.doManifestColumns=function(propertyArray){var addedColumns=[];for(var p=0;p<propertyArray.length;p++){var propertyDesc=propertyArray[p];if(this._dataGridColumns[propertyDesc.propertyName]!=null)continue;var coldesc=new ColumnDef(HQPushUtil.computeDatafieldName(propertyDesc),propertyDesc.propertyName,true,true,true);addedColumns.push(coldesc);this._columnsDef.push(coldesc);this._dataGridColumns[propertyDesc.propertyName]=true}return addedColumns};GridCompositeBuilder=function(){};
GridCompositeBuilder.make=function(spec,context,styleHelper){var ckey,i;var itemsNonGrid=[];var itemsInGrid=[];if(spec.ckeys!=null)for(i=0;i<spec.ckeys.length;i++){ckey=spec.ckeys[i];if(ckey.nestingType!=NestingTypeEnum.TYPE_INPLACE)itemsNonGrid.push(ckey);else itemsInGrid.push(ckey)}var lastFactory=new GridCompositeFactoryAtomic(itemsInGrid,spec.atomicType,context);if(itemsNonGrid.length==0)return lastFactory;for(i=itemsNonGrid.length-1;i>=0;i--){ckey=itemsNonGrid[i];lastFactory=new GridCompositeFactoryNonAtomic(lastFactory,
ckey.pointsources,ckey.nestingType,styleHelper,ckey.style)}return lastFactory};GridCompositeFactoryAtomic=function(inplaceKeys,updateType,context){this.inplaceKeys=inplaceKeys;this.updateType=updateType;this.context=context};GridCompositeFactoryAtomic.prototype.make=function(){var atomic=new GridCompositeAtomic;atomic.init(this.inplaceKeys,this.updateType,this.context);return atomic};
GridCompositeFactoryNonAtomic=function(innerfactory,pointsources,type,styleHelper,style){this._pointsources=pointsources;this._innerfactory=innerfactory;this._type=type;this._styleHelper=styleHelper;this._style=style};
GridCompositeFactoryNonAtomic.prototype.make=function(){var grid;if(this._type==NestingTypeEnum.TYPE_COLUMN){grid=new GridCompositeHGrid;grid.init(this._pointsources,this._innerfactory)}else if(this._type==NestingTypeEnum.TYPE_ROW){grid=new GridCompositeVGrid;grid.init(this._pointsources,this._innerfactory)}else if(this._type==NestingTypeEnum.TYPE_TAB){grid=new GridCompositeTabGrid;grid.init(this._pointsources,this._innerfactory)}else throw new Error("Unknown type '"+this._type+"'");return grid};
GridCompositeAtomic=function(){this._tableuuid=HQUUIDGenerator.generateUUID();this._rootdiv=null;this._datatable=null;this._context=null;this._datatableconfig={};this._eventNum=0;this._dgNumKeys=0;this._updLastUpdateNum=0;this._updLastValueOnly=false;this._updAppendTop=false;this._updAppendEnd=false;this._updInplace=false;this._showRowNum=false;this._keyHelper=null};GridCompositeAtomic.prototype.getRootDOM=function(){return this._rootdiv};
GridCompositeAtomic.prototype.init=function(ckeys,updateType,context){this._context=context;this._showRowNum=context.showRowNum;if(updateType==GridAtomicTypeEnum.TYPE_LASTUPD)this._updLastValueOnly=true;else if(updateType==GridAtomicTypeEnum.TYPE_APPENDTOP){this._updAppendTop=true;this._datatableconfig.bSort=false}else if(updateType==GridAtomicTypeEnum.TYPE_APPENDEND){this._updAppendEnd=true;this._datatableconfig.bSort=false}else if(updateType==GridAtomicTypeEnum.TYPE_INPLACEUPD){this._updInplace=
true;if(ckeys!=null&&ckeys.length>0)_keyHelper=new PointsourceCompositeKeyHelper(ckeys);else throw new Error("No in-place keys are specified");}else throw new Error("Unrecognized update type: "+updateType);if(ckeys.length==0){if(updateType==GridAtomicTypeEnum.TYPE_INPLACEUPD)throw new Error("Invalid combination of zero key fields and in-place update");}else if(updateType!=GridAtomicTypeEnum.TYPE_INPLACEUPD)throw new Error("Invalid combination of key fields and append update");var result=this._context.newGrid(this,
this._datatableconfig);this._datatable=result.datatable;this._rootdiv=result.div;this._htmltable=result.htmltable;this._dgRows=[];this._dgKeys=[];if(this._datatable!=null)if(this._context._spec.clickCallback!=null){var myself=this;this._datatable.delegate("tr","click",function(){var rownum=myself._datatable.fnGetPosition(this);if(rownum!=null){var data=myself._dgRows[rownum];HQEventletUtil.invokeClickCallback(myself._context._spec.clickCallback,"row",data,myself._context._containerEventTarget)}})}};
GridCompositeAtomic.prototype.renumberRowNum=function(){for(var i=0;i<this._dgRows.length;i++){var row=this._dgRows[i];if(row==null)continue;row[GridBuiltinFieldEnum.ROWNUM_PROP_NAME]=i+1}};
GridCompositeAtomic.prototype.processRow=function(sourceId,row,updateNumber,updatedTables){this._eventNum++;row[GridBuiltinFieldEnum.EVENTNUM_PROP_NAME]=this._eventNum;if(this._updAppendTop){row[GridBuiltinFieldEnum.ROWNUM_PROP_NAME]=this._dgRows.length+1;row[GridBuiltinFieldEnum.UPDATENUM_PROP_NAME]=-1;this._dgRows.unshift(row);if(this._showRowNum)this.renumberRowNum()}else if(this._updAppendEnd){row[GridBuiltinFieldEnum.ROWNUM_PROP_NAME]=this._dgRows.length+1;row[GridBuiltinFieldEnum.UPDATENUM_PROP_NAME]=
-1;this._dgRows.push(row);if(this._showRowNum)this.renumberRowNum()}else if(this._updLastValueOnly){row[GridBuiltinFieldEnum.UPDATENUM_PROP_NAME]=-1;if(this._updLastUpdateNum!=updateNumber)this._dgRows.length=0;_updLastUpdateNum=updateNumber;row[GridBuiltinFieldEnum.ROWNUM_PROP_NAME]=this._dgRows.length+1;this._dgRows.push(row)}else{var keyObject=_keyHelper.getKey(sourceId,row);var index=this._dgKeys[keyObject];row[GridBuiltinFieldEnum.KEY_PROP_NAME]=keyObject;var keyAdded=index==null;if(keyAdded){this._dgKeys[keyObject]=
this._dgRows.length;this._dgRows.push(row);index=this._dgNumKeys;this._dgNumKeys++}else{if(this._dgRows.length<index+1)return;this._dgRows[index]=row}}this.populateUpdatedTables(updatedTables)};GridCompositeAtomic.prototype.clearAllData=function(updatedTables){this._dgRows=[];this._dgKeys=[];this._dgNumKeys=0;this.populateUpdatedTables(updatedTables)};
GridCompositeAtomic.prototype.populateUpdatedTables=function(updatedTables){updatedTables[this._tableuuid]={datatable:this._datatable,htmltable:this._htmltable,rows:this._dgRows,columns:this._context._columnsDef}};
GridCompositeAtomic.prototype.expireRows=function(rowIdOffset,updatedTables){var cleaned=[];var expired=[];var i,row,rowId;for(i=0;i<this._dgRows.length;i++){row=this._dgRows[i];rowId=row.__rowid;if(rowId<=rowIdOffset)expired.push(row);else cleaned.push(row)}if(expired.length>0&&this._updInplace){this._dgNumKeys=cleaned.length;this._dgKeys={};for(i=0;i<cleaned.length;i++){row=cleaned[i];var key=row[GridBuiltinFieldEnum.KEY_PROP_NAME];this._dgKeys[key]=i}}if(this._updAppendEnd&&this._showRowNum)this.renumberRowNum();
if(cleaned.length!=this._dgRows.length){this._dgRows=cleaned;this.populateUpdatedTables(updatedTables)}};GridCompositeAtomic.prototype.addColumns=function(columnsDef){if(this._datatable!=null)this._datatable.fnDestroy();var result=this._context.initializeGrid(this._rootdiv,this._datatableconfig);this._datatable=result.datatable};PointsourceDesc=function(x,sourceId){this.x=x;this.sourceId=sourceId};
PointsourceKeyHelper=function(ps){this.isSingle=false;this.singleKey=null;this.sources=null;if(ps==null||ps.length==0)throw new Error("Invalid number of point sources, none provided");if(ps.length==1){this.isSingle=true;this.singleKey=ps[0].x;if(this.singleKey==null)throw new Error("Invalid x-value for point source, null value encountered");return}this.sources=[];for(var i=0;i<ps.length;i++){var psd=ps[i];if(psd.x==null)throw new Error("Invalid x-value for point source, null value encountered");this.sources[psd.sourceId]=
psd.x}};PointsourceKeyHelper.prototype.getKey=function(sourceId,row){if(this.isSingle)return row[this.singleKey];var keyName=this.sources[sourceId];if(keyName==null)return null;return row[keyName]};
PointsourceCompositeKeyHelper=function(ckeys){this._singleKey=null;this._sources=null;this._keyPropertyNames=[];if(ckeys==null||ckeys.length==0)throw new Error("Invalid number of in-place keys, none provided");var ckey;if(ckeys.length==1){ckey=ckeys[0];this._singleKey=new PointsourceKeyHelper(ckey.pointsources);this._keyPropertyNames.push(ckey.pointsources[0].x);return}this._sources=[];for(var i=0;i<ckeys.length;i++){ckey=ckeys[i];for(var j=0;j<ckey.pointsources.length;j++){var psd=ckey.pointsources[j];
this._keyPropertyNames.push(ckey.pointsources[0].x);if(psd.x==null)throw new Error("Invalid x-value for point source, null value encountered");var keyArr=this._sources[psd.sourceId];if(keyArr==null){keyArr=[];this._sources[psd.sourceId]=keyArr}keyArr.push(psd.x)}}};PointsourceCompositeKeyHelper.prototype.keyPropertyNames=function(){return this._keyPropertyNames};
PointsourceCompositeKeyHelper.prototype.getKey=function(sourceId,row){if(this._singleKey!=null)return this._singleKey.getKey(sourceId,row);var keyProperties=this._sources[sourceId];if(keyProperties==null)return null;var multikey=[];var key;var value;var i;for(i=0;i<keyProperties.length;i++){key=keyProperties[i];value=row[key];multikey.push(value)}return multikey};GridCompositeHGrid=function(){this._keyHelper=null;this._innerfactory=null;this._grid=null;this._gridPerKey=null;this._titles=null};
GridCompositeHGrid.prototype.getRootDOM=function(){return this._grid};GridCompositeHGrid.prototype.init=function(pointsources,innerfactory){this._keyHelper=new PointsourceKeyHelper(pointsources);this._innerfactory=innerfactory;this._gridPerKey=[];this._titles=[];this.grid=null;if(HQEventletGrid_AlwaysUseDivs)this._grid=$('\x3cdiv class\x3d"eventlet_grid_hcontainer"\x3e\x3c/div\x3e');else this._grid=$("\x3ctable\x3e\x3cthead\x3e\x3ctr\x3e\x3c/tr\x3e\x3c/thead\x3e\x3ctbody\x3e\x3ctr\x3e\x3c/tr\x3e\x3c/tbody\x3e\x3c/table\x3e")};
GridCompositeHGrid.prototype.processRow=function(sourceId,row,updateNumber,updatedTables){var columnKey=this._keyHelper.getKey(sourceId,row);var inner=this._gridPerKey[columnKey];if(inner==null){inner=this._innerfactory.make();this._gridPerKey[columnKey]=inner;var addIndex=HQCollectionUtil.findInsertIndexStringSortedArray(this._titles,columnKey);this._titles.splice(addIndex,0,columnKey);if(!HQEventletGrid_AlwaysUseDivs){var headrow=this._grid.children("thead:first-child()").children("tr:first-child()");
var headcontent=$("\x3cth\x3e"+columnKey+"\x3c/th\x3e");HQJqueryUtil.insertAtPosition(headrow,headcontent,addIndex);var bodyrow=this._grid.children("tbody").children("tr:first-child()");var bodycontent=$("\x3ctd\x3e\x3c/td\x3e");bodycontent.append(inner.getRootDOM());HQJqueryUtil.insertAtPosition(bodyrow,bodycontent,addIndex)}else{var griditem=$('\x3cdiv class\x3d"eventlet_grid_hfloat"\x3e'+'\x3cdiv class\x3d"eventlet_grid_htitle"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"eventlet_grid_hdata"\x3e\x3c/div\x3e'+
"\x3c/div\x3e");HQJqueryUtil.insertAtPosition(this._grid,griditem,addIndex);griditem.find(".eventlet_grid_htitle").append("\x3cspan\x3e"+columnKey+"\x3c/span\x3e");var innerDOM=inner.getRootDOM();griditem.find(".eventlet_grid_hdata").append(inner.getRootDOM())}}inner.processRow(sourceId,row,updateNumber,updatedTables)};GridCompositeHGrid.prototype.clearAllData=function(updatedTables){for(var key in this._gridPerKey)if(this._gridPerKey.hasOwnProperty(key)){var inner=this._gridPerKey[key];inner.clearAllData(updatedTables)}};
GridCompositeVGrid=function(){this._keyHelper=null;this._innerfactory=null;this._grid=null;this._gridPerKey=null;this._titles=null};GridCompositeVGrid.prototype.getRootDOM=function(){return this._grid};
GridCompositeVGrid.prototype.init=function(pointsources,innerfactory){this._keyHelper=new PointsourceKeyHelper(pointsources);this._innerfactory=innerfactory;this._gridPerKey=[];this._titles=[];this.grid=null;if(HQEventletGrid_AlwaysUseDivs)this._grid=$('\x3cdiv class\x3d"eventlet_grid_vcontainer"\x3e\x3c/div\x3e');else this._grid=$("\x3ctable\x3e\x3ctbody\x3e\x3c/tbody\x3e\x3c/table\x3e")};
GridCompositeVGrid.prototype.processRow=function(sourceId,row,updateNumber,updatedTables){var columnKey=this._keyHelper.getKey(sourceId,row);var inner=this._gridPerKey[columnKey];if(inner==null){inner=this._innerfactory.make();this._gridPerKey[columnKey]=inner;var addIndex=HQCollectionUtil.findInsertIndexStringSortedArray(this._titles,columnKey);this._titles.splice(addIndex,0,columnKey);if(!HQEventletGrid_AlwaysUseDivs){var rowcontent=$("\x3ctr\x3e\x3c/tr\x3e");rowcontent.append("\x3ctd\x3e"+columnKey+
"\x3c/td\x3e");var innercontent=$("\x3ctd\x3e\x3c/td\x3e");innercontent.append(inner.getRootDOM());rowcontent.append(innercontent);var body=this._grid.children("tbody");HQJqueryUtil.insertAtPosition(body,rowcontent,addIndex)}else{var griditem=$('\x3cdiv class\x3d"eventlet_grid_divvfloat"\x3e'+'\x3cdiv class\x3d"eventlet_grid_divvtitle"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"eventlet_grid_divvdata"\x3e\x3c/div\x3e'+'\x3cdiv class\x3d"eventlet_grid_divveol"\x3e\x3c/div\x3e'+"\x3c/div\x3e");HQJqueryUtil.insertAtPosition(this._grid,
griditem,addIndex);griditem.find(".eventlet_grid_divvtitle").append("\x3cspan\x3e"+columnKey+"\x3c/span\x3e");var innerDOM=inner.getRootDOM();griditem.find(".eventlet_grid_divvdata").append(inner.getRootDOM())}}inner.processRow(sourceId,row,updateNumber,updatedTables)};GridCompositeVGrid.prototype.clearAllData=function(updatedTables){for(var key in this._gridPerKey)if(this._gridPerKey.hasOwnProperty(key)){var inner=this._gridPerKey[key];inner.clearAllData(updatedTables)}};
ColumnDef=function(datafield,headerText,isHtmlTableVisible,isDatatableColumn,isDatatableVisible){this.datafield=datafield;this.headerText=headerText;this.isHtmlTableVisible=isHtmlTableVisible;this.isDatatableColumn=isDatatableColumn;this.isDatatableVisible=isDatatableVisible};GridCompositeTabGrid=function(){this._keyHelper=null;this._innerfactory=null;this._grid=null;this._gridPerKey=null;this._titles=null};GridCompositeTabGrid.prototype.getRootDOM=function(){return this._grid};
GridCompositeTabGrid.prototype.init=function(pointsources,innerfactory){this._keyHelper=new PointsourceKeyHelper(pointsources);this._innerfactory=innerfactory;this._gridPerKey=[];this._titles=[];this.grid=null;this.tab=null;this._grid=$("\x3cdiv\x3e\x3cul\x3e\x3c/ul\x3e\x3c/div\x3e");this._tab=this._grid.tabs();this._currentIndex=0};
GridCompositeTabGrid.prototype.processRow=function(sourceId,row,updateNumber,updatedTables){var columnKey=this._keyHelper.getKey(sourceId,row);var inner=this._gridPerKey[columnKey];if(inner==null){inner=this._innerfactory.make();this._gridPerKey[columnKey]=inner;var addIndex=HQCollectionUtil.findInsertIndexStringSortedArray(this._titles,columnKey);this._titles.splice(addIndex,0,columnKey);this._currentIndex++;var headrow=this._grid.children("ul:first-child()");var html='\x3cli\x3e\x3ca href\x3d"#tabs-THETABNUM"\x3eTHETABNAME\x3c/a\x3e\x3c/li\x3e';
html=HQStringUtil.replaceAll("THETABNUM",this._currentIndex,html);html=HQStringUtil.replaceAll("THETABNAME",columnKey,html);var headcontent=$(html);HQJqueryUtil.insertAtPosition(headrow,headcontent,addIndex);html='\x3cdiv id\x3d"tabs-THETABNUM"\x3e\x3c/div\x3e';html=HQStringUtil.replaceAll("THETABNUM",this._currentIndex,html);var bodycontent=$(html);bodycontent.append(inner.getRootDOM());HQJqueryUtil.insertAtPosition(this._grid,bodycontent,addIndex+1);this._tab.tabs("refresh");if(this._titles.length==
1)this._tab.tabs("option","active",0)}inner.processRow(sourceId,row,updateNumber,updatedTables)};GridCompositeTabGrid.prototype.clearAllData=function(updatedTables){for(var key in this._gridPerKey)if(this._gridPerKey.hasOwnProperty(key)){var inner=this._gridPerKey[key];inner.clearAllData(updatedTables)}};function EventletPluginExample(){this.rootDOM=null}EventletPluginExample.prototype.eventletConfigure=function(hqEventletActivation){console.log("Configuring eventlet.")};EventletPluginExample.prototype.eventletInitialize=function(hqEventletContext){console.log("Initializing eventlet.");this.rootDOM=hqEventletContext.rootDOM};
EventletPluginExample.prototype.eventletUpdate=function(update){var entries=update.entries;console.log("Received data");var html="\x3cp\x3eReceived events: "+entries.length+"\x3c/p\x3e";this.rootDOM.append($(html))};EventletPluginExample.prototype.eventletExpire=function(expire){console.log("Received expiry")};EventletPluginExample.prototype.eventletManifest=function(manifest){console.log("Received manifest")};var HQ_TIMELINE_SCREENWIDTH_FACTOR=3;var HQ_TIMELINE_MIN_WIDTH=600;var HQ_TIMELINE_MIN_HEIGHT=400;var HQ_TIMELINE_MARGIN_BOTTOM=40;var HQ_TIMELINE_MARGIN_TOP=40;var HQ_TIMELINE_MARGIN_LEFT=40;var HQ_TIMELINE_MARGIN_RIGHT=40;var HQ_TIMELINE_MARGIN_VERTICAL_SCALE=15;
function HQEventletTimeline(){this.sources=null;this.composition=null;this.parameters=null;this.axis_d3_svg=null;this.axis_d3_axis=null;this.axis_d3_scale=null;this.screenWidth=null;this.screenHeight=null;this.content_div=null;this.settings={detail:HQ_TIMELINE_DISPLAY_TYPE.FULL,typeinfo:[]};this.data=[];this.mapTypeIdToTarget={};this.timeFunctionPerSourceId={};this.lastUpdateTimeMSec=null}
HQEventletTimeline.prototype.eventletConfigure=function(hqEventletActivation){this.sources=hqEventletActivation.sources;this.composition=hqEventletActivation.composition;this.parameters=hqEventletActivation.parameters;var i;for(i=0;i<this.sources.length;i++){var source=this.sources[i];if(source.manifest!=null)this.processManifest(source.manifest)}if(this.composition!=null){var detailEnum=HQEnumUtil.findEnumValue(HQ_TIMELINE_DISPLAY_TYPE,"detail",this.composition.detail);if(detailEnum!=null)this.settings.detail=
detailEnum;if(this.composition.timelineSeries!=null&&this.composition.timelineSeries.pointsources!=null)for(i=0;i<this.composition.timelineSeries.pointsources.length;i++){var ps=this.composition.timelineSeries.pointsources[i];if(HQEventletUtil.isArrivalTimeBuiltin(ps.x))continue;this.timeFunctionPerSourceId[ps.sourceId]=new PointSourceFunction(ps.x)}}};
HQEventletTimeline.prototype.eventletInitialize=function(hqEventletContext){this.containerEventTarget=hqEventletContext.containerEventTarget;hqEventletContext.containerEventTarget.addListener(HQ_EVENTTARGET_TYPE.CLEAR.name,function(){this.doMenuClear()}.bind(this));hqEventletContext.containerEventTarget.addListener(HQ_EVENTTARGET_TYPE.EVENTLETSETTINGS.name,function(){this.doMenuSettings()}.bind(this));this.content_div=hqEventletContext.rootDOM.find("#content__div");this.screenWidth=Math.max(HQ_TIMELINE_MIN_WIDTH,
HQ_TIMELINE_SCREENWIDTH_FACTOR*this.content_div.width());this.screenHeight=Math.max(HQ_TIMELINE_MIN_HEIGHT,this.content_div.height());if(this.parameters!=null&&this.parameters.height!=null){if(typeof this.parameters.height=="string")throw new TypeError("Height parameter must be an integer pixel value");this.screenHeight=this.parameters.height}console.log("HQEventletTimeline screen height "+this.screenHeight+" width "+this.screenWidth);this.applyColors(this.content_div);var axis_div=hqEventletContext.rootDOM.find("#axis__div");
var axisD3Div=axis_div.get(0);var margin={top:HQ_TIMELINE_MARGIN_TOP,right:HQ_TIMELINE_MARGIN_RIGHT,bottom:HQ_TIMELINE_MARGIN_BOTTOM,left:HQ_TIMELINE_MARGIN_LEFT},width=this.screenWidth,height=this.screenHeight;var now=new Date;this.axis_d3_scale=d3.time.scale().domain([now,HQDateUtil.subtractMilliseconds(now,60*1E3)]).rangeRound([0,width-margin.left-margin.right]);this.axis_d3_axis=d3.svg.axis().scale(this.axis_d3_scale).orient("bottom").ticks(d3.time.seconds,5).tickFormat(d3.time.format("%H:%M:%S")).tickSize(10).tickPadding(8);
this.axis_d3_svg=d3.select(axisD3Div).append("svg").attr("class","timeline_axis").attr("width",width).attr("height",height).append("g").attr("transform","translate("+margin.left+", "+margin.top+")");this.axis_d3_svg.append("g").attr("class","x axis").attr("transform","translate(0, "+(height-margin.top-margin.bottom)+")").call(this.axis_d3_axis);this.lastUpdateTimeMSec=(new Date).getTime();var myself=this;setInterval(myself.updateFromTimer.bind(this),1E3)};
HQEventletTimeline.prototype.doMenuClear=function(){d3.select(this.content_div.get(0)).selectAll("div.timeline_item").remove();this.data=[]};HQEventletTimeline.prototype.updateFromTimer=function(entries){var now=(new Date).getTime();var delta=now-this.lastUpdateTimeMSec;if(delta>500)this.eventletUpdate({entries:[]})};
HQEventletTimeline.prototype.eventletUpdate=function(update){var entries=update.entries;var now=new Date;this.lastUpdateTimeMSec=now.getTime();this.axis_d3_scale.domain([now,HQDateUtil.subtractMilliseconds(now,3*60*1E3)]);this.axis_d3_svg.selectAll("g.x.axis").call(this.axis_d3_axis);var scale=this.axis_d3_scale;d3.select(this.content_div.get(0)).selectAll("div.timeline_item").attr("style",function(d){return HQEventletTimeline.getPositionStyleForData(d,scale)});for(var u=0;u<entries.length;u++){var upd=
entries[u];var typeId=upd.typeId;var sourceId=upd.resourceIds[0];for(var e=0;e<upd.newRows.length;e++){var event=upd.newRows[e];var arrivalTime=now;if(this.timeFunctionPerSourceId[sourceId]!=null)arrivalTime=this.timeFunctionPerSourceId[sourceId].evaluateDateOrNumber(event,arrivalTime);this.processEvent(typeId,event,arrivalTime)}}};
HQEventletTimeline.prototype.processEvent=function(typeId,event,currentDate){var xpos=this.axis_d3_scale(currentDate)+HQ_TIMELINE_MARGIN_LEFT;var yposrel=this.computeYPositionConsiderHistory(xpos,this.data);var yposabs=this.getYAbsolute(yposrel);var typeEntry=this.mapTypeIdToTarget[typeId];var typeName=typeEntry==null?"Undefined":typeEntry.nameOfTarget;var typeProps=typeEntry==null?[]:typeEntry.propertiesMap;var row={date:currentDate,rowid:event.__rowid,y:yposabs,yrel:yposrel,typeName:typeName,typeProps:typeProps,
event:event};this.data.push(row);this.doD3Enter([row]);var child=this.content_div.children(":last-child");this.renderDOM(child,row)};
HQEventletTimeline.prototype.doD3Enter=function(dataToEnter){var entered=d3.select(this.content_div.get(0)).selectAll("div.timeline_item").data(dataToEnter,function(d){return d.rowid}).enter();var thedivs=entered.append("div");thedivs.attr("class","timeline_item");var theScale=this.axis_d3_scale;thedivs.attr("style",function(d){return HQEventletTimeline.getPositionStyleForData(d,theScale)});var myself=this;if(this.settings.detail==HQ_TIMELINE_DISPLAY_TYPE.FULL)thedivs.on("dblclick",function(event){myself.handleEventClick(event)});
else thedivs.on("mousedown",function(event){myself.handleEventClick(event)})};
HQEventletTimeline.prototype.handleEventClick=function(row){if(this.composition!=null&&HQStringUtil.isPopulated(this.composition.clickCallback)){HQEventletUtil.invokeClickCallback(this.composition.clickCallback,"event",row,this.containerEventTarget);return}var html="\x3cdiv ng-app\x3d'myModule'/\x3e";var $div=$(html);var url=HQUriUtil.addUUIDToUrl(HQUriUtil.getUrlViews(HQ_DIALOG.EVENTLET_TIMELINE_EVENTDETAIL.url));$div.load(url,function(response,status,xhr){if(!HQJqueryUtil.checkHandleLoadStatus(url,
response,status,xhr))return;angular.bootstrap($div,["myModule"]);var settings={modal:false,title:HQ_DIALOG.EVENTLET_TIMELINE_EVENTDETAIL.title,width:600,height:400};var dialog=$div.dialog(settings);var closeButtonCallback=function(){dialog.dialog("close")};var dialogObject={close:closeButtonCallback};angular.element($div.children(":first")).scope().doInitializeEventletTimelineEventDetail(row,dialogObject)})};
HQEventletTimeline.prototype.eventletExpire=function(expire){var rowIdOffset=expire.rowIdOffset;var removed=HQCollectionUtil.removeFromArrayWhereSmaller(this.data,"rowid",rowIdOffset);if(removed.length>0)d3.select(this.content_div.get(0)).select("div.timeline_item").data(removed,function(d){return d.rowid}).exit().remove()};HQEventletTimeline.prototype.eventletManifest=function(manifest){var entries=manifest.manifests;for(var i=0;i<entries.length;i++)this.processManifest(entries[i].manifest)};
HQEventletTimeline.prototype.doMenuSettings=function(){var html="\x3cdiv ng-app\x3d'myModule'/\x3e";var $div=$(html);var applyEventTarget=new EventTarget;applyEventTarget.addListener(HQ_EVENTTARGET_TYPE.APPLY_TIMELINE.name,this.handleSettingsUpdate.bind(this));var myself=this;var url=HQUriUtil.addUUIDToUrl(HQUriUtil.getUrlViews(HQ_DIALOG.EVENTLET_TIMELINE_SETTINGS.url));$div.load(url,function(response,status,xhr){if(!HQJqueryUtil.checkHandleLoadStatus(url,response,status,xhr))return;angular.bootstrap($div,
["myModule"]);var settings={modal:true,title:HQ_DIALOG.EVENTLET_TIMELINE_SETTINGS.title,width:600,height:400};var dialog=$div.dialog(settings);var config={typeinfo:myself.settings.typeinfo,detail:myself.settings.detail};var closeButtonCallback=function(){dialog.dialog("close")};var dialogObject={close:closeButtonCallback};angular.element($div.children(":first")).scope().doInitializeEventletTimelineSettings($div,config,dialogObject,applyEventTarget)})};
HQEventletTimeline.prototype.handleSettingsUpdate=function(event){var detail=event.data.detail;if(detail!=this.settings.detail.detail){this.settings.detail=HQEnumUtil.findEnumValue(HQ_TIMELINE_DISPLAY_TYPE,"detail",detail);this.updateRendering()}this.settings.typeinfo=event.data.typeinfo;this.applyColors(this.content_div)};
HQEventletTimeline.prototype.applyColors=function(rootDOM){for(var i=0;i<this.settings.typeinfo.length;i++){var item=this.settings.typeinfo[i];var cssName=".TIMELINE_ITEM_TYPECLASS__"+item.name;rootDOM.find(cssName).each(function(k,v){$(v).css("background-color",item.color)})}};
HQEventletTimeline.prototype.updateRendering=function(event){d3.select(this.content_div.get(0)).selectAll(".timeline_item").remove();var updatedData=[];var i,row;for(i=0;i<this.data.length;i++){row=this.data[i];var x=this.axis_d3_scale(row.date)+HQ_TIMELINE_MARGIN_LEFT;row.yrel=this.computeYPositionConsiderHistory(x,updatedData);row.y=this.getYAbsolute(row.yrel);updatedData.push(row)}this.data=updatedData;this.doD3Enter(this.data);var children=this.content_div.children();for(i=0;i<children.length;i++){var child=
children.get(i);row=child["__data__"];this.renderDOM($(child),row)}};HQEventletTimeline.prototype.renderDOM=function(child,data){if(this.settings.detail==HQ_TIMELINE_DISPLAY_TYPE.TINY)this.renderDOMTiny(child,data);else if(this.settings.detail==HQ_TIMELINE_DISPLAY_TYPE.SMALL)this.renderDOMSmall(child,data);else this.renderDOMFull(child,data);this.applyColors($(child))};
HQEventletTimeline.prototype.renderDOMTiny=function(child,data){var html='\x3cdiv class\x3d"timeline_item_tiny THETYPECLASS"\x3eTHEROWID\x3c/div\x3e';html=this.replaceHTMLTemplate(html,data);child.html(html)};
HQEventletTimeline.prototype.renderDOMSmall=function(child,data){var html='\x3cdiv class\x3d"timeline_item_small"\x3e                        \x3cdiv style\x3d"position:relative;" class\x3d"THETYPECLASS"\x3eTHEROWID\x3c/div\x3e                        \x3cdiv style\x3d"position:relative;"\x3eTHETYPENAME\x3c/div\x3e                        \x3c/div\x3e';html=this.replaceHTMLTemplate(html,data);child.html(html)};
HQEventletTimeline.prototype.renderDOMFull=function(child,data){var html='\x3cdiv class\x3d"timeline_item_full"\x3e                        \x3cdiv class\x3d"timeline_item_full_type THETYPECLASS"\x3eTHETYPENAME\x3c/div\x3e                        \x3cdiv class\x3d"timeline_item_full_rowid THETYPECLASS"\x3eTHEROWID\x3c/div\x3e                        \x3cdiv class\x3d"clear"\x3e\x3c/div\x3e                        \x3cdiv class\x3d"timeline_item_full_table"\x3e                        \x3ctable class\x3d"timeline_item_full_table_b"\x3e                        \x3ctbody\x3e                        \x3c/tbody\x3e                        \x3c/table\x3e                        \x3c/div\x3e                        \x3c/div\x3e';html=
this.replaceHTMLTemplate(html,data);child.html(html);var tableBody=$("tbody:first-child()",child);for(var key in data.typeProps)if(data.event.hasOwnProperty(key)){var value=data.event[key];tableBody.append("\x3ctr\x3e"+"\x3ctd\x3e"+key+"\x3c/td\x3e"+"\x3ctd\x3e"+HQPushUtil.renderPropertyValueNoMetadata(value)+"\x3c/td\x3e"+"\x3c/tr\x3e")}};
HQEventletTimeline.prototype.replaceHTMLTemplate=function(html,row){html=HQStringUtil.replaceAll("THEROWID",row.rowid,html);html=HQStringUtil.replaceAll("THETYPENAME",row.typeName,html);html=HQStringUtil.replaceAll("THETYPECLASS","TIMELINE_ITEM_TYPECLASS__"+row.typeName,html);return html};HQEventletTimeline.getPositionStyleForData=function(d,scale){return"position: absolute; left: "+(scale(d.date)+HQ_TIMELINE_MARGIN_LEFT)+"px; top: "+d.y+"px;"};
HQEventletTimeline.prototype.getYAbsolute=function(yrel){var ymax=this.getYRelMax();var y=ymax-yrel-this.settings.detail.height;if(y<0)y=0;if(y>ymax)y=ymax-this.settings.detail.height;return y};HQEventletTimeline.prototype.getYRelMax=function(){return this.screenHeight-HQ_TIMELINE_MARGIN_BOTTOM-HQ_TIMELINE_MARGIN_VERTICAL_SCALE};
HQEventletTimeline.prototype.computeYPositionConsiderHistory=function(my_x,history){if(history.length==0)return 0;var myHeight=this.settings.detail.height;var myWidth=this.settings.detail.width;if(!this.hasCollisionAny(my_x,0,myWidth,myHeight,history))return 0;var lastY=history[history.length-1].yrel;lastY+=myHeight+10;if(lastY>this.getYRelMax())return 0;return lastY};
HQEventletTimeline.prototype.hasCollisionAny=function(my_x,my_y,width,height,history){for(var i=history.length-1;i>=0;i--){var row=history[i];var x=this.axis_d3_scale(row.date)+HQ_TIMELINE_MARGIN_LEFT;var y=row.yrel;if(my_x+width<x)return false;var a={x:my_x,y:my_y,width:width,height:height};var b={x:x,y:y,width:width,height:height};if(HQCollisionUtil.detectCollision(a,b))return true}return false};
HQEventletTimeline.prototype.processManifest=function(manifest){var entry=new HQEventletTargetEntry(manifest);this.mapTypeIdToTarget[manifest.typeId]=entry;var typeinfo={typeId:manifest.typeId,name:entry.nameOfTarget,color:"#d8d8d8"};HQCollectionUtil.addArrayElementNoDuplicates(this.settings.typeinfo,"typeId",manifest.typeId,typeinfo)};function EventletTimelineEventDetailController($scope){$scope.dialog=null;$scope.data=null;$scope.properties=[];$scope.doInitializeEventletTimelineEventDetail=function(data,dialog){$scope.data=data;$scope.dialog=dialog;for(var key in data.typeProps){if(!data.typeProps.hasOwnProperty(key))continue;var tp=data.typeProps[key];var name=tp.propertyName;var value=HQPushUtil.renderPropertyValueNoMetadata(data.event[name]);$scope.properties.push({name:name,value:value})}$scope.$apply()};$scope.doClose=function(){$scope.dialog.close()}}
;function EventletTimelineSettingsController($scope){$scope.dialog=null;$scope.applyEventTarget=null;$scope.settings={};$scope.colorpickers=[];$scope.detailChoices=[HQ_TIMELINE_DISPLAY_TYPE.TINY,HQ_TIMELINE_DISPLAY_TYPE.SMALL,HQ_TIMELINE_DISPLAY_TYPE.FULL];$scope.doInitializeEventletTimelineSettings=function(rootDOM,config,dialog,applyEventTarget){$scope.applyEventTarget=applyEventTarget;$scope.settings=config;$scope.dialog=dialog;$scope.$apply();var pickers=rootDOM.find(".timeline_colorpicker");for(var i=
0;i<pickers.length;i++){var item=pickers.get(i);var colorpicker=$(item).colorpicker();$scope.colorpickers.push(colorpicker)}};$scope.doCancel=function(){$scope.dialog.close()};$scope.doApply=function(){for(var i=0;i<$scope.colorpickers.length;i++){var picker=$scope.colorpickers[i];$scope.settings.typeinfo[i].color=picker.colorpicker("val")}var data={typeinfo:$scope.settings.typeinfo,detail:$scope.settings.detail.detail};$scope.applyEventTarget.fire({type:HQ_EVENTTARGET_TYPE.APPLY_TIMELINE.name,data:data})};
$scope.doOk=function(){$scope.doApply();$scope.dialog.close()};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("eventletmenu-timeline-settings")}};function EventletAboutController($scope,dialogService){$scope.clientId=dialogService.getConsumerMgmtService().getClientId();if($scope.clientId==null)$scope.clientId="unallocated";$scope.activation=null;$scope.traceText=null;$scope.stats=null;$scope.traceTextarea=null;$scope.doInitializeEventletAbout=function(config,shimEventTarget,rootDOM){$scope.activation=config.activation;$scope.stats=config.stats;$scope.traceText=config.traceText;$scope.traceTextarea=HQJqueryUtil.findElementById(rootDOM,"eventletabout_trace").get(0);
$scope.$apply();shimEventTarget.addListener(HQ_EVENTTARGET_TYPE.MESSAGES.name,function(event){$scope.traceText=$scope.traceText+"\n"+event.text;$scope.traceTextarea.scrollTop=$scope.traceTextarea.scrollHeight;$scope.$apply()});shimEventTarget.addListener(HQ_EVENTTARGET_TYPE.STATS.name,function(event){$scope.stats=event.stats;$scope.$apply()})};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("eventletmenu-about")}};function EventletController($scope,restService){$scope.activation=null;$scope.consumerWrapper=null;$scope.eventletShim=null;$scope.suspendedDiscard=false;$scope.suspendedBuffer=false;$scope.enableMenuEventletSettings=false;$scope.doInitialize=function(dialog){$scope.activation=dialog.config.activation;$scope.consumerWrapper=dialog.config.consumerWrapper;$scope.eventletShim=dialog.config.eventletShim;if($scope.activation!=null&&$scope.activation.composition!=null&&$scope.activation.composition.timeline!=
null)$scope.enableMenuEventletSettings=true;var context=new HQEventletContext($scope.eventletShim.getContainerEventTarget(),dialog.root);$scope.eventletShim.eventletInitialize(context);dialog.dialogClosedTarget.addListener(HQ_EVENTTARGET_TYPE.DIALOG_CLOSED.name,function(){$scope.eventletShim.getContainerEventTarget().fireEventletClosed()});dialog.dialogClosedTarget.addListener(HQ_EVENTTARGET_TYPE.DIALOG_CLOSED.name,$scope.doCloseCallback);$scope.consumerWrapper.addActivation($scope.activation.activationId,
$scope.eventletShim,$scope.activation);var cbUpdated=function(response){console.log("Updated to activated")};restService.updateActivation($scope.activation.clientId,$scope.activation.activationId,{state:"ACTIVE"},cbUpdated)};$scope.doCloseCallback=function(){$scope.consumerWrapper.removeActivation($scope.activation.activationId);var cbUpdated=function(response){console.log("Updated to completed")};restService.updateActivation($scope.activation.clientId,$scope.activation.activationId,{state:"COMPLETE"},
cbUpdated)};$scope.doMenuClear=function(){$scope.eventletShim.getContainerEventTarget().fireClear()};$scope.doMenuResume=function(){$scope.suspendedDiscard=false;$scope.suspendedBuffer=false;$scope.eventletShim.getContainerEventTarget().fireResume()};$scope.doMenuSuspendDiscard=function(){$scope.suspendedDiscard=true;$scope.eventletShim.getContainerEventTarget().fireSuspendDiscard()};$scope.doMenuSuspendBuffer=function(){$scope.suspendedBuffer=true;$scope.eventletShim.getContainerEventTarget().fireSuspendBuffer()};
$scope.doMenuAbout=function(){$scope.eventletShim.getContainerEventTarget().fireAbout()};$scope.doMenuHelp=function(){HQHelpDialogHelper.openHelp("eventletmenu")};$scope.doMenuRetainSettings=function(){$scope.eventletShim.getContainerEventTarget().fireRetainSettings()};$scope.doMenuEventletSettings=function(){$scope.eventletShim.getContainerEventTarget().fireEventletSettings()}};(function($){$.fn.eventlet=function(options){var $el=$(this);var wrapper;if(options=="destroy"){wrapper=$el.data("HQEventlet");wrapper.destroy();this.empty()}else{wrapper=new HQJQueryEventletWrap(this,options);$el.data("HQEventlet",wrapper);wrapper.turn()}return this};$.eventletLoad=function(options){if(window.esperjsshared===undefined)window.esperjsshared={consumerMgmtService:new ConsumerMgmtService,onbeforeunloadEventTarget:new BrowserClosedEventTarget};var cbCompleted=function(){if(options!=null&&
options.success!=null)options.success()};window.esperjsshared.consumerMgmtService.allocateOrGetClientIdAjax(cbCompleted)};$.eventletUnload=function(){var consumerMgmtService=window.esperjsshared.consumerMgmtService;if(consumerMgmtService===undefined)return;var clientId=consumerMgmtService.getClientId();if(clientId!=null){var url=HQUriUtil.getUrlHQServices("client/"+clientId);$.ajax({type:"delete",url:url,cache:false,complete:function(response){console.log("Client deleted")}});HQWindowUtil.spinLoopSleep(200)}}})(jQuery);
HQJQueryEventletWrap=function(root,options){this.root=root;this.options=options;this.dialogClosedTarget=null;this.activationName=null;this.activationXML=null};
HQJQueryEventletWrap.prototype.turn=function(){if(window.esperjsshared===undefined){alert("Load not completed yet, please invoke 'eventletLoad' first");return}if(this.options==null){alert("Initialization object not provided");return}var myself=this;if(this.options.hasOwnProperty(HQ_LAUNCHPARAMTYPE.EVENTLETFILENAME)){if(!HQStringUtil.isPopulatedStringType(this.options[HQ_LAUNCHPARAMTYPE.EVENTLETFILENAME])){alert("Initialization object property '"+HQ_LAUNCHPARAMTYPE.EVENTLETFILENAME+"' is an empty value or not a string value");
return}var filename=this.options[HQ_LAUNCHPARAMTYPE.EVENTLETFILENAME];var url=HQUriUtil.getUrlHQServices("vfs/file/"+filename);$.ajax({type:"get",url:url,cache:false,complete:function(response){if(response.status==200){var file=$.parseJSON(response.responseText);if(!HQStringUtil.isPopulatedStringType(file.body)){alert("File '"+filename+"' is an empty file");return}myself.activationXML=file.body;myself.activationName=file.name;myself.doCreateEventletActivation()}else{var msg=JSON.parse(response.responseText);
alert(msg.message);console.log("Failed to activate: "+response.responseText)}}})}else if(this.options.hasOwnProperty(HQ_LAUNCHPARAMTYPE.EVENTLETXML)){if(!HQStringUtil.isPopulatedStringType(this.options[HQ_LAUNCHPARAMTYPE.EVENTLETXML])){alert("Initialization object property '"+HQ_LAUNCHPARAMTYPE.EVENTLETXML+"' is an empty value or not a string value");return}this.activationXML=HQStringUtil.decodeHTML(this.options[HQ_LAUNCHPARAMTYPE.EVENTLETXML]);this.activationName="Eventlet";this.doCreateEventletActivation()}else if(this.options.hasOwnProperty(HQ_LAUNCHPARAMTYPE.EVENTLETURL)){if(!HQStringUtil.isPopulatedStringType(this.options[HQ_LAUNCHPARAMTYPE.EVENTLETURL])){alert("Initialization object property '"+
HQ_LAUNCHPARAMTYPE.EVENTLETURL+"' is an empty value or not a string value");return}var eventletReadUrl=this.options[HQ_LAUNCHPARAMTYPE.EVENTLETURL];$.ajax({type:"GET",url:eventletReadUrl,dataType:"xml",complete:function(response){if(response.status==200){myself.activationXML=response.responseText;myself.activationName=eventletReadUrl;myself.doCreateEventletActivation()}else alert("Failed to load url '"+eventletReadUrl+"', status "+response.status)}})}else alert("Missing initialization object property, required is any of the following properties: "+
HQ_LAUNCHPARAMTYPE.EVENTLETFILENAME+" or "+HQ_LAUNCHPARAMTYPE.EVENTLETXML+" or "+HQ_LAUNCHPARAMTYPE.EVENTLETURL)};HQJQueryEventletWrap.prototype.destroy=function(){if(this.dialogClosedTarget!==undefined)this.dialogClosedTarget.fireDialogClosed()};
HQJQueryEventletWrap.prototype.doCreateEventletActivation=function(){var clientId=window.esperjsshared.consumerMgmtService.getClientId();var browserClosedCallback=function(){var url=HQUriUtil.getUrlHQServices("client/"+clientId);$.ajax({type:"delete",url:url,cache:false,complete:function(response){console.log("Client "+clientId+" indicated delete to server")}});HQWindowUtil.spinLoopSleep(200)};window.esperjsshared.onbeforeunloadEventTarget.addListener(HQ_EVENTTARGET_TYPE.BROWSER_CLOSED.name,browserClosedCallback);
var activation={clientId:clientId,activationName:this.activationName,activationXML:this.activationXML};var url=HQUriUtil.getUrlHQServices("client/"+clientId+"/activation");var myself=this;$.ajax({type:"post",url:url,data:JSON.stringify(activation),dataType:"json",cache:false,contentType:"application/json; charset\x3dutf-8",complete:function(response){if(response.status==200)myself.doCreateEventlet($.parseJSON(response.responseText));else{var msg=JSON.parse(response.responseText);alert(msg.message);
console.log("Failed to activate: "+response.responseText)}}})};
HQJQueryEventletWrap.prototype.doCreateEventlet=function(activation){var myself=this;var websocketAndActivationCallback=function(eventletWrapper){var module=angular.module("myModule",[]);AngularInit.init(module);myself.root.empty();var html="\x3cdiv ng-app\x3d'myModule'/\x3e";var $div=$(html);var url=HQUriUtil.addUUIDToUrl(HQUriUtil.getUrlViews(eventletWrapper.eventletUrl));$div.load(url,function(response,status,xhr){if(!HQJqueryUtil.checkHandleLoadStatus(url,response,status,xhr))return;var child=
$div.get(0);var activation=eventletWrapper.activation;if(activation!=null&&activation.eventletSettings!=null&&activation.eventletSettings.menu==false){var menu=$(child).find("div[hqeventletmenu\x3d'yes']:first");menu.removeAttr("hqeventletmenu")}angular.bootstrap(child,["myModule"]);if(myself.root.length==0){console.log("No root provided");return}myself.root.get(0).appendChild($div.get(0));myself.dialogClosedTarget=new DialogClosedEventTarget;var dialogObject={root:myself.root,config:eventletWrapper,
dialogClosedTarget:myself.dialogClosedTarget};var scope=angular.element($div.children(":first")).scope();scope.doInitialize(dialogObject)})};HQPushUtil.activateEventlet(activation,window.esperjsshared.consumerMgmtService,this.options,websocketAndActivationCallback)};function EventletSettingsController($scope){$scope.dialog=null;$scope.applyEventTarget=null;$scope.retain={};$scope.unitChoices=[HQ_RETAIN_TYPE.SECONDS,HQ_RETAIN_TYPE.MINUTES,HQ_RETAIN_TYPE.HOURS,HQ_RETAIN_TYPE.EVENTS];$scope.retainCountValid=true;$scope.doInitializeEventletSettings=function(config,dialog,applyEventTarget){$scope.applyEventTarget=applyEventTarget;$scope.retain=config;if($scope.retain.retainEnum==null)$scope.retain.retainEnum=HQ_RETAIN_TYPE.SECONDS;$scope.dialog=dialog;$scope.$apply()};
$scope.doApply=function(){if(!validate())return;$scope.applyEventTarget.fire({type:HQ_EVENTTARGET_TYPE.APPLY_RETAIN.name,data:$scope.retain})};$scope.doOk=function(){if(!validate())return;$scope.applyEventTarget.fire({type:HQ_EVENTTARGET_TYPE.APPLY_RETAIN.name,data:$scope.retain});$scope.dialog.close()};$scope.doChangeRetainAll=function(){if($scope.retain.retainAll){$scope.retain.retainCount=null;$scope.retain.retainUnit=null}};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("eventletmenu-settings")};
var validate=function(){$scope.retainCountValid=true;if($scope.retain.retainAll)return true;$scope.retainCountValid=HQValidationUtil.validateIntGreaterZero($scope.retain.retainCount);return $scope.retainCountValid}};function EventletShim(eventlet,eventletSettings){this.eventlet=eventlet;this.rowId=0;this.activation=null;this.containerEventTarget=new EventletContainerEventTarget;this.firstMessageEver=true;HQObjectUtil.isFunction("eventletConfigure","eventlet",this.eventlet.eventletConfigure,this.eventlet);HQObjectUtil.isFunction("eventletInitialize","eventlet",this.eventlet.eventletInitialize,this.eventlet);HQObjectUtil.isFunction("eventletUpdate","eventlet",this.eventlet.eventletUpdate,this.eventlet);HQObjectUtil.isFunction("eventletManifest",
"eventlet",this.eventlet.eventletManifest,this.eventlet);HQObjectUtil.isFunction("eventletExpire","eventlet",this.eventlet.eventletExpire,this.eventlet);this.shimEventTarget=new EventTarget;this.traceLogEntries=new LogEntryColl(100);var myself=this;var traceHandler=function(event){myself.traceLogEntries.addEntry(event.text);myself.shimEventTarget.fire({type:HQ_EVENTTARGET_TYPE.MESSAGES.name,text:HQStringUtil.formatDateAndText(new Date,event.text)})};this.containerEventTarget.addListener(HQ_EVENTTARGET_TYPE.TRACE.name,
traceHandler);this.containerEventTarget.addListener(HQ_EVENTTARGET_TYPE.ERROR.name,traceHandler);this.containerEventTarget.addListener(HQ_EVENTTARGET_TYPE.SUSPEND_DISCARD.name,this.doSuspendDiscard.bind(this));this.containerEventTarget.addListener(HQ_EVENTTARGET_TYPE.SUSPEND_BUFFER.name,this.doSuspendBuffer.bind(this));this.containerEventTarget.addListener(HQ_EVENTTARGET_TYPE.RESUME.name,this.doResume.bind(this));this.containerEventTarget.addListener(HQ_EVENTTARGET_TYPE.ABOUT.name,this.doAbout.bind(this));
this.containerEventTarget.addListener(HQ_EVENTTARGET_TYPE.RETAINSETTINGS.name,this.doSettings.bind(this));this.mapResourceToSourceId={};this.hasTransformations=false;this.transformationPerResourceId={};this.retainAll=true;this.retainCount=null;this.retainEnum=null;this.retainExpireScheduleInterval=null;this.retainedRowIds=[];if(eventletSettings!=null){this.parseRetainSettings(eventletSettings);this.mayScheduleExpiry();this.traceLogEntries.addEntry("Retain settings: "+JSON.stringify(eventletSettings))}this.suspendedDiscarding=
false;this.suspendedBuffer=false;this.suspendBuffer=[];this.lastUpdate=null;this.numMessages=0;this.numRows=0}EventletShim.prototype.getContainerEventTarget=function(){return this.containerEventTarget};
EventletShim.prototype.doAbout=function(){var html="\x3cdiv ng-app\x3d'myModule'/\x3e";var $div=$(html);var myself=this;var url=HQUriUtil.addUUIDToUrl(HQUriUtil.getUrlViews(HQ_DIALOG.EVENTLET_ABOUT.url));$div.load(url,function(response,status,xhr){if(!HQJqueryUtil.checkHandleLoadStatus(url,response,status,xhr))return;angular.bootstrap($div,["myModule"]);var width=HQ_DIALOGDIMENSION_ENUM.POPUP.width;var height=HQ_DIALOGDIMENSION_ENUM.POPUP.height;var settings={modal:false,title:HQ_DIALOG.EVENTLET_ABOUT.title,
width:width,height:height};$div.dialog(settings);var config={activation:myself.activation,stats:myself.getStats(),traceText:myself.traceLogEntries.toString()};angular.element($div.children(":first")).scope().doInitializeEventletAbout(config,myself.shimEventTarget,$div)})};
EventletShim.prototype.doSettings=function(){var html="\x3cdiv ng-app\x3d'myModule'/\x3e";var $div=$(html);var applyRetainEventTarget=new EventTarget;applyRetainEventTarget.addListener(HQ_EVENTTARGET_TYPE.APPLY_RETAIN.name,this.doHandleRetain.bind(this));var myself=this;var url=HQUriUtil.addUUIDToUrl(HQUriUtil.getUrlViews(HQ_DIALOG.EVENTLET_RETAIN_SETTINGS.url));$div.load(url,function(response,status,xhr){if(!HQJqueryUtil.checkHandleLoadStatus(url,response,status,xhr))return;angular.bootstrap($div,
["myModule"]);var width=HQ_DIALOGDIMENSION_ENUM.POPUP_NARROW.width;var height=HQ_DIALOGDIMENSION_ENUM.POPUP_NARROW.height;var settings={modal:true,title:HQ_DIALOG.EVENTLET_RETAIN_SETTINGS.title,width:width,height:height};var dialog=$div.dialog(settings);var config={retainAll:myself.retainAll,retainCount:myself.retainCount,retainEnum:myself.retainEnum};var closeButtonCallback=function(){dialog.dialog("close")};var dialogObject={close:closeButtonCallback};angular.element($div.children(":first")).scope().doInitializeEventletSettings(config,
dialogObject,applyRetainEventTarget)})};EventletShim.prototype.doHandleRetain=function(event){this.retainAll=event.data.retainAll;this.retainCount=event.data.retainCount;this.retainEnum=event.data.retainEnum;this.mayScheduleExpiry()};EventletShim.prototype.getStats=function(){return{lastUpdate:this.lastUpdate,numMessages:this.numMessages,numRows:this.numRows}};
EventletShim.prototype.doSuspendDiscard=function(){this.traceLogEntries.addEntry("Suspend-Discard is now active");this.suspendedDiscarding=true};EventletShim.prototype.doSuspendBuffer=function(){this.traceLogEntries.addEntry("Suspend-Buffer is now active");this.suspendedBuffer=true};
EventletShim.prototype.doResume=function(){this.traceLogEntries.addEntry("Suspend-Discard/Buffer released");this.suspendedDiscarding=false;this.suspendedBuffer=false;for(var i=0;i<this.suspendBuffer.length;i++)this.processMessages(this.suspendBuffer[i]);this.suspendBuffer.length=0};
EventletShim.prototype.eventletConfigure=function(hqEventletActivation){this.traceLogEntries.addEntry("Eventlet configuration");this.activation=hqEventletActivation;this.initialize(hqEventletActivation.sources);try{this.eventlet.eventletConfigure(hqEventletActivation)}catch(e){console.log(e.stack);this.traceLogEntries.addEntry("Eventlet configuration exception: "+e.toString())}this.traceLogEntries.addEntry("Eventlet configuration completed")};
EventletShim.prototype.eventletInitialize=function(hqEventletContext){this.traceLogEntries.addEntry("Eventlet initialization");try{this.eventlet.eventletInitialize(hqEventletContext)}catch(e){console.log(e.stack);this.traceLogEntries.addEntry("Eventlet initialization exception: "+e.toString())}this.traceLogEntries.addEntry("Eventlet initialization completed")};
EventletShim.prototype.update=function(messages){if(this.firstMessageEver){this.traceLogEntries.addEntry("Receiving event data");this.firstMessageEver=false}if(this.suspendedDiscarding)return;if(this.suspendedBuffer){this.suspendBuffer.push(messages);return}this.lastUpdate=new Date;this.numMessages++;try{this.processMessages(messages)}catch(e){console.log(e.stack);this.traceLogEntries.addEntry("Eventlet update exception: "+e.toString())}this.shimEventTarget.fire({type:HQ_EVENTTARGET_TYPE.STATS.name,
stats:this.getStats()})};
EventletShim.prototype.processMessages=function(messages){var arrivalTime;for(var i=0;i<messages.length;i++){var message=messages[i];arrivalTime=message.arrivalTime;var resourceIds=message.resourceIds;var newEvents=message.newRows;if(newEvents!=null)for(var j=0;j<newEvents.length;j++){newEvents[j].__rowid=this.rowId;this.rowId++}if(this.hasTransformations)for(var r=0;r<resourceIds.length;r++){var resourceId=resourceIds[r];var transformation=this.transformationPerResourceId[resourceId];if(transformation==
null)continue;message.newRows=this.doTransformation(transformation,newEvents)}if(message.newRows!=null)this.numRows+=message.newRows.length}this.eventlet.eventletUpdate(new HQEventletUpdate(messages));this.retainedRowIds.push({timeutc:(new Date).getTime(),offset:this.rowId});if(this.retainedRowIds.length>1E4)this.retainedRowIds.splice(0,1E3)};
EventletShim.prototype.doTransformation=function(transformation,newEvents){if(newEvents==null||newEvents.length==0)return[];var transformed=[],event;for(var i=0;i<newEvents.length;i++){var eventObject=newEvents[i];var entriesUnmapped=eventObject[transformation.property];if(entriesUnmapped==null){transformed.push(eventObject);continue}for(var entryKey in entriesUnmapped){if(!entriesUnmapped.hasOwnProperty(entryKey))continue;event=this.shallowCopy(eventObject,{});delete event[transformation.property];
var entryValue=entriesUnmapped[entryKey];event[transformation.key]=entryKey;event[transformation.value]=entryValue;event.__rowid=this.rowId;this.rowId++;transformed.push(event)}}return transformed};EventletShim.prototype.shallowCopy=function(event,target){var value;for(var key in event){if(!event.hasOwnProperty(key))continue;value=event[key];target[key]=value}return target};
EventletShim.prototype.manifest=function(messages){try{this.eventlet.eventletManifest(new HQEventletManifest(messages))}catch(e){console.log(e.stack);this.traceLogEntries.addEntry("Eventlet update exception: "+e.toString())}};
EventletShim.prototype.initialize=function(sources){for(var s=0;s<sources.length;s++){var source=sources[s];if(source.transformations==null||source.transformations.length==0||source.transformations[0].unmap==null)continue;this.hasTransformations=true;this.mapResourceToSourceId[source.resourceId]=source.sourceId;var unmap=source.transformations[0].unmap;this.transformationPerResourceId[source.resourceId]=unmap;if(source.manifest==null)continue;var properties=source.manifest.definition.properties;var unmappedPropIndex=
HQPushUtil.findProperty(properties,unmap.property);if(unmappedPropIndex!=-1)properties.splice(unmappedPropIndex,1);properties.push({propertyName:unmap.key,propertyType:unmap.keyType});properties.push({propertyName:unmap.value,propertyType:unmap.valueType})}};
EventletShim.prototype.doExpiry=function(){var currentTime=(new Date).getTime();if(this.retainAll)return;var i;var newestExpired=-1;if(this.retainEnum==HQ_RETAIN_TYPE.EVENTS){var oldestPossible=this.rowId-this.retainCount;for(i=0;i<this.retainedRowIds.length;i++)if(this.retainedRowIds[i].offset<=oldestPossible)newestExpired=i;else break}else{var expiryTimeMillis=this.computeExpiryTimeMillis();for(i=0;i<this.retainedRowIds.length;i++){var age=currentTime-this.retainedRowIds[i].timeutc;if(age<expiryTimeMillis)break;
newestExpired=i}}if(newestExpired!=-1){var expiredOffset=this.retainedRowIds[newestExpired].offset;this.retainedRowIds.splice(0,newestExpired+1);try{this.eventlet.eventletExpire(new HQEventletExpire(expiredOffset))}catch(e){console.log(e.stack);this.traceLogEntries.addEntry("Eventlet update exception: "+e.toString())}}if(this.retainExpireScheduleInterval!=null){var self=this;setTimeout(function(){self.doExpiry()},this.retainExpireScheduleInterval)}};
EventletShim.prototype.parseRetainSettings=function(settings){if(settings.retainCount==null){this.traceLogEntries.addEntry("No retain count provided");return}if(settings.retainUnit==null){this.traceLogEntries.addEntry("No retain unit provided");return}var retainNum=settings.retainCount;var retainUnit=settings.retainUnit.trim();this.retainEnum=HQEnumUtil.findEnumValue(HQ_RETAIN_TYPE,"unit",retainUnit.toLowerCase());if(this.retainEnum==null){this.traceLogEntries.addEntry("Error parsing retain settings '"+
retainSettings+"', unrecognized unit '"+retainUnit+"'");return}this.retainAll=false;this.retainCount=retainNum};EventletShim.prototype.mayScheduleExpiry=function(retainSettings){if(this.retainExpireScheduleInterval!=null)return;if(this.retainAll)return;this.retainExpireScheduleInterval=1E3;var self=this;setTimeout(function(){self.doExpiry()},this.retainExpireScheduleInterval)};
EventletShim.prototype.computeExpiryTimeMillis=function(){if(this.retainEnum==HQ_RETAIN_TYPE.SECONDS)return this.retainCount*1E3;if(this.retainEnum==HQ_RETAIN_TYPE.MINUTES)return this.retainCount*1E3*60;if(this.retainEnum==HQ_RETAIN_TYPE.HOURS)return this.retainCount*1E3*60*60;return 1E7};function HQEventletActivation(composition,activationName,activationXML,sources,parameters){this.composition=composition;this.activationName=activationName;this.activationXML=activationXML;this.sources=sources;this.parameters=parameters}function HQEventletContext(containerEventTarget,rootDOM){this.containerEventTarget=containerEventTarget;this.rootDOM=rootDOM}function HQEventletUpdate(entries){this.entries=entries}function HQEventletManifest(manifests){this.manifests=manifests}
function HQEventletExpire(rowIdOffset){this.rowIdOffset=rowIdOffset};HQEventletUtil=function(){};HQEventletUtil.invokeClickCallback=function(clickCallback,dataname,data,containerEventTarget){try{var obj=new window[clickCallback];HQObjectUtil.isFunction("handleClicked",obj.constructor,obj.handleClicked,obj);var indicated={};indicated[dataname]=data;obj.handleClicked(indicated)}catch(error){console.log(error.stack);containerEventTarget.fireError("Could not find clickCallback function '"+clickCallback+": "+error)}};
HQEventletUtil.isArrivalTimeBuiltin=function(pointsourceX){return pointsourceX!=null&&(pointsourceX.toUpperCase().trim()==HQ_BUILTIN_PROPERTIES_TYPE.EVENTARRIVALTIME.code||pointsourceX.toUpperCase().trim()==HQ_BUILTIN_PROPERTIES_TYPE.EVENTARRIVALTIMEUTC.code)};PointSourceFunction=function(propertyName){this._propertyName=propertyName};
PointSourceFunction.prototype.evaluateDateOrNumber=function(values,numDefault){var result=values[this._propertyName];if(result==null)return numDefault;if(typeof result=="Date")return result.getTime();return result};function ConsumerMgmtService(){this.consumerNumber=0;this.subtopics={};this.clientId=null;this.websocketURL=null}ConsumerMgmtService.prototype.getIncrementConsumerNum=function(){this.consumerNumber++;return this.consumerNumber};ConsumerMgmtService.prototype.getConsumerWrapper=function(subtopic){return this.subtopics[subtopic]};
ConsumerMgmtService.prototype.getClientId=function(){return this.clientId};ConsumerMgmtService.prototype.getWebsocketURL=function(){return this.websocketURL};ConsumerMgmtService.prototype.addConsumerWrapper=function(subtopic,consumer){console.log("Adding subtopic '"+subtopic+"' and consumer "+consumer.getConsumerId());this.subtopics[subtopic]=consumer};ConsumerMgmtService.prototype.getSubtopics=function(){return this.subtopics};
ConsumerMgmtService.prototype.makeGetCreateClientRequest=function(){var browserInfo=BrowserDetect.browser+"__"+BrowserDetect.version+"__"+BrowserDetect.OS;return{browser:browserInfo,clientId:this.clientId}};
ConsumerMgmtService.prototype.allocateOrGetClientIdAjax=function(cbCompleted){var cbDone=function(myself,response){myself.clientId=response.clientId;myself.websocketURL=response.websocketURL;cbCompleted(response.clientId)};var myself=this;$.ajax({async:false,type:"post",url:HQUriUtil.getUrlHQServices("client"),data:JSON.stringify(this.makeGetCreateClientRequest()),dataType:"json",cache:false,contentType:"application/json; charset\x3dutf-8",complete:function(response){cbDone(myself,$.parseJSON(response.responseText))}})};
ConsumerMgmtService.prototype.allocateOrGetClientId=function(restService,cbCompleted){var myself=this;var cbDone=function(response){myself.clientId=response.clientId;myself.websocketURL=response.websocketURL;cbCompleted(response.clientId)};restService.createAssertClient(this.makeGetCreateClientRequest(),cbDone)};
function ConsumerWrapper(clientId,websocketURL,consumerId,logEntries,readyCallback){this.clientId=clientId;this.websocketURL=websocketURL;this.consumerId=consumerId;this.logEntries=logEntries;this.eventlets={};this.activations={};this.consumer=new Consumer(clientId,websocketURL,logEntries);this.openReopenWebsocket(readyCallback)}
ConsumerWrapper.prototype.processEvent=function(messageEvent){var jsonData=messageEvent.data;var event=JSON.parse(jsonData);var entriesPerActivationId={};var eventlet;var manifests=event.manifests;if(manifests!=null){var i,j;for(i=0;i<manifests.length;i++){var manifestEntry=manifests[i];for(j=0;j<manifestEntry.activationIds.length;j++){var activationId=manifestEntry.activationIds[j];var existing=entriesPerActivationId[activationId];if(existing==null){existing=[];entriesPerActivationId[activationId]=
existing}existing.push(manifestEntry)}}for(activationId in entriesPerActivationId){if(!entriesPerActivationId.hasOwnProperty(activationId))continue;var arr=entriesPerActivationId[activationId];console.log("Dispatching to activation id "+activationId+" manifests "+arr.length);eventlet=this.eventlets[activationId];eventlet.manifest(arr)}entriesPerActivationId={}}for(i=0;i<event.entries.length;i++){var eventEntry=event.entries[i];for(j=0;j<eventEntry.activationIds.length;j++){activationId=eventEntry.activationIds[j];
existing=entriesPerActivationId[activationId];if(existing==null){existing=[];entriesPerActivationId[activationId]=existing}existing.push(eventEntry)}}for(activationId in entriesPerActivationId){if(!entriesPerActivationId.hasOwnProperty(activationId))continue;arr=entriesPerActivationId[activationId];eventlet=this.eventlets[activationId];if(eventlet==null){console.log("Warn: Dispatch function not found for activation id "+activationId);continue}eventlet.update(arr)}};
ConsumerWrapper.prototype.openReopenWebsocket=function(readyCallback){if(this.consumer.getWebSocket()==null){this.consumer.start(this.processEvent.bind(this),readyCallback);return}var state=this.consumer.getWebSocket().readyState;if(state==3)this.consumer.start(this.processEvent.bind(this),readyCallback);else readyCallback()};ConsumerWrapper.prototype.getConsumerId=function(){return this.consumerId};ConsumerWrapper.prototype.getConsumer=function(){return this.consumer};
ConsumerWrapper.prototype.addActivation=function(activationId,eventlet,activation){this.eventlets[activationId]=eventlet;this.activations[activationId]=activation;this.logEntries.addEntry("Added dispatches for activation id "+activationId+" '"+activation.activationName+"'")};
ConsumerWrapper.prototype.removeActivation=function(activationId){delete this.eventlets[activationId];var activation=this.activations[activationId];delete this.activations[activationId];this.logEntries.addEntry("Removed dispatches for activation id "+activationId+(typeof activation=="undefined"?"":" '"+activation.activationName+"'"))};ConsumerWrapper.prototype.getActivations=function(){return this.activations};
function Consumer(clientId,websocketURL,logEntries){this.clientId=clientId;this.websocketURL=websocketURL;this.logEntries=logEntries;this.ws=null;this.messageCallback=null;this.readyCallback=null;this.msgCount=0;this.firstMessage=true}
Consumer.prototype.start=function(messageHandler,readyCallback){this.messageCallback=messageHandler;this.readyCallback=readyCallback;console.log(HQDateUtil.printCurrentDate()+" Allocating web socket using url "+this.websocketURL);this.ws=new WebSocket(this.websocketURL);var myself=this;console.log(HQDateUtil.printCurrentDate()+" Assigning web socket callbacks");this.ws.onopen=function(){var msg="Received onopen for web socket for client id "+myself.clientId;myself.logEntries.addEntry(msg);console.log(HQDateUtil.printCurrentDate()+
" "+msg);myself.ws.send(JSON.stringify({clientId:myself.clientId}))};this.ws.onmessage=function(event){if(typeof event.data=="string"){var msg;if(event.data=="ok"){msg="Server indicates ok handshake for web socket for client id "+myself.clientId;console.log(HQDateUtil.printCurrentDate()+" "+msg);myself.logEntries.addEntry(msg);myself.readyCallback()}else if(event.data=="close"){msg="Server indicates closing web socket for client id "+myself.clientId;console.log(HQDateUtil.printCurrentDate()+" "+msg);
myself.logEntries.addEntry(msg)}else{if(myself.firstMessage){myself.firstMessage=false;msg="Server has sent the first payload message for client id "+myself.clientId;console.log(HQDateUtil.printCurrentDate()+" "+msg);myself.logEntries.addEntry(msg)}myself.msgCount++;myself.messageCallback(event)}}else{msg="Server provided unknown message '"+event.data+"' for client id "+myself.clientId;console.log(HQDateUtil.printCurrentDate()+" "+msg);myself.logEntries.addEntry(msg)}};this.ws.onerror=function(event){var msg=
"Received onerror reported by websocket: "+JSON.stringify(event);console.log(HQDateUtil.printCurrentDate()+" "+msg);myself.logEntries.addEntry(msg)};this.ws.onclose=function(){var msg="Received onclose web socket for client id "+myself.clientId;console.log(HQDateUtil.printCurrentDate()+" "+msg);myself.logEntries.addEntry(msg)}};Consumer.prototype.getWebSocket=function(){return this.ws};
Consumer.prototype.getLogEntries=function(){var formatted=[];for(var i=0;i<this.logEntries.entries.length;i++){var entry=this.logEntries.entries[i];formatted.push({date:HQDateUtil.printDate(entry.date),msg:entry.msg})}return formatted};Consumer.prototype.getMsgCount=function(){return this.msgCount};HQLauncher=function(){};
HQLauncher.launch=function(idOfContentDiv){var parameters=HQUriUtil.getURLParameterMap(HQ_LAUNCHPARAMTYPE);var configuration={};if(HQStringUtil.isPopulated(parameters[HQ_LAUNCHPARAMTYPE.EVENTLETXML]))configuration[HQ_LAUNCHPARAMTYPE.EVENTLETXML]=parameters[HQ_LAUNCHPARAMTYPE.EVENTLETXML];if(HQStringUtil.isPopulated(parameters[HQ_LAUNCHPARAMTYPE.EVENTLETFILENAME]))configuration[HQ_LAUNCHPARAMTYPE.EVENTLETFILENAME]=parameters[HQ_LAUNCHPARAMTYPE.EVENTLETFILENAME];if(HQStringUtil.isPopulated(parameters[HQ_LAUNCHPARAMTYPE.EVENTLETURL]))configuration[HQ_LAUNCHPARAMTYPE.EVENTLETURL]=parameters[HQ_LAUNCHPARAMTYPE.EVENTLETURL];
if(HQObjectUtil.countProperties(configuration).length==0){alert("Failed to find any of the required parameters '"+HQ_LAUNCHPARAMTYPE.EVENTLETXML+"' or '"+HQ_LAUNCHPARAMTYPE.EVENTLETURL+"' or '"+HQ_LAUNCHPARAMTYPE.EVENTLETFILENAME+"'"+" among the URL parameters");return}var setupCompleted=function(){$("#"+idOfContentDiv).eventlet(configuration)};$.eventletLoad({success:setupCompleted})};