function DataflowBrowseController($scope,dialogService,restService){$scope.endpointName=null;$scope.engineURI=null;$scope.dataflowTable=null;$scope.dataflows=null;$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.dataflows=dialog.config.dataflows;var tableConfig={"bAutoWidth":false,"aoColumns":[{"sWidth":"20%"},{"sWidth":"80%"}]};$scope.dataflowTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"dataflows_div").dataTable(HQTableUtil.getDefaultFullDatatableConfig(tableConfig));
$scope.dataflowTable.delegate("tr","click",function(){var rownum=$scope.dataflowTable.fnGetPosition(this);if(rownum!=null){var selected=$scope.dataflows.dataflows[rownum];var dialogConfig={endpointName:$scope.endpointName,engineURI:$scope.engineURI,dataflowName:selected.dataflowName};dialogService.getOpenDialogCallback()(HQ_DIALOG.DATAFLOWDETAIL,dialogConfig)}});applyTable($scope.dataflowTable,$scope.dataflows.dataflows)};$scope.doRefresh=function(dialog){var cbFetched=function(response){$scope.dataflows=
response;applyTable($scope.dataflowTable,$scope.dataflows.dataflows)};restService.fetchDataflows($scope.endpointName,$scope.engineURI,cbFetched)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-dataflow")};var applyTable=function(table,dataflows){var myarr=[];for(var i=0;i<dataflows.length;i++){var row=dataflows[i];myarr.push([row.dataflowName,HQStringUtil.surroundByPreTag(row.epl)])}table.fnClearTable();table.fnAddData(myarr)}};function DataflowDetailController($scope,dialogService,restService){$scope.valueTypeItems=[HQ_PARAMETER_TYPES.STRING,HQ_PARAMETER_TYPES.INTEGER,HQ_PARAMETER_TYPES.DOUBLE];$scope.endpointName=null;$scope.engineURI=null;$scope.dataflow=null;$scope.instanceName=null;$scope.close=null;$scope.parameterItems=[];$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.dataflow=dialog.config.dataflow;$scope.close=dialog.close;$scope.doParametersAddItem();
var editorTextarea=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"dataflow_editor_div")[0];$scope.editor=CodeMirror.fromTextArea(editorTextarea,HQCodeMirrorUtil.getDefaultReadOnlyConfig());$scope.editor.setValue($scope.dataflow.epl+"\n\n");$scope.$apply()};$scope.doInstantiate=function(){var cbInstantiated=function(){dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:"The dataflow has been instantiated"});$scope.close()};var config={dataflowName:$scope.dataflow.dataflowName,
dataflowInstanceName:$scope.instanceName,parameters:compileParameters($scope.parameterItems)};restService.createDataflowInstance($scope.endpointName,$scope.engineURI,config,cbInstantiated)};$scope.doDestroy=function(){var updates={state:"DESTROYED"};var cbUpdated=function(){var message="The statement by name '"+$scope.dataflow.statementName+"' has been transitioned to DESTROYED";dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:message});$scope.close()};restService.updateStatement($scope.endpointName,
$scope.engineURI,$scope.dataflow.statementName,updates,cbUpdated)};$scope.doParametersAddItem=function(){$scope.parameterItems.push(makeDefaultParameter())};$scope.doParametersRemoveItem=function(index){$scope.parameterItems.splice(index,1)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-dataflowdetail")};var makeDefaultParameter=function(){return{uri:"",value:"",valueTypeObj:HQ_PARAMETER_TYPES.STRING,isNull:false}};var compileParameters=function(parameters){for(var i=0;i<parameters.length;i++)parameters[i].valueType=
parameters[i].valueTypeObj.name;return parameters}};function DataflowInstanceBrowseController($scope,dialogService,restService){$scope.endpointName=null;$scope.engineURI=null;$scope.instanceTable=null;$scope.instances=null;$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.instances=dialog.config.instances;$scope.instanceTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"dataflowinstances_div").dataTable(HQTableUtil.getDefaultFullDatatableConfig({}));$scope.instanceTable.delegate("tr",
"click",function(){var rownum=$scope.instanceTable.fnGetPosition(this);if(rownum!=null){var selected=$scope.instances.instances[rownum];var dialogConfig={endpointName:$scope.endpointName,engineURI:$scope.engineURI,dataflowInstanceName:selected.dataflowInstanceName};dialogService.getOpenDialogCallback()(HQ_DIALOG.DATAFLOWINSTANCEDETAIL,dialogConfig)}});applyTable($scope.instanceTable,$scope.instances.instances)};$scope.doRefresh=function(dialog){var cbFetched=function(response){$scope.instances=response;
applyTable($scope.instanceTable,$scope.instances.instances)};restService.fetchDataflowInstances($scope.endpointName,$scope.engineURI,cbFetched)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-dataflowinstance")};var applyTable=function(table,instances){var myarr=[];for(var i=0;i<instances.length;i++){var row=instances[i];myarr.push([row["dataflowInstanceName"],HQStringUtil.emptyString(row["dataflowInstanceId"]),row["dataflowName"],row["state"]])}table.fnClearTable();table.fnAddData(myarr)}}
;function DataflowInstanceDetailController($scope,dialogService,restService){$scope.endpointName=null;$scope.engineURI=null;$scope.instance=null;$scope.close=null;$scope.parametersTable=null;$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.instance=dialog.config.dataflowinstance;$scope.close=dialog.close;$scope.parametersTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"parameters_div").dataTable(HQTableUtil.getDefaultPlainDatatableConfig());
applyTable($scope.parametersTable,$scope.instance.parameters);$scope.$apply()};$scope.doRemove=function(cancelAndRemove){var cbDeleted=function(){var msg=cancelAndRemove==true?"The dataflow instance was cancelled and removed":"The dataflow instance was removed";dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:msg});$scope.close()};restService.deleteDataflowInstance($scope.endpointName,$scope.engineURI,$scope.instance.dataflowInstanceName,cbDeleted)};$scope.doCancel=function(){var cbCancelled=
function(){dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:"The dataflow instance was cancelled"});$scope.close()};var update={state:"CANCELLED"};restService.updateDataflowInstance($scope.endpointName,$scope.engineURI,$scope.instance.dataflowInstanceName,update,cbCancelled)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-dataflowinstancedetail")};var applyTable=function(table,parameters){var myarr=[];for(var i=0;i<parameters.length;i++){var row=parameters[i];
myarr.push([HQStringUtil.emptyString(row["uri"]),HQStringUtil.emptyString(row["value"]),HQStringUtil.emptyString(row["valueType"]),HQStringUtil.emptyString(row["isNull"])])}table.fnClearTable();table.fnAddData(myarr)}};function DebuggerController($scope,dialogService,restService){$scope.traceFileName=null;$scope.data=null;$scope.moduleEditor=null;$scope.sequenceEditor=null;$scope.eventcpTable=null;$scope.eventTable=null;$scope.sequence=null;$scope.sequenceInputEventPerLine=[];$scope.actions=[];$scope.filters=[];$scope.doInitialize=function(dialog){$scope.traceFileName=dialog.config.trace;$scope.data=dialog.config.detail;var sequenceAndLines=computeSequenceText($scope.data.actions,$scope.data.outputs);$scope.sequence=
sequenceAndLines.sequence;$scope.sequenceInputEventPerLine=sequenceAndLines.inputEventPerLine;var containerRoot=HQJqueryUtil.findElementById(dialog.root,"debugger_top_container");var handleConfig={handles:"s",s:$(".debugger-resizable-s")};containerRoot.resizable(handleConfig);handleConfig={handles:"e",e:$(".debugger-resizable-e")};HQJqueryUtil.findElementById(dialog.root,"debugger_statements").resizable(handleConfig);HQJqueryUtil.findElementById(dialog.root,"debugger_sequence").resizable(handleConfig);
var moduleTextarea=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"debugger_epl_text")[0];$scope.moduleEditor=CodeMirror.fromTextArea(moduleTextarea,HQCodeMirrorUtil.getDefaultReadOnlyConfig());$scope.moduleEditor.setValue($scope.data.epl);$scope.moduleEditor.on("gutterClick",function(instance,line){var statement=findStatementAtLine(line+1,$scope.data.statements);if(statement!=null){toggleInsertRemoveFilter($scope.filters,"statement",statement);$scope.applyFiltersRefreshTablesAndEditors();
$scope.$apply()}});var sequenceTextarea=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"debugger_sequence_text")[0];$scope.sequenceEditor=CodeMirror.fromTextArea(sequenceTextarea,HQCodeMirrorUtil.getDefaultReadOnlyConfig());$scope.sequenceEditor.setValue($scope.sequence);$scope.sequenceEditor.on("gutterClick",function(instance,line){var input=findInputEventAtLine(line+1,$scope.sequenceInputEventPerLine,$scope.data.events,$scope.data.time);if(input!=null){toggleInsertRemoveFilter($scope.filters,
"inputevent",input);$scope.applyFiltersRefreshTablesAndEditors();$scope.$apply()}});var $debuggertabs=HQJqueryUtil.findElementById(dialog.root,"debugger_tabs");$debuggertabs.tabs();var tableconfig=HQTableUtil.getDefaultPlainDatatableConfig({"bFilter":true,"bInfo":true});tableconfig.aoColumnDefs.push({bVisible:false,aTargets:[0,1]});$scope.eventcpTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"debugger_eventcp_table").dataTable(tableconfig);$scope.eventcpTable.delegate("tr","click",function(){handleSelect($scope.eventcpTable,
$scope.eventcpTable.fnGetPosition(this))});$scope.eventTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"debugger_event_table").dataTable(tableconfig);$scope.eventTable.delegate("tr","click",function(){handleSelect($scope.eventTable,$scope.eventTable.fnGetPosition(this))});$scope.timeTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"debugger_time_table").dataTable(tableconfig);$scope.timeTable.delegate("tr","click",function(){handleSelect($scope.timeTable,$scope.timeTable.fnGetPosition(this))});
$scope.applyFiltersRefreshTablesAndEditors();$scope.$apply()};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-debugger")};$scope.doNavigate=function(object){var position=object.positionId;var config={trace:$scope.traceFileName,positionId:position,title:position};dialogService.getOpenDialogCallback()(HQ_DIALOG.DEBUGGERENTRYPOINT,config)};$scope.doRemoveFilters=function(){$scope.filters=[];$scope.applyFiltersRefreshTablesAndEditors()};$scope.doRemoveFilter=function(index){$scope.filters.splice(index,
1);$scope.applyFiltersRefreshTablesAndEditors()};$scope.applyFiltersRefreshTablesAndEditors=function(){$scope.eventcpTable.fnClearTable();$scope.eventTable.fnClearTable();$scope.timeTable.fnClearTable();$scope.actions=filterActions($scope.data.actions,$scope.filters);$scope.eventcpTable.fnAddData(compileEventCPRows($scope.actions));$scope.eventTable.fnAddData(compileEventRows($scope.actions));$scope.timeTable.fnAddData(compileTimeRows($scope.actions));var linesEPL=[];var linesSequence=[];var linelist;
for(var i=0;i<$scope.filters.length;i++){var filter=$scope.filters[i];if(filter.hasOwnProperty("statement")){linelist=getStatementLineNumbers(filter.statement,$scope.data.statements,$scope.moduleEditor);linesEPL=linesEPL.concat(linelist)}else{linelist=getSequenceLineNumbers(filter.inputevent,$scope.sequenceInputEventPerLine,$scope.sequence);linesSequence=linesSequence.concat(linelist)}}setGutterBreakpoints(linesEPL,$scope.moduleEditor);setGutterBreakpoints(linesSequence,$scope.sequenceEditor)};var computeSequenceText=
function(actions,outputs){var i,j,k,event;var eventIdToOutputList={};for(i=0;i<outputs.length;i++){var output=outputs[i];var entry=eventIdToOutputList[output.inputEventId];if(entry==null){entry=[output];eventIdToOutputList[output.inputEventId]=entry}else entry.push(output)}var inputEventPerLine=[];var text="";var lineNumber=0;for(i=0;i<actions.length;i++){var action=actions[i];var line=null;if(action.hasOwnProperty("event")){line=action.event.eventTypeName+"\x3d"+action.event.event.props+"\n";lineNumber++}if(action.hasOwnProperty("time")){line=
"t\x3d'"+HQDateUtil.printDate(action.time.engineTime)+"'\n";lineNumber++}if(line==null)continue;var inputEventId=action.inputEventId;inputEventPerLine.push({line:lineNumber,inputEventId:inputEventId});var outputEvents=eventIdToOutputList[inputEventId];if(outputEvents!=null)for(j=0;j<outputEvents.length;j++){var out=outputEvents[j];line+="  // \x3d\x3d\x3e Output Statement '"+out.statementName+"'\n";lineNumber++;if(out.insert!=null)for(k=0;k<out.insert.length;k++){event=out.insert[k];line+="  // (Inserted) "+
event.props+"\n";lineNumber++}if(out.remove!=null)for(k=0;k<out.remove.length;k++){event=out.remove[k];line+="  // (Removed) "+event.props+"\n";lineNumber++}}text+=line}return{sequence:text,inputEventPerLine:inputEventPerLine}};var filterActions=function(actions,filters){if(filters.length==0)return actions;actions=filterActionsStatement(actions,filters);actions=filterActionsEvent(actions,filters);return actions};var filterActionsStatement=function(actions,filters){var statementIds={};var hasFilter=
false;for(i=0;i<filters.length;i++){var filter=filters[i];if(filter.hasOwnProperty("statement")){statementIds[filter.statement.statementId]=true;hasFilter=true}}if(!hasFilter)return actions;var i,j,k;var filtered=[];for(i=0;i<actions.length;i++){var action=actions[i];if(action.hasOwnProperty("mgmt")){if(statementIds.hasOwnProperty(action.mgmt.statementId))filtered.push(action);continue}var matchesStatementId=false;if(action.hasOwnProperty("event")||action.hasOwnProperty("time")){for(j=0;j<action.steps.length;j++){var step=
action.steps[j];if(step.hasOwnProperty("update")){if(statementIds.hasOwnProperty(step.update.statementId))filtered.push(action);continue}for(k=0;k<step.entries.length;k++){var entry=step.entries[k];var q;if(entry.hasOwnProperty("eventCP"))q=entry.eventCP;else if(entry.hasOwnProperty("timeCP"))q=entry.timeCP;else if(entry.hasOwnProperty("namedWindowCP"))q=entry.namedWindowCP;if(statementIds.hasOwnProperty(q.statementId)){matchesStatementId=true;break}}if(matchesStatementId)break}if(matchesStatementId)filtered.push(action)}}return filtered};
var filterActionsEvent=function(actions,filters){var inputEventIds={};var hasFilter=false;for(i=0;i<filters.length;i++){var filter=filters[i];if(filter.hasOwnProperty("inputevent")){inputEventIds[filter.inputevent.inputEventId]=true;hasFilter=true}}if(!hasFilter)return actions;var filtered=[];for(i=0;i<actions.length;i++){var action=actions[i];if(inputEventIds.hasOwnProperty(action.inputEventId))filtered.push(action)}return filtered};var handleSelect=function(table,rownum){if(rownum==null)return;
var position=table.fnGetData()[rownum][0];var title=table.fnGetData()[rownum][1];var config={trace:$scope.traceFileName,positionId:position,title:title};dialogService.getOpenDialogCallback()(HQ_DIALOG.DEBUGGERENTRYPOINT,config)};var compileEventCPRows=function(actions){var rows=[];var i,j,k,counter=0;for(i=0;i<actions.length;i++){var action=actions[i];for(j=0;j<action.steps.length;j++){var step=action.steps[j];for(k=0;k<step.entries.length;k++){var entry=step.entries[k];var stmtobj;var type;var detail;
var title;if(entry.hasOwnProperty("eventCP")){stmtobj=entry.eventCP;type="Event";detail=step.event.eventTypeName+" "+step.event.event.props;title=step.event.eventTypeName}if(entry.hasOwnProperty("timeCP")){stmtobj=entry.timeCP;type="Time";detail=stmtobj.engineTime;title=stmtobj.engineTime}if(entry.hasOwnProperty("namedwindowCP")){stmtobj=entry.namedwindowCP;type="Named Window Delta";detail=stmtobj.namedWindowName;title=stmtobj.namedWindowName}rows.push([entry.positionId,"Statement "+stmtobj.statementName+
"   "+type+" "+title,++counter,stmtobj.statementName,stmtobj.agentInstanceId==-1?"default":stmtobj.agentInstanceId,type,detail])}}}return rows};var compileEventRows=function(actions){var rows=[];var counter=0;for(i=0;i<actions.length;i++){var action=actions[i];if(!action.hasOwnProperty("event"))continue;counter++;rows.push([action.positionId,action.event.eventTypeName,counter,action.event.eventTypeName+" "+action.event.event.props])}return rows};var compileTimeRows=function(actions){var rows=[];var counter=
0;for(i=0;i<actions.length;i++){var action=actions[i];if(!action.hasOwnProperty("time"))continue;counter++;rows.push([action.positionId,HQDateUtil.printDate(action.time.engineTime),counter,HQDateUtil.printDate(action.time.engineTime)])}return rows};var findStatementAtLine=function(line,statements){for(var i=statements.length-1;i>=0;i--){var stmt=statements[i];if(stmt.line<=line)return stmt}return null};var findInputEventAtLine=function(line,sequenceInputEventPerLine,events,times){var inputEventId=
null;for(var i=sequenceInputEventPerLine.length-1;i>=0;i--){var obj=sequenceInputEventPerLine[i];if(obj.line<=line){inputEventId=obj.inputEventId;break}}return findInputEventForId(inputEventId,events,times)};var findInputEventForId=function(inputEventId,events,times){var i;for(i=0;i<events.length;i++){var event=events[i];if(event.inputEventId==inputEventId)return event}for(i=0;i<times.length;i++){var time=times[i];if(time.inputEventId==inputEventId)return time}return null};var getStatementLineNumbers=
function(selectedStmt,statements,editor){var beginLine=selectedStmt.line;var endLine=0;var i;for(i=0;i<statements.length;i++){var stmt=statements[i];if(stmt.line==beginLine){if(i==statements.length-1)endLine=editor.lineCount();else endLine=statements[i+1].line-1;break}}var lines=[];var started=false;for(i=endLine;i>=beginLine;i--){var line=editor.getLine(i-1);if(!started&&!HQStringUtil.isPopulated(line))continue;started=true;lines.push(i)}return lines};var getSequenceLineNumbers=function(inputevent,
sequenceInputEventPerLine,sequenceText){var index=HQCollectionUtil.findObjectValueInArray(sequenceInputEventPerLine,"inputEventId",inputevent.inputEventId);if(index==-1)return[];var beginLine=sequenceInputEventPerLine[index].line;var endLine;if(index<sequenceInputEventPerLine.length-1)endLine=sequenceInputEventPerLine[index+1].line-1;else endLine=sequenceText.split("\n").length;var lines=[];for(var i=beginLine;i<=endLine;i++)lines.push(i);return lines};var setGutterBreakpoints=function(lines,editor){editor.clearGutter("editor-validations");
for(var i=0;i<lines.length;i++)editor.setGutterMarker(lines[i]-1,"editor-validations",HQCodeMessageUtil.makeMarkerBreakpoint());editor.refresh()};var toggleInsertRemoveFilter=function(filters,assignedName,object){for(var i=0;i<filters.length;i++){var filter=filters[i];if(filter.hasOwnProperty(assignedName)&&filter[assignedName]==object){filters.splice(i,1);return}}var entry={};entry[assignedName]=object;filters.push(entry)}};function DebuggerEntryPointController($scope,dialogService,restService){$scope.traceFileName=null;$scope.dataRoot=null;$scope.rendersMap=null;$scope.shardsMap=null;$scope.event=null;$scope.time=null;$scope.mgmt=null;$scope.statementName=null;$scope.epl=null;$scope.contextPartition=null;$scope.$frameobrowserdiv=null;$scope.trees=[];$scope.cursor=[];$scope.frame=[];$scope.doInitialize=function(dialog){$scope.traceFileName=dialog.config.trace;$scope.dataRoot=dialog.config.detail.root;$scope.rendersMap=
HQCollectionUtil.arrayToMap(dialog.config.detail.renders,"qtype");$scope.shardsMap=HQCollectionUtil.arrayToMap(dialog.config.detail.shards,"type");var rootQ=$scope.dataRoot.q;var rootType=$scope.dataRoot.qtype;if(rootType=="STIMULANTEVENT"||rootType=="EVENT"||rootType=="EVENTCP")$scope.event=rootQ.eventTypeName+" "+rootQ.event.props;if(rootType=="STIMULANTTIME"||rootType=="TIME"||rootType=="TIMECP")$scope.time=HQDateUtil.printDate(rootQ.engineTime);if(rootType=="STIMULANTMGMTTRYSTART"||rootType==
"STIMULANTMGMTSTOP")$scope.mgmt="Statement Management";if(rootType=="STIMULANTMGMTTRYSTART"||rootType=="STIMULANTMGMTSTOP"||rootType=="EVENTCP"||rootType=="TIMECP"||rootType=="NAMEDWINDOWCP"){$scope.statementName=rootQ.statementName;$scope.epl=rootQ.epl;$scope.contextPartition=rootQ.agentInstanceId==-1?"default":rootQ.agentInstanceId}var containerRoot=HQJqueryUtil.findElementById(dialog.root,"debugger_top_container");var handleConfig={handles:"s",s:$(".debugger-resizable-s")};containerRoot.resizable(handleConfig);
handleConfig={handles:"e",e:$(".debugger-resizable-e")};HQJqueryUtil.findElementById(dialog.root,"debuggerep-statements").resizable(handleConfig);var moduleTextarea=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"debugger_entrypoint_epl")[0];$scope.moduleEditor=CodeMirror.fromTextArea(moduleTextarea,HQCodeMirrorUtil.getDefaultReadOnlyConfig());if($scope.epl!=null)$scope.moduleEditor.setValue($scope.epl);else $scope.moduleEditor.setValue("EPL will be displayed here");$scope.$frameobrowserdiv=
HQJqueryUtil.findElementById(dialog.root,"debugger_frame_obrowser");$scope.$frameobrowserdiv.dynatree({onLazyRead:function(node){HQDebugOBrowseUtil.loadOBrowserObjectNode(node,$scope.shardsMap)},debugLevel:0});convertDataNode($scope.dataRoot,null,$scope);$scope.trees.push($scope.dataRoot);setExpandDefault($scope.dataRoot);$scope.cursor=[0];$scope.updateDisplay(true);var control=HQJqueryUtil.findElementById(dialog.root,"debuggerep_control");control.keydown(function(e){if(e.keyCode==40)$scope.handleControlDownKey();
if(e.keyCode==39)$scope.handleControlRightKey();if(e.keyCode==38)$scope.handleControlUpKey();if(e.keyCode==37)$scope.handleControlLeftKey()});setTimeout(function(){control.focus()},50)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-dataflow")};$scope.updateDisplay=function(apply){applyFocus($scope.trees,$scope.cursor,true);var footerState=getFooter($scope.trees,$scope.cursor,$scope.rendersMap);$scope.frame=footerState.frame;if(apply)$scope.$apply();var rootNode=$scope.$frameobrowserdiv.dynatree("getRoot");
rootNode.removeChildren();rootNode.addChild(HQDebugOBrowseUtil.getOBrowserNodesForParameters(footerState.parameters,$scope.shardsMap))};$scope.doExpand=function(node){node.showContent=true;node.showExpand=false;node.showCollapse=true;$scope.updateDisplay(false)};$scope.doCollapse=function(node){node.showContent=false;node.showExpand=true;node.showCollapse=false;$scope.updateDisplay(false)};$scope.doNavigate=function(node){var config={trace:$scope.traceFileName,positionId:node.optionalPositionId,title:node.optionalPositionId};
dialogService.getOpenDialogCallback()(HQ_DIALOG.DEBUGGERENTRYPOINT,config)};$scope.doClickItem=function(node){var currentNode=findNode($scope.trees,$scope.cursor);if(currentNode!=null)currentNode.focus=false;var cursor=[0];var func=function(node){if(node.parent!=null){var index=HQCollectionUtil.findValueInArray(node.parent.nodes,node);cursor.push(index)}};internalRecursiveVisitParent(node,func);$scope.cursor=cursor;$scope.updateDisplay(false)};$scope.handleControlDownKey=function(){var currentNode=
findNode($scope.trees,$scope.cursor);if(currentNode==null){$scope.cursor=$scope.cursor.shift();$scope.updateDisplay(true);return}if(currentNode.nodes.length>0&&currentNode.showCollapse){currentNode.focus=false;var newfocus=$scope.cursor.slice(0);newfocus.push(0);$scope.cursor=newfocus;$scope.updateDisplay(true);return}if(currentNode.parent!=null&&currentNode.parent.nodes.length>1){var index=HQCollectionUtil.findValueInArray(currentNode.parent.nodes,currentNode);if(index+1<currentNode.parent.nodes.length){currentNode.focus=
false;$scope.cursor[$scope.cursor.length-1]=index+1;$scope.updateDisplay(true)}}};$scope.handleControlUpKey=function(){var currentNode=findNode($scope.trees,$scope.cursor);if(currentNode==null){$scope.cursor=$scope.cursor.shift();$scope.updateDisplay(true);return}if(currentNode.parent!=null&&currentNode.parent.nodes.length>1){var index=HQCollectionUtil.findValueInArray(currentNode.parent.nodes,currentNode);if(index>0){currentNode.focus=false;$scope.cursor[$scope.cursor.length-1]=index-1;$scope.updateDisplay(true);
return}}if(currentNode.parent!=null){currentNode.focus=false;$scope.cursor.pop();$scope.updateDisplay(true)}};$scope.handleControlRightKey=function(){var currentNode=findNode($scope.trees,$scope.cursor);if(currentNode.nodes.length>0&&currentNode.showContent==false){currentNode.showContent=true;currentNode.showExpand=false;currentNode.showCollapse=true;$scope.updateDisplay(true)}};$scope.handleControlLeftKey=function(){var currentNode=findNode($scope.trees,$scope.cursor);if(currentNode.nodes.length>
0&&currentNode.showContent==true){currentNode.showContent=false;currentNode.showExpand=true;currentNode.showCollapse=false;$scope.updateDisplay(true)}};var applyFocus=function(trees,cursor,focus){var node=findNode(trees,cursor);if(node!=null)node.focus=focus};var findNode=function(trees,cursor){if(cursor.length==0)return null;var node=trees[cursor[0]];if(cursor.length==1)return node;var copycursor=cursor.slice(0);copycursor.shift();return internalRecursiveFind(node,copycursor)};var convertDataNode=
function(node,parent,$scope){var hasChildNodes=node.children!=null&&node.children.length>0;node.nodes=[];if(hasChildNodes)for(var i=0;i<node.children.length;i++)node.nodes.push(convertDataNode(node.children[i],node,$scope));node.title=getTitleText(node,$scope.rendersMap,$scope.shardsMap);node.summary=getSummaryText(node,$scope.rendersMap,$scope.shardsMap);node.qtext=node.qtype;node.parent=parent;node.focus=false;node.showFooter=hasChildNodes;node.showExpand=hasChildNodes;node.showCollapse=false;node.showNavigate=
$scope.epl==null&&(node.qtype=="EVENTCP"||node.qtype=="TIMECP"||node.qtype=="NAMEDWINDOWCP");node.showContent=false;return node};var getFooter=function(trees,cursor,rendersMap){var node=findNode(trees,cursor);if(node==null)return new DebuggerFooterState;var q=node.q;var a=node.a;var key;var stateChangeNames={};for(key in q)if(q.hasOwnProperty(key)&&a.hasOwnProperty(key))stateChangeNames[key]=key;var parameters=[];var outcomesKeys={};var row=rendersMap[node.qtype];if(row!=null&&row.resultParameter!=
null){parameters.push({name:"result",value:node.a[row.resultParameter],outcome:true});outcomesKeys["result"]=0}for(key in a){if(!a.hasOwnProperty(key)||stateChangeNames.hasOwnProperty(key)||outcomesKeys.hasOwnProperty(key))continue;parameters.push({name:key,value:a[key],outcome:true})}for(key in q)if(q.hasOwnProperty(key)&&a.hasOwnProperty(key))parameters.push({name:key,value:{is:a[key],was:q[key]},outcome:true});for(key in q){if(!q.hasOwnProperty(key)||stateChangeNames.hasOwnProperty(key))continue;
parameters.push({name:key,value:q[key],outcome:false});parameters[key]=q[key]}var frame=[];var child=node;while(child!=null){frame.push(child.title);child=child.parent}return new DebuggerFooterState(frame,parameters)};var internalRecursiveFind=function(node,path){if(path.length==0)return node;var index=path[0];if(node.nodes!=null&&node.nodes.length>index){path.shift();return internalRecursiveFind(node.nodes[index],path)}return null};var internalRecursiveVisitParent=function(node,visitor){if(node.parent!=
null)internalRecursiveVisitParent(node.parent,visitor);visitor(node)};var internalRecursiveVisitTree=function(node,visitor){visitor(node);if(node.nodes!=null&&node.nodes.length>0)for(var i=0;i<node.nodes.length;i++)internalRecursiveVisitTree(node.nodes[i],visitor)};var getTitleText=function(node,rendersMap,shardsMap){var row=rendersMap[node.qtype];if(row==null)return node.qtype;var title=HQDebugOBrowseUtil.renderText(row.message,row.inputParameters,node.q,node.a,false,shardsMap);if(node.nodes.length==
0&&row.resultParameter!=null){var value=node.a[row.resultParameter];title=title+" --\x3e Result : ["+value+"]"}return title};var getSummaryText=function(node,rendersMap,shardsMap){var counter=-1;internalRecursiveVisitTree(node,function(){counter++});var childcount=node.nodes==null?0:node.nodes.length;var row=rendersMap[node.qtype];if(row==null)return node.qtype;var title=HQDebugOBrowseUtil.renderText(row.message,row.inputParameters,node.q,node.a,true,shardsMap);var result="("+childcount+" ops, "+
counter+" nested ops) Done: "+title;if(row.resultParameter!=null){var value=node.a[row.resultParameter];result="Result : ["+undefinedText(value)+"] \x3c-- "+result}return result};var setExpandDefault=function(node){if(node.nodes.length==0)return;node.showCollapse=true;node.showExpand=false;node.showContent=true;var child;for(var i=0;i<node.nodes.length;i++){child=node.nodes[i];child.showContent=false}};var undefinedText=function(value){if(typeof value=="undefined")return"(null)";return value.toString()};
var DebuggerFooterState=function(frame,parameters){this.frame=frame;this.parameters=parameters}}HQDebugOBrowseUtil=function(){};
HQDebugOBrowseUtil.getOBrowserNodeForValue=function(key,value,outcomeIcon,shardsMap){if(key=="_st"||key=="_cpObjectId")return null;var folder=false;var title;var isLazy=false;var expandMeNow=false;if(value==null||typeof value=="undefined")title=key+" \x3d (null)";else if(HQObjectUtil.isArray(value)){title=key+" \x3d array of "+value.length+" elements";folder=true;isLazy=true}else if(typeof value=="object")if(value.hasOwnProperty("is")&&value.hasOwnProperty("was"))title=key+" \x3d "+value.is+" (was: "+
value.was+")";else{var shardMessage=HQDebugOBrowseUtil.getObjectValueShardSummary(shardsMap,value);if(shardMessage!=null)title=key+" \x3d "+shardMessage;else title=key;folder=true;isLazy=true;var propcount=HQObjectUtil.countProperties(value);if(propcount<=3)expandMeNow=true}else if(typeof value=="string")title=key+' \x3d "'+value+'"';else title=key+" \x3d "+value.toString();return{title:title,isFolder:folder,isLazy:isLazy,icon:outcomeIcon?"/esperhqapp/assets/debugoutcome.png":"/esperhqapp/assets/debugparam.png",
objectdata:value,expandMeNow:expandMeNow}};HQDebugOBrowseUtil.getOBrowserNodesForParameters=function(parameters,shardsMap){var nodes=[];for(var i=0;i<parameters.length;i++){var param=parameters[i];var node=HQDebugOBrowseUtil.getOBrowserNodeForValue(param.name,param.value,param.outcome,shardsMap);if(node!=null)nodes.push(node)}return nodes};
HQDebugOBrowseUtil.getOBrowserNodesForObject=function(object,shardsMap){var nodes=[];var value,node;if(object.length>0)for(var i=0;i<object.length;i++){value=object[i];node=HQDebugOBrowseUtil.getOBrowserNodeForValue(i,value,false,shardsMap);if(node!=null)nodes.push(node)}else for(var key in object){if(!object.hasOwnProperty(key))continue;value=object[key];node=HQDebugOBrowseUtil.getOBrowserNodeForValue(key,value,false,shardsMap);if(node!=null)nodes.push(node)}return nodes};
HQDebugOBrowseUtil.loadOBrowserObjectNode=function(node,shardsMap){var childdata=HQDebugOBrowseUtil.getOBrowserNodesForObject(node.data.objectdata,shardsMap);if(childdata.length>0)node.addChild(childdata);else node.setLazyNodeStatus(DTNodeStatus_Ok);node.focus();node.expand(true);var children=node.getChildren();if(children!=null)for(var i=0;i<children.length;i++){var child=children[i];if(child.data.expandMeNow==true){childdata=HQDebugOBrowseUtil.getOBrowserNodesForObject(child.data.objectdata,shardsMap);
if(childdata.length>0)child.addChild(childdata);else child.setLazyNodeStatus(DTNodeStatus_Ok);child.expand(true)}}};HQDebugOBrowseUtil.getObjectValueShardSummary=function(shardsMap,value){var stType=value.hasOwnProperty("_st")?value["_st"]:null;if(stType==null)return null;var shardMapEntry=shardsMap[stType];if(shardMapEntry==null||shardMapEntry.message==null)return null;return HQDebugOBrowseUtil.renderText(shardMapEntry.message,shardMapEntry.inputParameters,value,null,false,shardsMap)};
HQDebugOBrowseUtil.renderText=function(message,inputParameters,q,optionalA,preferAnswer,shardsMap){var parameters=[];if(inputParameters!=null)for(var i=0;i<inputParameters.length;i++){var param=inputParameters[i];var value;if(preferAnswer&&optionalA!=null&&optionalA.hasOwnProperty(param))value=optionalA[param];else value=q[param];if(typeof value=="object"){var shardMessage=HQDebugOBrowseUtil.getObjectValueShardSummary(shardsMap,value);if(shardMessage!=null)value=shardMessage}parameters.push(value)}return vsprintf(message,
parameters)};function DeploymentBrowseController($scope,dialogService,restService){$scope.deploymentTable=null;$scope.endpointName=null;$scope.engineURI=null;$scope.deployments=null;$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.deployments=dialog.config.deployments;$scope.deploymentTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"deployments_div").dataTable(HQTableUtil.getDefaultFullDatatableConfig({}));$scope.deploymentTable.delegate("tr",
"click",function(){var deploymentId=$("td:first",this).text();if(HQStringUtil.isPopulated(deploymentId)){var dialogConfig={endpointName:$scope.endpointName,engineURI:$scope.engineURI,deploymentId:deploymentId};dialogService.getOpenDialogCallback()(HQ_DIALOG.DEPLOYMENTDETAIL,dialogConfig)}});HQTableUtil.applyDeploymentsTable($scope.deploymentTable,$scope.deployments.deployments)};$scope.doRefresh=function(){var handle=function(response){$scope.deployments=response;HQTableUtil.applyDeploymentsTable($scope.deploymentTable,
$scope.deployments.deployments)};restService.fetchDeployments($scope.endpointName,$scope.engineURI,handle)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-deployments")};$scope.doNew=function(){dialogService.getOpenDialogCallback()(HQ_DIALOG.DEPLOYCREATE,{endpointName:$scope.endpointName,engineURI:$scope.engineURI})}};function DeploymentCreateController($scope,restService,dialogService){$scope.endpointName=null;$scope.engineURI=null;$scope.editor=null;$scope.closeDialog=null;$scope.templateTable=null;$scope.templates=null;$scope.templateDialog=null;$scope.existingTable=null;$scope.existing=null;$scope.existingDialog=null;$scope.selectedFile=null;$scope.undeployExisting=true;$scope.closeOnDeploy=true;$scope.messagesTable=null;$scope.deploymentId=null;$scope.archive=null;$scope.userObject=null;$scope.moduleURI=null;
$scope.doInitialize=function(dialog){$scope.closeDialog=dialog.close;$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;var editorTextarea=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"modulecreate_editor_div")[0];$scope.editor=CodeMirror.fromTextArea(editorTextarea,HQCodeMirrorUtil.getDefaultConfig());$scope.editor.setValue("\n\n");$scope.editor.setCursor(0,0);$scope.templateTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"templates_div").dataTable(HQTableUtil.getDefaultPlainDatatableConfig());
$scope.templateTable.delegate("tr","click",function(){var rownum=$scope.templateTable.fnGetPosition(this);if(rownum!=null){$scope.templateDialog.dialog("close");var row=$scope.templates.templates[rownum];$scope.editor.setValue(row["text"])}});$scope.templateDialog=HQJqueryUtil.findElementById(dialog.root,"templates_dialog").dialog({title:"Module Templates",modal:true,dialogClass:"dialog-visible",minWidth:HQ_DIALOGDIMENSION_ENUM.VERYSMALL.width,minHeight:HQ_DIALOGDIMENSION_ENUM.VERYSMALL.height,resizable:true,
autoOpen:false});$scope.existingTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"existing_div").dataTable(HQTableUtil.getDefaultPlainDatatableConfig());$scope.existingTable.delegate("tr","click",function(){var rownum=$scope.existingTable.fnGetPosition(this);if(rownum!=null){$scope.existingDialog.dialog("close");var row=$scope.existing.deployments[rownum];$scope.editor.setValue(row.text)}});$scope.existingDialog=HQJqueryUtil.findElementById(dialog.root,"existing_dialog").dialog({title:"Existing Modules",
modal:true,dialogClass:"dialog-visible",minWidth:HQ_DIALOGDIMENSION_ENUM.VERYSMALL.width,minHeight:HQ_DIALOGDIMENSION_ENUM.VERYSMALL.height,resizable:true,autoOpen:false});$scope.messagesTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"messages_div").dataTable(HQTableUtil.getDefaultPlainDatatableConfig())};$scope.doTemplates=function(){$scope.clearMessages();var cbFetched=function(response){$scope.templateDialog.dialog("open");$scope.templates=response;var myarr=[];for(var i=0;i<response.templates.length;i++){var row=
response.templates[i];myarr.push([row["templateName"],row["description"]])}$scope.templateTable.fnClearTable();$scope.templateTable.fnAddData(myarr)};restService.fetchModuleTemplates(cbFetched)};$scope.doExisting=function(){$scope.clearMessages();var cbFetched=function(response){$scope.existingDialog.dialog("open");$scope.existing=response;HQTableUtil.applyDeploymentsTable($scope.existingTable,response.deployments)};restService.fetchDeployments($scope.endpointName,$scope.engineURI,cbFetched)};$scope.doValidate=
function(){$scope.clearMessages();if(!$scope.checkAssertHasEPL())return;var cbDone=function(response){dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:"Validation succeeded"})};var cbError=function(details){HQCodeMessageUtil.setMessages($scope.messagesTable,$scope.editor,details)};restService.validateDeployment($scope.endpointName,$scope.engineURI,{text:$scope.editor.getValue()},cbDone,cbError)};$scope.doAddOrDeploy=function(deploy){$scope.clearMessages();if(!$scope.checkAssertHasEPL())return;
var cbDone=function(response){var message="The deployment by id '"+response.deploymentId+"' completed successfully";dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:message});if($scope.closeOnDeploy==true)$scope.closeDialog()};var cbError=function(details){HQCodeMessageUtil.setMessages($scope.messagesTable,$scope.editor,details)};restService.createDeployment($scope.endpointName,$scope.engineURI,$scope.undeployExisting,{text:$scope.editor.getValue(),state:deploy?"DEPLOYED":
"UNDEPLOYED",deploymentId:$scope.deploymentId,moduleURI:$scope.moduleURI,archive:$scope.archive,userObject:$scope.userObject},cbDone,cbError)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-createdeployment")};$scope.doSave=function(){var filename="Module1"+"."+HQ_FILETYPE.MODULE.extension;var saveConfig={filename:filename,mode:HQ_FILEDIALOGOPTYPE.SAVE,body:$scope.editor.getValue(),filetype:HQ_FILETYPE.MODULE};dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_FILESAVELOAD,saveConfig)};
$scope.doLoad=function(){var loadCallback=function(content){$scope.editor.setValue(content.body);$scope.clearMessages()};var config={mode:HQ_FILEDIALOGOPTYPE.LOAD,filetype:HQ_FILETYPE.MODULE,loadCallback:loadCallback};dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_FILESAVELOAD,config)};$scope.checkAssertHasEPL=function(){if(!HQStringUtil.isPopulated($scope.editor.getValue())){$scope.eplErrorMsg="Please provide EPL text";return false}return true};$scope.clearMessages=function(){HQCodeMessageUtil.clearGutterAndMessages($scope.editor,
$scope.messagesTable);$scope.eplErrorMsg=null}};function DeploymentDetailController($scope,dialogService,restService){$scope.endpointName=null;$scope.engineURI=null;$scope.deployment=null;$scope.deploymentAddedDate=null;$scope.deploymentLastUpdDate=null;$scope.deploystmtsTable=null;$scope.importsTable=null;$scope.usesTable=null;$scope.dialogClose=null;$scope.canDeploy=true;$scope.doInitialize=function(dialog){$scope.dialogClose=dialog.close;$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.deployment=
dialog.config.deployment;$scope.deploymentAddedDate=HQDateUtil.printDate($scope.deployment.addedDate);$scope.deploymentLastUpdDate=HQDateUtil.printDate($scope.deployment.lastUpdateDate);$scope.importsTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"imports_div").dataTable({"bPaginate":false,"bLengthChange":false,"bFilter":false,"bInfo":false});$scope.usesTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"uses_div").dataTable({"bPaginate":false,"bLengthChange":false,"bFilter":false,
"bInfo":false});$scope.deploystmtsTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"deploystmt_div").dataTable({"bPaginate":false,"bLengthChange":false,"bFilter":false,"bInfo":false,"bAutoWidth":false,"aoColumns":[{sWidth:"3em"},{sWidth:"40em"},{sWidth:"40em"}]});$scope.deploystmtsTable.delegate("tr","click",function(){var statementName=$("td:nth-child(2)",this).text();if(HQStringUtil.isPopulated(statementName)){var dialogConfig={endpointName:$scope.endpointName,engineURI:$scope.engineURI,
statementName:statementName};dialogService.getOpenDialogCallback()(HQ_DIALOG.STATEMENTDETAIL,dialogConfig)}});updateTable($scope.importsTable,$scope.deployment.moduleImports);updateTable($scope.usesTable,$scope.deployment.moduleUses);updateStmts($scope.deploystmtsTable,$scope.deployment.statements);$scope.canDeploy=HQStringUtil.isPopulated($scope.deployment.archive)?HQStringUtil.endsWith($scope.deployment.archive,"war"):true;var editorTextarea=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,
"deploymentdetail_editor")[0];$scope.editor=CodeMirror.fromTextArea(editorTextarea,HQCodeMirrorUtil.getDefaultReadOnlyConfig());$scope.editor.setValue($scope.deployment.text+"\n\n");$scope.$apply()};$scope.doCheckDisallowDeploy=function(){if($scope.deployment!=null&&$scope.deployment.archive!=null&&HQStringUtil.endsWith($scope.deployment.archive,".war"))return true;return false};$scope.doUndeployRemove=function(){cbDeleted=function(){var message="The deployment by id '"+$scope.deployment.deploymentId+
"' has been un-deployed and removed";dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:message});$scope.dialogClose()};restService.deleteDeployment($scope.endpointName,$scope.engineURI,$scope.deployment.deploymentId,cbDeleted)};$scope.doRemove=function(){$scope.doUndeployRemove()};$scope.doUndeploy=function(){$scope.transitionModule("UNDEPLOYED")};$scope.doDeploy=function(){$scope.transitionModule("DEPLOYED")};$scope.doSaveFile=function(){var filename="Module "+$scope.deployment.moduleName+
"."+HQ_FILETYPE.MODULE.extension;var saveConfig={filename:filename,mode:HQ_FILEDIALOGOPTYPE.SAVE,body:$scope.deployment.text,filetype:HQ_FILETYPE.MODULE};dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_FILESAVELOAD,saveConfig)};$scope.transitionModule=function(newState){cbUpdated=function(){var message="The deployment by id '"+$scope.deployment.deploymentId+"' has been transitioned to '"+newState+"'";dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:message});$scope.dialogClose()};
var state={state:newState};restService.updateDeployment($scope.endpointName,$scope.engineURI,$scope.deployment.deploymentId,state,cbUpdated)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-deploymentdetail")};var updateTable=function(table,stringArray){if(stringArray==null)return;table.fnClearTable();table.fnAddData(HQCollectionUtil.arrayToSingleValueRowArray(stringArray))};var updateStmts=function(table,stmts){if(stmts==null)return;var mystmts=[];for(var i=0;i<stmts.length;i++){var row=
stmts[i];mystmts.push([""+(i+1),row["statementName"],row["epl"]])}table.fnClearTable();table.fnAddData(mystmts)}};function EventDataEntryController($scope){$scope.okCallback=null;$scope.close=null;$scope.eventType=null;$scope.fields={};$scope.doInitialize=function(dialog){$scope.okCallback=dialog.config.okCallback;$scope.close=dialog.close;$scope.eventType=dialog.config.eventType;$scope.$apply()};$scope.doClose=function(ok){if(ok)$scope.okCallback($scope.fields);$scope.close()}};function EventTypeBrowseController($scope,dialogService,restService){$scope.endpointName=null;$scope.engineURI=null;$scope.eventtypeTable=null;$scope.eventTypes=null;$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.eventTypes=dialog.config.eventtypes;$scope.eventtypeTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"eventtypebrowse_listdiv").dataTable(HQTableUtil.getDefaultFullDatatableConfig({}));$scope.eventtypeTable.delegate("tr",
"click",function(){var rownum=$scope.eventtypeTable.fnGetPosition(this);if(rownum!=null){var selectedType=$scope.eventTypes.eventTypes[rownum];var dialogConfig={endpointName:$scope.endpointName,engineURI:$scope.engineURI,eventTypeName:selectedType.eventTypeName};dialogService.getOpenDialogCallback()(HQ_DIALOG.EVENTTYPEDETAIL,dialogConfig)}});applyEventTypes()};$scope.doRefresh=function(){var cbFetched=function(response){$scope.eventTypes=response;applyEventTypes()};restService.fetchEventTypes($scope.endpointName,
$scope.engineURI,null,cbFetched)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-eventtypes")};var applyEventTypes=function(){var table=$scope.eventtypeTable;var eventTypes=$scope.eventTypes.eventTypes;var myarr=[];for(var i=0;i<eventTypes.length;i++){var row=eventTypes[i];myarr.push([row["eventTypeName"],row["typeClass"],HQStringUtil.csvFromArrayOfObject(row["properties"],"propertyName")])}table.fnClearTable();table.fnAddData(myarr)}};function EventTypeDetailController($scope,dialogService){$scope.endpointName=null;$scope.engineURI=null;$scope.eventtype=null;$scope.propertyTable=null;$scope.statementTable=null;$scope.typeSupertypes=null;$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.eventtype=dialog.config.eventtype;$scope.propertyTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"eventtypebrowse_propsdiv").dataTable(HQTableUtil.getDefaultPlainDatatableConfig());
HQTableUtil.applyPropertiesSummaryTable($scope.propertyTable,$scope.eventtype.properties);$scope.typeSupertypes=HQStringUtil.csvFromArray($scope.eventtype.supertypes);$scope.statementTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"eventtypebrowse_statementdiv").dataTable(HQTableUtil.getDefaultPlainDatatableConfig());$scope.statementTable.delegate("tr","click",function(){var statementName=$("td:first",this).text();if(HQStringUtil.isPopulated(statementName)){var dialogConfig={endpointName:$scope.endpointName,
engineURI:$scope.engineURI,statementName:statementName};dialogService.getOpenDialogCallback()(HQ_DIALOG.STATEMENTDETAIL,dialogConfig)}});applyReferringStatements();$scope.$apply()};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-eventtypedetail")};var applyReferringStatements=function(){var table=$scope.statementTable;var names=$scope.eventtype.referringStatementNames;var myarr=[];for(var i=0;i<names.length;i++)myarr.push([names[i]]);table.fnClearTable();table.fnAddData(myarr)}};var module=angular.module("myModule",[]);AngularInit.init(module);jQuery.widget("ui.dialog",jQuery.extend({},jQuery.ui.dialog.prototype,{_title:function(titleBar){titleBar.html(this.options.title||"\x26#160;")}}));
function IndexCtrl($scope,dialogService,restService){$scope.captive=null;$scope.endpoints=[];$scope.engineURIs=[];$scope.selectedEndpoint=null;$scope.selectedEngine=null;$scope.dialogs=HQ_DIALOG;$scope.envUpdateEventTarget=new EventTarget;$scope.doHandleSelectEndpointAndEngine=function(choiceEndpoint,choiceEngine){$scope.selectedEndpoint=choiceEndpoint;$scope.selectedEngine=choiceEngine};$scope.doMenuDialog=function(hqDialogEnum){var endpointName=$scope.selectedEndpoint.endpointName;var engineURI=
$scope.selectedEngine.engineURI;var dialogConfig={endpointName:endpointName,engineURI:engineURI};var cbFetched;if(hqDialogEnum==HQ_DIALOG.DEPLOYBROWSE){cbFetched=function(response){dialogConfig["deployments"]=response;openDialog(hqDialogEnum,dialogConfig)};restService.fetchDeployments(endpointName,engineURI,cbFetched)}else if(hqDialogEnum==HQ_DIALOG.EVENTTYPEBROWSE){cbFetched=function(response){dialogConfig["eventtypes"]=response;openDialog(hqDialogEnum,dialogConfig)};restService.fetchEventTypes(endpointName,
engineURI,null,cbFetched)}else if(hqDialogEnum==HQ_DIALOG.NAMEDWINDOWBROWSE){cbFetched=function(response){dialogConfig["namedwindows"]=response;openDialog(hqDialogEnum,dialogConfig)};restService.fetchNamedWindows(endpointName,engineURI,cbFetched)}else if(hqDialogEnum==HQ_DIALOG.SEQUENCEEXECBROWSE){cbFetched=function(response){dialogConfig["sequences"]=response;openDialog(hqDialogEnum,dialogConfig)};restService.fetchSequenceExecutions(endpointName,engineURI,cbFetched)}else if(hqDialogEnum==HQ_DIALOG.VARIABLEBROWSE){cbFetched=
function(response){dialogConfig["variables"]=response;openDialog(hqDialogEnum,dialogConfig)};restService.fetchVariables(endpointName,engineURI,cbFetched)}else if(hqDialogEnum==HQ_DIALOG.DATAFLOWBROWSE){cbFetched=function(response){dialogConfig["dataflows"]=response;openDialog(hqDialogEnum,dialogConfig)};restService.fetchDataflows(endpointName,engineURI,cbFetched)}else if(hqDialogEnum==HQ_DIALOG.DATAFLOWINSTANCEBROWSE){cbFetched=function(response){dialogConfig["instances"]=response;openDialog(hqDialogEnum,
dialogConfig)};restService.fetchDataflowInstances(endpointName,engineURI,cbFetched)}else if(hqDialogEnum==HQ_DIALOG.WEBLAYERBROWSE){cbFetched=function(response){dialogConfig["info"]=response;openDialog(hqDialogEnum,dialogConfig)};restService.fetchPushinfoClient(cbFetched)}else if(hqDialogEnum==HQ_DIALOG.PUSHENDPOINTBROWSE){cbFetched=function(response){dialogConfig.info=response;dialogConfig.engines=$scope.selectedEndpoint.engines;openDialog(hqDialogEnum,dialogConfig)};restService.fetchPushinfoEndpoint(endpointName,
cbFetched)}else openDialog(hqDialogEnum,dialogConfig)};var openDialog=function(hqDialogEnum,dialogConfig){var titleRight=getTitleRightText();var cbFetched;if(hqDialogEnum==HQ_DIALOG.STATEMENTDETAIL){cbFetched=function(response){dialogConfig.statement=response;var title=hqDialogEnum.title+" : "+response.statementName;openDialogWindow(hqDialogEnum,dialogConfig,title,hqDialogEnum.url,titleRight)};restService.fetchStmtDetail(dialogConfig.endpointName,dialogConfig.engineURI,dialogConfig.statementName,
cbFetched)}else if(hqDialogEnum==HQ_DIALOG.DEPLOYMENTDETAIL){cbFetched=function(response){dialogConfig.deployment=response;var title=hqDialogEnum.title+" : "+response.deploymentId;openDialogWindow(hqDialogEnum,dialogConfig,title,hqDialogEnum.url,titleRight)};restService.fetchDeploymentDetail(dialogConfig.endpointName,dialogConfig.engineURI,dialogConfig.deploymentId,cbFetched)}else if(hqDialogEnum==HQ_DIALOG.EVENTTYPEDETAIL){cbFetched=function(response){dialogConfig.eventtype=response;var title=hqDialogEnum.title+
" : "+response.eventTypeName;openDialogWindow(hqDialogEnum,dialogConfig,title,hqDialogEnum.url,titleRight)};restService.fetchEventTypeDetail(dialogConfig.endpointName,dialogConfig.engineURI,dialogConfig.eventTypeName,cbFetched)}else if(hqDialogEnum==HQ_DIALOG.SEQUENCEEXECDETAIL){cbFetched=function(response){dialogConfig.sequence=response;var title=hqDialogEnum.title+" : "+response.sequenceExecutionName;openDialogWindow(hqDialogEnum,dialogConfig,title,hqDialogEnum.url,titleRight)};restService.fetchSequenceExecutionDetail(dialogConfig.endpointName,
dialogConfig.engineURI,dialogConfig.sequenceExecutionName,cbFetched)}else if(hqDialogEnum==HQ_DIALOG.DATAFLOWDETAIL){cbFetched=function(response){dialogConfig.dataflow=response;var title=hqDialogEnum.title+" : "+response.dataflowName;openDialogWindow(hqDialogEnum,dialogConfig,title,hqDialogEnum.url,titleRight)};restService.fetchDataflowDetail(dialogConfig.endpointName,dialogConfig.engineURI,dialogConfig.dataflowName,cbFetched)}else if(hqDialogEnum==HQ_DIALOG.DATAFLOWINSTANCEDETAIL){cbFetched=function(response){dialogConfig.dataflowinstance=
response;var title=hqDialogEnum.title+" : "+response.dataflowInstanceName;openDialogWindow(hqDialogEnum,dialogConfig,title,hqDialogEnum.url,titleRight)};restService.fetchDataflowInstanceDetail(dialogConfig.endpointName,dialogConfig.engineURI,dialogConfig.dataflowInstanceName,cbFetched)}else if(hqDialogEnum==HQ_DIALOG.STATEMENTITERATE){cbFetched=function(response){dialogConfig.rows=response;var title=hqDialogEnum.title+" : "+dialogConfig.statementName;openDialogWindow(hqDialogEnum,dialogConfig,title,
hqDialogEnum.url,titleRight)};restService.iterateStatement(dialogConfig.endpointName,dialogConfig.engineURI,dialogConfig.statementName,100,cbFetched)}else if(hqDialogEnum==HQ_DIALOG.EVENTLET){var cbCompleted=function(clientId){var activation={"clientId":clientId,"activationName":dialogConfig.eventletName,"activationXML":dialogConfig.eventletXml};restService.createActivation(clientId,activation,handleActivateResponse)};dialogService.getConsumerMgmtService().allocateOrGetClientId(restService,cbCompleted)}else if(hqDialogEnum==
HQ_DIALOG.SHARED_FILESAVELOAD){cbFetched=function(response){dialogConfig.rootFolder=response;openDialogWindow(hqDialogEnum,dialogConfig,hqDialogEnum.title,hqDialogEnum.url)};restService.fetchVFSItem(null,cbFetched)}else if(hqDialogEnum==HQ_DIALOG.EVENTLETWIZARD){dialogConfig.endpoints=$scope.endpoints;dialogConfig.selectedEndpoint=$scope.selectedEndpoint;dialogConfig.selectedEngineURI=$scope.selectedEngine;openDialogWindow(hqDialogEnum,dialogConfig,hqDialogEnum.title,hqDialogEnum.url)}else if(hqDialogEnum==
HQ_DIALOG.SHARED_ERRORALERT){dialogConfig.type="error";openDialogWindow(hqDialogEnum,dialogConfig,HQ_DIALOG.SHARED_ERRORALERT.title,hqDialogEnum.url)}else if(hqDialogEnum==HQ_DIALOG.SHARED_INFOALERT){dialogConfig.type="info";openDialogWindow(hqDialogEnum,dialogConfig,HQ_DIALOG.SHARED_INFOALERT.title,hqDialogEnum.url)}else if(hqDialogEnum==HQ_DIALOG.SHARED_CONFIRMALERT)openDialogWindow(hqDialogEnum,dialogConfig,HQ_DIALOG.SHARED_CONFIRMALERT.title,hqDialogEnum.url);else if(hqDialogEnum==HQ_DIALOG.DEBUGGER){var rightHandTitleDebugger=
dialogConfig.trace;cbFetched=function(response){dialogConfig.detail=response;openDialogWindow(hqDialogEnum,dialogConfig,HQ_DIALOG.DEBUGGER.title,hqDialogEnum.url,rightHandTitleDebugger)};restService.getDebugDetail(dialogConfig.trace,cbFetched)}else if(hqDialogEnum==HQ_DIALOG.DEBUGGERENTRYPOINT){var rightHandTitleDebugEP=dialogConfig.trace+"  "+dialogConfig.title;cbFetched=function(response){dialogConfig.detail=response;openDialogWindow(hqDialogEnum,dialogConfig,HQ_DIALOG.DEBUGGERENTRYPOINT.title,
hqDialogEnum.url,rightHandTitleDebugEP)};restService.getDebugEntryPoint(dialogConfig.trace,dialogConfig.positionId,cbFetched)}else if(hqDialogEnum==HQ_DIALOG.SHARED_VIEWFILEBODY){var cbFileFetched=function(file){if(file.directory)return;dialogConfig.body=file.body;var title="File: "+dialogConfig.filepath;openDialogWindow(hqDialogEnum,dialogConfig,title,hqDialogEnum.url)};restService.fetchVFSItem(dialogConfig.filepath,cbFileFetched)}else{if(hqDialogEnum==HQ_DIALOG.SCENARIORUNDIALOG)dialogConfig.instrumented=
$scope.instrumented;openDialogWindow(hqDialogEnum,dialogConfig,hqDialogEnum.title,hqDialogEnum.url,titleRight)}};$scope.doCloseBrowser=function(){var clientId=dialogService.getConsumerMgmtService().getClientId();if(clientId!=null){restService.deleteClient(clientId,function(){console.log("Client id '"+clientId+"' deleted")});HQWindowUtil.spinLoopSleep(150)}};$scope.doLogout=function(){restService.logout();HQCookieUtil.clearUserCookie();var $body=$("body");$body.empty();$body.append("\x3ch4\x3eYou have been logged out\x3c/h4\x3e")};
dialogService.setOpenDialogCallback(openDialog);dialogService.getBrowserClosedEventTarget().addListener(HQ_EVENTTARGET_TYPE.BROWSER_CLOSED.name,$scope.doCloseBrowser);function handleEndpointAndEngineURI(endpoints){$scope.endpoints=endpoints;$scope.selectedEndpoint=HQEndpointUtil.getDefaultEndpoint($scope.endpoints);$scope.engineURIs=$scope.selectedEndpoint.engines;$scope.selectedEngine=HQEndpointUtil.getDefaultEngine($scope.engineURIs);setTimeout(function(){$scope.envUpdateEventTarget.fire(HQ_EVENTTARGET_TYPE.INDEXENVUPDATE.name)},
100)}var handleAuthenticated=function(){if($scope.captive==false){console.log("completed non-captive initialization");setTimeout(function(){$scope.envUpdateEventTarget.fire(HQ_EVENTTARGET_TYPE.CONFIGLOADED.name)},100)}};var handleFetchConfig=function(response){console.log("configuration is available, captive\x3d"+response.captive+", instrumented\x3d"+response.instrumented);$scope.instrumented=response.instrumented;var cbAuthenticated=function(){console.log("setting captive "+response.captive);$scope.captive=
response.captive;handleEndpointAndEngineURI(response.endpoints);handleAuthenticated();setTimeout(function(){$scope.$apply()},1)};if(!response.authenticate){cbAuthenticated();return}var cbRememberMe=function(response){if(response.hasOwnProperty("username")&&HQStringUtil.isPopulated(response.username)){console.log("completing initialization");cbAuthenticated();return}console.log("requiring challenge");var config={authenticated:cbAuthenticated};openDialogWindow(HQ_DIALOG.SHARED_LOGIN,config,"Login",
HQ_DIALOG.SHARED_LOGIN.url)};console.log("trying rememberme");restService.rememberMe(cbRememberMe)};restService.fetchConfiguration(handleFetchConfig);function dialog1(){var endpoints=[{endpointName:"defaultendpoint",isDefault:true,engines:[{engineURI:"default"}]}];handleEndpointAndEngineURI(endpoints)}setTimeout(dialog1,0);var handleActivateResponse=function(response){var websocketAndActivationReadyCallback=function(eventletWrapper){var dialogConfig={activation:response,consumerWrapper:eventletWrapper.consumerWrapper,
eventletShim:eventletWrapper.eventletShim};openDialogWindow(HQ_DIALOG.EVENTLET,dialogConfig,response.activationName,eventletWrapper.eventletUrl)};HQPushUtil.activateEventlet(response,dialogService.getConsumerMgmtService(),{},websocketAndActivationReadyCallback)};var openDialogWindow=function(hqDialogEnum,dialogConfig,title,url,titleRight){var width=HQ_DIALOGDIMENSION_ENUM.DEFAULT.width;var height=HQ_DIALOGDIMENSION_ENUM.DEFAULT.height;if(hqDialogEnum.hasOwnProperty("dimension")){width=hqDialogEnum.dimension.width;
height=hqDialogEnum.dimension.height}var modal=false;if(hqDialogEnum.hasOwnProperty("modal"))modal=hqDialogEnum.modal;var theTitle=title;if(titleRight!=null){theTitle='\x3cdiv style\x3d"float: left;"\x3eTITLE_LEFT\x3c/div\x3e'+'\x3cdiv style\x3d"float: right;"\x3eTITLE_RIGHT\x3c/div\x3e';theTitle=HQStringUtil.replaceAll("TITLE_LEFT",title,theTitle);theTitle=HQStringUtil.replaceAll("TITLE_RIGHT",titleRight,theTitle)}var html="\x3cdiv ng-app\x3d'myModule'/\x3e";var $div=$(html);var theurl=HQUriUtil.addUUIDToUrl(HQUriUtil.getUrlViews(url));
$div.load(theurl,function(response,status,xhr){if(!HQJqueryUtil.checkHandleLoadStatus(url,response,status,xhr))return;var activation=dialogConfig.activation;if(activation!=null&&activation.eventletSettings!=null&&activation.eventletSettings.menu==false){var menu=$div.find("div[hqeventletmenu\x3d'yes']:first");menu.removeAttr("hqeventletmenu")}angular.bootstrap($div,["myModule"]);var dialogClosedTarget=new DialogClosedEventTarget;var dialogCloseFunction=function(){dialogClosedTarget.fireDialogClosed()};
var settings={modal:modal,title:theTitle,width:width,height:height,close:dialogCloseFunction};if(!modal){var offset=dialogService.getXYWindowOffset();settings.position=[offset.x,offset.y]}var dialog=$div.dialog(settings);var closeButtonCallback=function(){dialog.dialog("close")};var dialogObject={root:$div,close:closeButtonCallback,config:dialogConfig,dialogClosedTarget:dialogClosedTarget};var scope=angular.element($div.children(":first")).scope();scope.doInitialize(dialogObject)})};var getTitleRightText=
function(){if($scope.selectedEndpoint!=null&&$scope.selectedEngine!=null)return"Endpoint: "+$scope.selectedEndpoint.endpointName+"\x26nbsp;\x26nbsp; Engine: "+$scope.selectedEngine.engineURI;return""}};function IntervalEntryController($scope){$scope.okCallback=null;$scope.close=null;$scope.interval={millisec:"",seconds:"",minutes:""};$scope.doInitialize=function(dialog){$scope.okCallback=dialog.config.okCallback;$scope.close=dialog.close};$scope.doClose=function(ok){if(ok)$scope.okCallback($scope.interval);$scope.close()}};function MapFlowsController($scope,dialogService,restService){$scope.endpointName=null;$scope.engineURI=null;$scope.designer=null;$scope.zoomslider=null;$scope.selectionExpr=null;$scope.showAbstract=true;$scope.showName=false;$scope.showExpression=false;$scope.statements=null;$scope.engineInfo=null;$scope.displayAll=null;$scope.images=null;$scope.doZoom=function(evt,ui){$scope.designer.scaleTo(ui.value)};$scope.doSelectedStatement=function(statementName){var dialogConfig={endpointName:$scope.endpointName,
engineURI:$scope.engineURI,statementName:statementName};dialogService.getOpenDialogCallback()(HQ_DIALOG.STATEMENTDETAIL,dialogConfig)};$scope.doSelectedEventtype=function(eventTypeName){var dialogConfig={endpointName:$scope.endpointName,engineURI:$scope.engineURI,eventTypeName:eventTypeName};dialogService.getOpenDialogCallback()(HQ_DIALOG.EVENTTYPEDETAIL,dialogConfig)};$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;var canvas=
HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"canvas_div")[0];$scope.designer=new Designer(canvas,$scope.doSelectedStatement,$scope.doSelectedEventtype);$scope.zoomslider=HQJqueryUtil.findElementById(dialog.root,"zoomslider_div").slider({min:0.3,value:1,max:5,step:0.1,change:$scope.doZoom});HQImageLoader.loadImages({edit:"assets/edit.png",edit_hi:"assets/edit_hi.png"},$scope.imagesLoaded)};$scope.imagesLoaded=function(images){$scope.images=images};$scope.doGet=function(all){$scope.displayAll=
all;$scope.doRefresh()};$scope.doOpenCriteria=function(){var callback=function(expression){$scope.selectionExpr=expression;$scope.$apply()};dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_STMTSELECTION,{okCallback:callback})};$scope.doRefresh=function(){var handle=function(responseStmt){$scope.statements=responseStmt.statements;var handleEngineInfo=function(responseEngine){$scope.engineInfo=responseEngine;draw($scope.statements,$scope.engineInfo)};restService.fetchEngine($scope.endpointName,
$scope.engineURI,handleEngineInfo)};restService.fetchStatements($scope.endpointName,$scope.engineURI,$scope.selectionExpr,$scope.displayAll,true,handle)};$scope.doUpdateShow=function(){draw($scope.statements,$scope.engineInfo)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-stmtmap")};var draw=function(statements,engineInfo){var namedWindows=engineInfo.namedWindows;var tables=engineInfo.tables;var contentItems=ContentBuilder.build(statements,namedWindows,tables);$scope.designer.clear();
var contentNumMap={};var i,j;var boxes=[];var contentItem;var boxConfig={showExpression:$scope.showExpression,showName:$scope.showName,showAbstract:$scope.showAbstract};for(i=0;i<contentItems.length;i++){contentItem=contentItems[i];var box=$scope.designer.addBox(contentItem,boxConfig,$scope.images);contentNumMap[contentItem.contentNum]=box;boxes.push(box)}var layoutItems=DesignerLayoutBuilder.analyzeLayout(boxes);var layoutItem;for(i=0;i<layoutItems.length;i++){layoutItem=layoutItems[i];layoutItem.panel.setX(layoutItem.x);
layoutItem.panel.setY(layoutItem.y)}for(i=0;i<contentItems.length;i++){contentItem=contentItems[i];var fromContentNum=contentItem.contentNum;var fromBox=contentNumMap[fromContentNum];var toBox;var contentNumLink;for(j=0;j<contentItem.links.outStreams().length;j++){contentNumLink=contentItem.links.outStreams()[j];toBox=contentNumMap[contentNumLink];$scope.designer.addLine(fromBox,toBox,0)}for(j=0;j<contentItem.links.outUpdates().length;j++){contentNumLink=contentItem.links.outUpdates()[j];toBox=contentNumMap[contentNumLink];
$scope.designer.addLine(fromBox,toBox,1072284)}for(j=0;j<contentItem.links.outSelects().length;j++){contentNumLink=contentItem.links.outSelects()[j];toBox=contentNumMap[contentNumLink];$scope.designer.addLine(fromBox,toBox,1072284)}}$scope.designer.update()}}var ContentItemType={"CREATE_INFRA":1,"EVENT_TYPE":2,"CREATE_VAR":3,"STATEMENT":4,"CREATE_SCHEMA":5,"CREATE_INDEX":6};function ContentBuilder(){}
ContentBuilder.build=function(statements,namedWindows,tables){var boxesArray=[];var contentNum=0;var innerBox;var infraName;var i,j,k;var analysisResults=[];for(i=0;i<statements.length;i++){var stmt=statements[i];var model=stmt.soda;var analysisResult=SODAAnalyzer.analyzeModel(model,namedWindows,tables);analysisResults.push(analysisResult);var type;if(model.createWindow!=null||model.createTable!=null)type=ContentItemType.CREATE_INFRA;else if(model.createVariable!=null)type=ContentItemType.CREATE_VAR;
else if(model.createSchema!=null)type=ContentItemType.CREATE_SCHEMA;else if(model.createIndex!=null)type=ContentItemType.CREATE_INDEX;else type=ContentItemType.STATEMENT;var detailText=SODAAnalyzer.summarizeModel(model);var designBox=new ContentItem(contentNum,type,analysisResult.producedStreams,stmt,model,analysisResult,detailText);contentNum++;boxesArray.push(designBox)}var baseTypes=[];var index;var result;var key;for(i=0;i<analysisResults.length;i++){result=analysisResults[i];for(key in result.dependentStreams){index=
baseTypes.indexOf(key);if(index==-1)baseTypes.push(key)}}for(i=0;i<namedWindows.length;i++){var namedWindow=namedWindows[i];index=baseTypes.indexOf(namedWindow);if(index!=-1)baseTypes.splice(index,1)}for(i=0;i<tables.length;i++){var table=tables[i];index=baseTypes.indexOf(table);if(index!=-1)baseTypes.splice(index,1)}for(i=0;i<analysisResults.length;i++){result=analysisResults[i];for(key in result.producedStreams){index=baseTypes.indexOf(key);if(index!=-1)baseTypes.splice(index,1)}}baseTypes.sort();
for(i=0;i<baseTypes.length;i++){var baseType=baseTypes[i];var detailTextType="Event Type "+baseType;var types={};types[baseType]=baseType;var typeDesignBox=new ContentItem(contentNum,ContentItemType.EVENT_TYPE,types,{eventTypeName:baseType},null,null,detailTextType);contentNum++;boxesArray.push(typeDesignBox)}for(i=0;i<boxesArray.length;i++){var currentBox=boxesArray[i];if(currentBox.analysisResult==null)continue;for(key in currentBox.analysisResult.dependentStreams){var dependentType=key;for(k=0;k<
boxesArray.length;k++){innerBox=boxesArray[k];var isDependent=false;for(var providedType in innerBox.typesProvided)if(dependentType==providedType){isDependent=true;break}if(isDependent){innerBox.links.addOutStream(currentBox.contentNum);currentBox.links.addInStream(innerBox.contentNum)}}}if(currentBox.analysisResult.insertedIntoInfra!=null){infraName=currentBox.analysisResult.insertedIntoInfra;for(k=0;k<boxesArray.length;k++){innerBox=boxesArray[k];if(innerBox.model!=null&&ContentBuilder.checkIsInfra(innerBox.model,
infraName)){innerBox.links.addInStream(currentBox.contentNum);currentBox.links.addOutStream(innerBox.contentNum)}}}if(currentBox.analysisResult.selectedInfra!=null){infraName=currentBox.analysisResult.selectedInfra;for(k=0;k<boxesArray.length;k++){innerBox=boxesArray[k];if(innerBox.model!=null&&ContentBuilder.checkIsInfra(innerBox.model,infraName)){innerBox.links.addOutSelect(currentBox.contentNum);currentBox.links.addInSelect(innerBox.contentNum)}}}if(currentBox.analysisResult.updatedInfra!=null){infraName=
currentBox.analysisResult.updatedInfra;for(k=0;k<boxesArray.length;k++){innerBox=boxesArray[k];if(innerBox.model!=null&&ContentBuilder.checkIsInfra(innerBox.model,infraName)){innerBox.links.addOutUpdate(currentBox.contentNum);currentBox.links.addInUpdate(innerBox.contentNum)}}}}return boxesArray};ContentBuilder.checkIsInfra=function(model,infraName){if(model.createWindow!=null&&model.createWindow.windowName==infraName)return true;return model.createTable!=null&&model.createTable.tableName==infraName};
function SODAAnalysisResult(){this.dependentStreams={};this.producedStreams={};this.updatedInfra=null;this.selectedInfra=null;this.insertedIntoInfra=null;var addAll=function(input,target){for(var key in input)target[key]=key};this.addDependentStream=function(name){this.dependentStreams[name]=name};this.addProducedStream=function(name){this.producedStreams[name]=name};this.addOther=function(other){addAll(other.dependentStreams,this.dependentStreams);addAll(other.producedStreams,this.producedStreams)}}
function ContentItem(contentNum,type,typesProvided,desc,model,analysisResult,detail){this.contentNum=contentNum;this.type=type;this.typesProvided=typesProvided;this.links=new ContentItemLinks;this.desc=desc;this.model=model;this.analysisResult=analysisResult;this.detail=detail}
function ContentItemLinks(){var _inAll=[];var _outAll=[];var _inStream=[];var _outStream=[];var _inUpdate=[];var _outUpdate=[];var _inSelect=[];var _outSelect=[];this.inAll=function(){return _inAll};this.outAll=function(){return _outAll};this.inStreams=function(){return _inStream};this.outStreams=function(){return _outStream};this.inUpdates=function(){return _inUpdate};this.outUpdates=function(){return _outUpdate};this.inSelects=function(){return _inSelect};this.outSelects=function(){return _outSelect};
this.addInStream=function(num){_inStream.push(num);_inAll.push(num)};this.addOutStream=function(num){_outStream.push(num);_outAll.push(num)};this.addInUpdate=function(num){_inUpdate.push(num);_inAll.push(num)};this.addOutUpdate=function(num){_outUpdate.push(num);_outAll.push(num)};this.addInSelect=function(num){_inSelect.push(num);_inAll.push(num)};this.addOutSelect=function(num){_outSelect.push(num);_outAll.push(num)}}function SODAAnalyzer(){}
SODAAnalyzer.analyzeModelInternal=function(model,namedWindows,tables,result){var i,j,k;var expressions=SODAAnalyzer.collectExpressions(model);var collectorSubquery=function(expression){if(expression.hasOwnProperty("model"))SODAAnalyzer.analyzeModelInternal(expression.model,namedWindows,tables,result)};for(i=0;i<expressions.length;i++){var expr=expressions[i];SODAAnalyzer.traverseExpressionRecursive(expr,collectorSubquery)}if(model.createWindow!=null){result.addProducedStream(model.createWindow.windowName);
return}if(model.updateClause!=null)result.addDependentStream(model.updateClause.eventType);if(model.createIndex!=null)return;if(model.createSchema!=null)return;if(model.onExpr!=null){if(model.onExpr.hasOwnProperty("windowName")){result.updatedInfra=model.onExpr.windowName;result.selectedInfra=model.onExpr.windowName}if(model.onExpr.hasOwnProperty("items"))for(i=0;i<model.onExpr.items.length;i++){var item=model.onExpr.items[i];result.addProducedStream(item.insertInto.streamName)}}if(model.insertInto!=
null){var isInfra;for(i=0;i<namedWindows.length;i++){var namedWindow=namedWindows[i];if(model.insertInto.streamName==namedWindow)isInfra=true}for(i=0;i<tables.length;i++){var table=tables[i];if(model.insertInto.streamName==table)isInfra=true}if(isInfra)result.insertedIntoInfra=model.insertInto.streamName;else result.addProducedStream(model.insertInto.streamName)}if(model.intoTable)result.insertedIntoInfra=model.intoTable.tableName;if(model.fromClause!=null)for(i=0;i<model.fromClause.streams.length;i++){var stream=
model.fromClause.streams[i];if(stream.hasOwnProperty("filter")){var filterStream=stream;if(filterStream.filter!=null)if(SODAAnalyzer.findNameAmongNames(filterStream.filter.eventTypeName,tables))result.selectedInfra=filterStream.filter.eventTypeName;else result.addDependentStream(filterStream.filter.eventTypeName)}if(stream.hasOwnProperty("expression")){var patternStream=stream;var collectorFilterType=function(patternExpr){if(patternExpr.hasOwnProperty("filter")){var filter=patternExpr;result.addDependentStream(filter.filter.eventTypeName)}};
SODAAnalyzer.traversePatternRecursive(patternStream.expression,collectorFilterType)}}};
SODAAnalyzer.collectExpressions=function(model){var expressions=[];var i,j,k;if(model.updateClause!=null){if(model.updateClause.optionalWhereClause!=null)expressions.push(model.updateClause.optionalWhereClause);if(model.updateClause.assignments!=null)for(i=0;i<model.updateClause.assignments.length;i++){var pair=model.updateClause.assignments[i];expressions.push(pair.value)}}if(model.onExpr!=null){if(model.onExpr.hasOwnProperty("items")){var onSplit=model.onExpr;for(i=0;i<onSplit.items.length;i++){var item=
onSplit.items[i];if(item.selectClause!=null)for(j=0;j<item.selectClause.length;j++){var selement=item.selectClause[0];if(selement.hasOwnProperty("expression"))expressions.push(selement.expression)}if(item.whereClause!=null)expressions.push(item.whereClause)}}if(model.onExpr.hasOwnProperty("assignments")){var onSet=model.onExpr;for(i=0;i<onSet.assignments.length;i++){var aitem=onSet.assignments[i];expressions.push(aitem.value)}}if(model.onExpr.hasOwnProperty("matchItems")){var onMerge=model.onExpr;
for(i=0;i<onMerge.matchItems.length;i++){var itemObj=onMerge.matchItems[i];if(itemObj.optionalCondition!=null)expressions.push(itemObj.optionalCondition);for(j=0;j<itemObj.actions.length;j++){var actionObj=itemObj.actions[j];if(actionObj.whereClause!=null)expressions.push(actionObj.whereClause);if(actionObj.hasOwnProperty("selectList"))for(k=0;k<actionObj.selectList.length;k++){var selectObj=actionObj.selectList[k];if(selectObj.hasOwnProperty("expression"))expressions.push(selectObj.expression)}else if(actionObj.hasOwnProperty("assignments"))for(k=
0;k<actionObj.assignments.length;k++){var mrgUpd=actionObj.assignments[k];expressions.push(mrgUpd.value)}}}}}if(model.selectClause!=null)for(i=0;i<model.selectClause.selectList.length;i++){var selectItem=model.selectClause.selectList[i];if(selectItem.hasOwnProperty("expression"))expressions.push(selectItem.expression)}if(model.fromClause!=null)for(i=0;i<model.fromClause.streams.length;i++){var stream=model.fromClause.streams[i];if(stream.hasOwnProperty("filter"))if(stream.filter!=null&&stream.filter.filter!=
null)expressions.push(stream.filter.filter);if(stream.hasOwnProperty("expression")){var collectorFilterType=function(patternExpr){if(patternExpr.hasOwnProperty("filter"))expressions.push(patternExpr.filter.filter)};SODAAnalyzer.traversePatternRecursive(stream.expression,collectorFilterType)}}if(model.whereClause!=null)expressions.push(model.whereClause);if(model.groupByClause!=null)for(i=0;i<model.groupByClause.groupByExpressions.length;i++){var groupByExpr=model.groupByClause.groupByExpressions[i];
expressions.push(groupByExpr)}if(model.havingClause!=null)expressions.push(model.havingClause);if(model.outputLimitClause!=null){if(model.outputLimitClause.whenExpression!=null)expressions.push(model.outputLimitClause.whenExpression);if(model.outputLimitClause.thenAssignments!=null)for(i=0;i<model.outputLimitClause.thenAssignments;i++){var thenAssign=model.outputLimitClause.thenAssignments[i];expressions.push(thenAssign.value)}}if(model.orderByClause!=null)for(i=0;i<model.orderByClause.orderByExpressions.length;i++){var orderByElement=
model.orderByClause.orderByExpressions[i];expressions.push(orderByElement.expression)}if(model.matchRecognizeClause!=null){if(model.matchRecognizeClause.partitionExpressions!=null)for(i=0;i<model.matchRecognizeClause.partitionExpressions.length;i++){var partitionExpr=model.matchRecognizeClause.partitionExpressions[i];expressions.push(partitionExpr)}for(i=0;i<model.matchRecognizeClause.measures.length;i++){var selectItemMR=model.matchRecognizeClause.measures[i];if(selectItemMR.hasOwnProperty("expression"))expressions.push(selectItemMR.expression)}for(i=
0;i<model.matchRecognizeClause.defines;i++){var define=model.matchRecognizeClause.defines[i];expressions.push(define.expression)}}return expressions};SODAAnalyzer.traverseExpressionRecursive=function(expression,collectorFunction){if(expression==null)return;collectorFunction(expression);if(expression.children==null)return;for(var i=0;i<expression.children.length;i++){var child=expression.children[i];SODAAnalyzer.traverseExpressionRecursive(child,collectorFunction)}};
SODAAnalyzer.traversePatternRecursive=function(patternExpr,collectorFunction){collectorFunction(patternExpr);if(patternExpr.children==null)return;for(var i=0;i<patternExpr.children.length;i++){var child=patternExpr.children[i];SODAAnalyzer.traversePatternRecursive(child,collectorFunction)}};SODAAnalyzer.analyzeModel=function(model,namedWindows,tables){var result=new SODAAnalysisResult;SODAAnalyzer.analyzeModelInternal(model,namedWindows,tables,result);return result};
SODAAnalyzer.summarizeModel=function(model){var delimiter="";var result="";if(model.createContext!=null)return"Create Context "+model.createContext.contextName;if(model.createDataFlow!=null)return"Create Dataflow "+model.createDataFlow.dataFlowName;if(model.createExpression!=null)if(model.createExpression.hasOwnProperty("expressionDeclaration"))return"Create Expression "+model.createExpression.expressionDeclaration.name;else return"Create Script "+model.createExpression.scriptExpression.name;if(model.createWindow!=
null)return"Named Window "+model.createWindow.windowName;if(model.createTable!=null)return"Table "+model.createTable.tableName;if(model.createVariable!=null)return"Create Variable "+model.createVariable.variableName;if(model.updateClause!=null)return"Update IStream "+model.updateClause.eventType;if(model.createSchema!=null)return"Create Schema "+model.createSchema.schemaName;if(model.createIndex!=null)return"Create Index "+model.createIndex.indexName;if(model.onExpr!=null){if(model.onExpr.hasOwnProperty("assignments")&&
model.onExpr.hasOwnProperty("windowName"))return"On "+SODAAnalyzer.summarizeModelFrom(model)+" Update "+model.onExpr.windowName;if(model.onExpr.hasOwnProperty("assignments"))return"On "+SODAAnalyzer.summarizeModelFrom(model)+" Set Variable "+SODAAnalyzer.summarizeVariables(model.onExpr);if(model.onExpr.hasOwnProperty("matchItems"))return"On "+SODAAnalyzer.summarizeModelFrom(model)+" Merge "+model.onExpr.windowName;if(model.onExpr.hasOwnProperty("items")){var names="";delimiter="";if(model.insertInto!=
null){names+=model.insertInto.streamName;delimiter=", "}var onSplit=model.onExpr;for(var i=0;i<onSplit.items.length;i++){var item=onSplit.items[i];names+=delimiter+item.insertInto.streamName;delimiter=", "}result="On "+SODAAnalyzer.summarizeModelFrom(model)+" Split/Insert Into "+names;return result}if(model.onExpr.hasOwnProperty("windowName")&&model.onExpr.hasOwnProperty("deleteAndSelect"))return"On "+SODAAnalyzer.summarizeModelFrom(model)+" Select From "+model.onExpr.windowName;if(model.onExpr.hasOwnProperty("windowName"))return"On "+
SODAAnalyzer.summarizeModelFrom(model)+" Delete From "+model.onExpr.windowName}delimiter="";if(model.insertInto!=null){result+="Insert Into "+model.insertInto.streamName;delimiter=" "}result+=delimiter+"Select";delimiter=" ";if(model.selectClause.selectList.length==1&&!model.selectClause.selectList[0].hasOwnProperty("streamName")&&!model.selectClause.selectList[0].hasOwnProperty("expression"))result+=delimiter+"*";else result+=delimiter+"...";result+=delimiter+" From "+SODAAnalyzer.summarizeModelFrom(model);
return result};SODAAnalyzer.summarizeVariables=function(onSetClause){var variables={};for(var i=0;i<onSetClause.assignments.length;i++){var pair=onSetClause.assignments[i];variables[pair.name]=pair.name}var delimiter="";var result="";for(var variable in variables){result+=delimiter+variable;delimiter+=", "}return result};
SODAAnalyzer.summarizeModelFrom=function(model){var fromClause="";var delimiter="";if(model.fromClause==null||model.fromClause.streams==null)return"";for(var i=0;i<model.fromClause.streams.length;i++){var stream=model.fromClause.streams[i];if(stream.hasOwnProperty("filter"))if(stream.filter!=null){fromClause+=delimiter+stream.filter.eventTypeName;delimiter+=", "}if(stream.hasOwnProperty("expression")){fromClause+="pattern[...]";delimiter+=", "}if(stream.hasOwnProperty("databaseName")){fromClause+=
"sql[...]";delimiter+=", "}if(stream.hasOwnProperty("className")){fromClause+="method[...]";delimiter+=", "}}return fromClause};SODAAnalyzer.findNameAmongNames=function(name,names){for(var i=0;i<names.length;i++)if(name==names[i])return true;return false};
function Designer(canvas,selectedStatementCallback,selectedEventtypeCallback){var stage=new createjs.Stage(canvas);stage.enableMouseOver(10);var update=false;var boxes=[];var lines=[];var linesPerBoxContainerId={};var containerPerContainerId={};createjs.Ticker.setFPS(60);function tick(event){if(update){update=false;stage.update(event)}}createjs.Ticker.addEventListener("tick",tick);var updateCallback=function(){update=true};var redoLines=function(containerId){var lines=linesPerBoxContainerId[containerId];
for(var i=0;i<lines.length;i++)lines[i].redraw()};this.scaleTo=function(value){stage.scaleX=value;stage.scaleY=value;update=true};var pressHandler=function(e){var container=containerPerContainerId[e.target.id];var offsetX=e.stageX-container.x;var offsetY=e.stageY-container.y;e.addEventListener("mousemove",function(ev){container.x=ev.stageX-offsetX;container.y=ev.stageY-offsetY;redoLines(e.target.id);update=true})};this.clear=function(){stage.removeAllChildren();update=true;boxes=[]};this.addBox=function(contentItem,
boxConfig,images){var box=new StatementPanel(contentItem,stage,pressHandler,boxConfig,images,updateCallback,selectedStatementCallback,selectedEventtypeCallback);var draggableContainerId=box.getDraggableContainerId();var topContainer=box.getContainer();linesPerBoxContainerId[draggableContainerId]=[];containerPerContainerId[draggableContainerId]=topContainer;boxes.push(box);return box};this.addLine=function(fromBox,toBox,color){var line=new ConnectorLine(fromBox,toBox,color,stage);lines.push(line);
linesPerBoxContainerId[fromBox.getDraggableContainerId()].push(line);linesPerBoxContainerId[toBox.getDraggableContainerId()].push(line);return line};this.update=function(){stage.update()}}
function ConnectorLine(fromBox,toBox,color,stage){var lineWArrow=new LineWArrow(fromBox.getX,fromBox.getY,fromBox.getWidth,fromBox.getHeight,toBox.getX,toBox.getY,toBox.getWidth,toBox.getHeight);var g=new createjs.Graphics;lineWArrow.draw(g);var line=new createjs.Shape(g);line.x=0;line.y=0;line.snapToPixel=true;stage.addChild(line);this.redraw=function(){lineWArrow.draw(g)}}
function StatementPanel(contentItem,stage,pressHandler,boxConfig,images,updateStageCallback,selectedStatementCallback,selectedEventtypeCallback){var textList=[];if(boxConfig.showAbstract)textList.push(contentItem.detail);if(boxConfig.showName)if(contentItem.desc!=null)textList.push(contentItem.desc.statementName);if(boxConfig.showExpression)if(contentItem.desc!=null)if(contentItem.desc.eplNoAnnotation==null)textList.push(contentItem.desc.epl);else textList.push(contentItem.desc.eplNoAnnotation);if(textList.length==
0)textList.push(contentItem.detail);var textBoundedContainer=HQEaselUtil.makeTextbox(textList);textBoundedContainer.container.addEventListener("mousedown",pressHandler);textBoundedContainer.name=contentItem.contentNum;var draggableContainerId=textBoundedContainer.container.id;var img=new createjs.Bitmap(images["edit"]);img.x=textBoundedContainer.width-images["edit"].width;img.y=textBoundedContainer.height-images["edit"].height-5;img.addEventListener("mouseover",function(){img.image=images["edit_hi"];
updateStageCallback()});img.addEventListener("mouseout",function(){img.image=images["edit"];updateStageCallback()});img.addEventListener("mousedown",function(){if(contentItem.type==ContentItemType.EVENT_TYPE)selectedEventtypeCallback(contentItem.desc.eventTypeName);else selectedStatementCallback(contentItem.desc.statementName)});var panelContainer=new createjs.Container;panelContainer.addChild(textBoundedContainer.container);panelContainer.addChild(img);panelContainer.x=10;panelContainer.y=10;panelContainer.name=
contentItem.contentNum;stage.addChild(panelContainer);var panelBoundedContainer=new HQEaselContainer(panelContainer,textBoundedContainer.width,textBoundedContainer.height);this.contentItem=contentItem;this.getDraggableContainerId=function(){return draggableContainerId};this.getContainer=function(){return panelBoundedContainer.container};this.getWidth=function(){return panelBoundedContainer.width};this.getHeight=function(){return panelBoundedContainer.height};this.getX=function(){return panelBoundedContainer.container.x};
this.getY=function(){return panelBoundedContainer.container.y};this.setX=function(x){panelBoundedContainer.container.x=x};this.setY=function(y){panelBoundedContainer.container.y=y}}function DesignerLayoutState(x,y){this.x=x;this.y=y}function DesignerLayoutItem(x,y,panel){this.x=x;this.y=y;this.panel=panel}function DesignerLayoutBuilder(){}
DesignerLayoutBuilder.analyzeLayout=function(allPanels){var layoutItems=[];var panelsByContentNum={};var panelItem;var i,j,height;for(i=0;i<allPanels.length;i++){panelItem=allPanels[i];panelsByContentNum[panelItem.contentItem.contentNum]=panelItem}var groupables=[];for(i=0;i<allPanels.length;i++){panelItem=allPanels[i];var groupable={};groupable["id"]=panelItem.contentItem.contentNum;var groupableLinks=[];groupableLinks=groupableLinks.concat(panelItem.contentItem.links.inAll());groupableLinks=groupableLinks.concat(panelItem.contentItem.links.outAll());
groupable["dependencies"]=groupableLinks;groupables.push(groupable)}var groups=HQCollectionUtil.getGroups(groupables);var state=new DesignerLayoutState(5,10);for(i=0;i<groups.length;i++){var group=groups[i];var panels=[];for(j=0;j<group.length;j++){var id=group[j];panels.push(panelsByContentNum[id])}var createNamedWindows=DesignerLayoutBuilder.getTypedPanels(panels,ContentItemType.CREATE_INFRA);if(createNamedWindows!=null&&createNamedWindows.length!=0){state.x=100;for(j=0;j<createNamedWindows.length;j++){var createNamedWindow=
createNamedWindows[j];layoutItems.push(new DesignerLayoutItem(state.x,state.y,createNamedWindow));DesignerLayoutBuilder.removePanel(createNamedWindow,panels);state.x=state.x+createNamedWindow.getWidth()+50;height=createNamedWindow.getHeight()}state.y+=height+25}DesignerLayoutBuilder.process(panels,panelsByContentNum,ContentItemType.EVENT_TYPE,state,layoutItems);DesignerLayoutBuilder.process(panels,panelsByContentNum,ContentItemType.CREATE_VAR,state,layoutItems);DesignerLayoutBuilder.process(panels,
panelsByContentNum,ContentItemType.CREATE_SCHEMA,state,layoutItems);DesignerLayoutBuilder.process(panels,panelsByContentNum,ContentItemType.CREATE_INDEX,state,layoutItems);DesignerLayoutBuilder.process(panels,panelsByContentNum,ContentItemType.STATEMENT,state,layoutItems)}return layoutItems};DesignerLayoutBuilder.removePanel=function(panel,remainingPanels){var index=remainingPanels.indexOf(panel);if(index!=-1){remainingPanels.splice(index,1);return true}return false};
DesignerLayoutBuilder.process=function(remainingPanels,panelsByContentNum,type,state,layoutItems){state.x=10;var agendaPanels=DesignerLayoutBuilder.getTypedPanels(remainingPanels,type);if(type==ContentItemType.STATEMENT)agendaPanels=DesignerLayoutBuilder.reorderPanelItems(agendaPanels);for(var i=0;i<agendaPanels.length;i++){var panelItem=agendaPanels[i];var removed=DesignerLayoutBuilder.removePanel(panelItem,remainingPanels);if(!removed)continue;layoutItems.push(new DesignerLayoutItem(state.x,state.y,
panelItem));var nextX=state.x+panelItem.getWidth()+50;var nextState=new DesignerLayoutState(nextX,state.y);var addHeight=DesignerLayoutBuilder.traverseOutgoingLinksRecursive(remainingPanels,panelsByContentNum,nextState,panelItem,layoutItems);state.y=state.y+Math.max(panelItem.getHeight(),addHeight)+5}};
DesignerLayoutBuilder.traverseOutgoingLinksRecursive=function(remainingPanels,panelsByContentNum,state,currentPanel,layoutItems){if(currentPanel.contentItem.links.outStreams()==null)return 0;var addedHeight=0;var first=true;for(var i=0;i<currentPanel.contentItem.links.outStreams().length;i++){var contentNum=currentPanel.contentItem.links.outStreams()[i];var outgoingItem=panelsByContentNum[contentNum];var removed=DesignerLayoutBuilder.removePanel(outgoingItem,remainingPanels);if(!removed)continue;
layoutItems.push(new DesignerLayoutItem(state.x,state.y,outgoingItem));var nextX=state.x+outgoingItem.getWidth()+50;var nextState=new DesignerLayoutState(nextX,state.y);var dependentAddedHeight=DesignerLayoutBuilder.traverseOutgoingLinksRecursive(remainingPanels,panelsByContentNum,nextState,outgoingItem,layoutItems);addedHeight+=Math.max(outgoingItem.getHeight(),dependentAddedHeight);if(!first)addedHeight+=5;first=false;state.y=state.y+Math.max(outgoingItem.getHeight(),dependentAddedHeight)+5;state.x=
state.x+20}return addedHeight};DesignerLayoutBuilder.getTypedPanels=function(remainingPanels,type){var result=[];var item;for(var i=0;i<remainingPanels.length;i++){item=remainingPanels[i];if(item.contentItem.type==type)result.push(item)}return result};
DesignerLayoutBuilder.reorderPanelItems=function(panelItems){var panelsByContentNum={};var panelItem;for(var i=0;i<panelItems.length;i++){panelItem=panelItems[i];panelsByContentNum[panelItem.contentItem.contentNum]=panelItem}var items=[];for(i=0;i<panelItems.length;i++){panelItem=panelItems[i];var chainItem={};chainItem["id"]=panelItem.contentItem.contentNum;var chainOutgoingLinks=[];chainOutgoingLinks=chainOutgoingLinks.concat(panelItem.contentItem.links.outStreams());chainItem["dependencies"]=chainOutgoingLinks;
items.push(chainItem)}var ordered=HQCollectionUtil.getOrderedByDepth(items);var result=[];for(i=0;i<ordered.length;i++)result.push(panelsByContentNum[ordered[i]]);return result};
function LineWArrow(fFromX,fFromY,fFromWidth,fFromHeight,fToX,fToY,fToWidth,fToHeight){var x1,x2,y1,y2;var arrowWidth=4;var arrowHeight=8;this.draw=function(g){calculateCoordinate();g.clear();g.setStrokeStyle(1);g.beginStroke("black");g.moveTo(x1,y1);g.lineTo(x2,y2);g.setStrokeStyle(2);g.beginStroke("black");g.moveTo(x1,y1);g.lineTo(x2,y2);createArrow(g)};var createArrow=function(g){var angle=Math.atan2(y2-y1,x2-x1);g.lineTo(x2-arrowHeight*Math.cos(angle)-arrowWidth*Math.sin(angle),y2-arrowHeight*
Math.sin(angle)+arrowWidth*Math.cos(angle));g.lineTo(x2,y2);g.lineTo(x2-arrowHeight*Math.cos(angle)+arrowWidth*Math.sin(angle),y2-arrowHeight*Math.sin(angle)-arrowWidth*Math.cos(angle))};var calculateCoordinate=function(){var drawDirection=getDrawDirection();var fromX=fFromX();var fromY=fFromY();var fromWidth=fFromWidth();var fromHeight=fFromHeight();var toX=fToX();var toY=fToY();var toWidth=fToWidth();var toHeight=fToHeight();var boxFromX2=fromX+fromWidth;var boxFromY2=fromY+fromHeight;var boxToX2=
toX+toWidth;var boxToY2=toY+toHeight;var diffY=0;var diffX=0;if(drawDirection=="BOTTOM"||drawDirection=="TOP"){if(fromX<=toX&&boxFromX2>=boxToX2){diffX=toWidth/2;diffX=toX+diffX}else if(fromX>toX&&boxFromX2>boxToX2){diffX=(boxToX2-fromX)/2;diffX=fromX+diffX}else if(fromX<=toX&&boxFromX2<boxToX2){diffX=(boxFromX2-toX)/2;diffX=toX+diffX}else if(fromX>toX&&boxFromX2<boxToX2){diffX=fromWidth/2;diffX=fromX+diffX}if(diffX==0)diffX=fromX+fromWidth/2}if(drawDirection=="RIGHT"||drawDirection=="LEFT")if(fromY<=
toY&&boxFromY2>=boxToY2){diffY=(boxToY2-toY)/2;diffY=toY+diffY}else if(fromY>toY&&boxFromY2>boxToY2){diffY=(boxToY2-fromY)/2;diffY=fromY+diffY}else if(fromY<=toY&&boxFromY2<boxToY2){diffY=(boxFromY2-toY)/2;diffY=toY+diffY}else if(fromY>toY&&boxFromY2<boxToY2){diffY=fromHeight/2;diffY=fromY+diffY}switch(drawDirection){case "RIGHT_BOTTOM":x1=fromX+diffX;y1=fromY;x2=boxToX2;y2=boxToY2-diffY;break;case "RIGHT_TOP":x1=fromX;y1=boxFromY2-diffY;x2=boxToX2-diffX;y2=toY;break;case "LEFT_BOTTOM":x1=boxFromX2-
diffX;y1=fromY;x2=toX;y2=boxToY2-diffY;break;case "LEFT_TOP":x1=boxFromX2;y1=boxFromY2-diffY;x2=toX+diffX;y2=toY;break;case "RIGHT":x1=fromX;y1=diffY;x2=boxToX2;y2=diffY;break;case "TOP":x1=diffX;y1=boxFromY2;x2=diffX;y2=toY;break;case "BOTTOM":x1=diffX;y1=fromY;x2=diffX;y2=boxToY2;break;case "LEFT":x1=boxFromX2;y1=diffY;x2=toX;y2=diffY;break}};var getDrawDirection=function(){var drawDirection;var fromX=fFromX();var fromY=fFromY();var fromWidth=fFromWidth();var fromHeight=fFromHeight();var toX=fToX();
var toY=fToY();var toWidth=fToWidth();var toHeight=fToHeight();var boxFromX2=fromX+fromWidth;var boxFromY2=fromY+fromHeight;var boxToX2=toX+toWidth;var boxToY2=toY+toHeight;if(fromX>boxToX2&&boxFromY2<toY)drawDirection="RIGHT_TOP";else if(fromX>boxToX2&&fromY>boxToY2)drawDirection="RIGHT_BOTTOM";else if(boxFromX2<toX&&fromY>boxToY2)drawDirection="LEFT_BOTTOM";else if(boxFromX2<toX&&boxFromY2<toY)drawDirection="LEFT_TOP";else if(fromX>boxToX2)drawDirection="RIGHT";else if(boxFromY2<toY)drawDirection=
"TOP";else if(fromY>boxToY2)drawDirection="BOTTOM";else if(boxFromX2<toX)drawDirection="LEFT";return drawDirection}};function NamedWindowBrowseController($scope,restService,dialogService){$scope.endpointName=null;$scope.engineURI=null;$scope.windowTable=null;$scope.namedWindows=null;$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.namedWindows=dialog.config.namedwindows;$scope.windowTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"namedwindowbrowse_listdiv").dataTable(HQTableUtil.getDefaultFullDatatableConfig({}));applyToTable()};
$scope.doRefresh=function(){var cbFetched=function(response){$scope.namedWindows=response;applyToTable()};restService.fetchNamedWindows($scope.endpointName,$scope.engineURI,cbFetched)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-namedwindow")};var applyToTable=function(){var table=$scope.windowTable;var eventTypes=$scope.namedWindows.namedWindows;var myarr=[];for(var i=0;i<eventTypes.length;i++){var row=eventTypes[i];var typeName=row.table==true?"Table":"Named Window";var countStr=
row.count>=0?""+row.count:"";var buttons=row.table==true?"":'\x3cbutton class\x3d"namedwin_type" type\x3d"submit" class\x3d"btn-mini"\x3eEvent Type\x3c/button\x3e';buttons=buttons+'\x3cbutton class\x3d"namedwin_stmt" type\x3d"submit" class\x3d"btn-mini"\x3eStatement\x3c/button\x3e'+'\x3cbutton class\x3d"namedwin_query" type\x3d"submit" class\x3d"btn-mini"\x3eQuery\x3c/button\x3e';myarr.push([row["namedWindowName"],typeName,countStr,""+row["statementName"],""+row["epl"],buttons])}table.fnClearTable();
table.fnAddData(myarr);var nodes=$scope.windowTable.fnGetNodes();for(i=0;i<nodes.length;i++){var node=nodes[i];button=$(node).find("button.namedwin_type");(function(){var thenode=node;button.click(function(){var position=$scope.windowTable.fnGetPosition(thenode);if(position!=null){var windowName=$scope.namedWindows.namedWindows[position].namedWindowName;var dialogConfig={endpointName:$scope.endpointName,engineURI:$scope.engineURI,eventTypeName:windowName};dialogService.getOpenDialogCallback()(HQ_DIALOG.EVENTTYPEDETAIL,
dialogConfig)}})})();button=$(node).find("button.namedwin_stmt");(function(){var thenode=node;button.click(function(){var position=$scope.windowTable.fnGetPosition(thenode);if(position!=null){var statementName=$scope.namedWindows.namedWindows[position].statementName;var dialogConfig={endpointName:$scope.endpointName,engineURI:$scope.engineURI,statementName:statementName};dialogService.getOpenDialogCallback()(HQ_DIALOG.STATEMENTDETAIL,dialogConfig)}})})();button=$(node).find("button.namedwin_query");
(function(){var thenode=node;button.click(function(){var position=$scope.windowTable.fnGetPosition(thenode);if(position!=null){var windowName=$scope.namedWindows.namedWindows[position].namedWindowName;var dialogConfig={endpointName:$scope.endpointName,engineURI:$scope.engineURI,namedWindowName:windowName};dialogService.getOpenDialogCallback()(HQ_DIALOG.ONDEMANDQUERY,dialogConfig)}})})()}}};function OnDemandQueryController($scope,restService){$scope.endpointName=null;$scope.engineURI=null;$scope.editor=null;$scope.eplErrorMsg=null;$scope.maxRows=null;$scope.maxRowsInvalid=false;$scope.resultTable=null;$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;var editorTextarea=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"ondemandquery_editor_div")[0];$scope.editor=CodeMirror.fromTextArea(editorTextarea,HQCodeMirrorUtil.getDefaultConfig());
$scope.tableelement=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"ondemandquery_table");if(dialog.config.namedWindowName!=null)$scope.editor.setValue("select * from "+dialog.config.namedWindowName);else $scope.editor.setValue("\n\n");$scope.editor.setCursor(0,0)};$scope.doCancel=function(){$scope.dialog.close()};$scope.doPerformQuery=function(){$scope.maxRowsInvalid=!HQValidationUtil.validateIntOrBlank($scope.maxRows);if($scope.maxRowsInvalid)return;if($scope.resultTable!=null){$scope.resultTable.fnClearTable();
$scope.resultTable.fnDestroy();$scope.resultTable=null;$scope.tableelement.children(":first").children(":first").empty()}$scope.eplErrorMsg=null;var handleResult=function(response){$scope.resultTable=HQTableUtil.createTableFromPropsAndEvents($scope.tableelement,response.properties,response.events)};var handleError=function(data){$scope.eplErrorMsg=data[0].exceptionMessage};var epl=$scope.editor.getValue();restService.onDemandQuery($scope.endpointName,$scope.engineURI,{"epl":epl,"maxRows":$scope.maxRows},
handleResult,handleError)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-ondemand")}};function ScenarioRunDialogController($scope,restService,dialogService){$scope.endpointName=null;$scope.engineURI=null;$scope.debugDisabled=false;$scope.moduleEditor=null;$scope.sequenceEditor=null;$scope.$stmtoutputtabs_div=null;$scope.$stmtaudittabs_div=null;$scope.scenarioName=null;$scope.scenarioNameRequired=false;$scope.startDate="2001-01-01 08:00:00.000";$scope.startDateErrorMsg="";$scope.level1s=[];$scope.audit="";$scope.perstmtoutput=[];$scope.perstmtaudit=[];$scope.nowprocessing=false;$scope.doInitialize=
function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.debugDisabled=!dialog.config.instrumented;var moduleEditorTextarea=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"scenario_module_editor_div")[0];$scope.moduleEditor=CodeMirror.fromTextArea(moduleEditorTextarea,HQCodeMirrorUtil.getDefaultConfig());var sequenceEditorTextarea=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"scenario_sequence_editor_div")[0];var sequenceEditorConfig=
HQCodeMirrorUtil.getDefaultConfig();sequenceEditorConfig.mode="text/x-esperseq";$scope.sequenceEditor=CodeMirror.fromTextArea(sequenceEditorTextarea,sequenceEditorConfig);$scope.moduleMessages=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"scenario_module_messages_div").dataTable(HQTableUtil.getDefaultPlainDatatableConfig());$scope.sequenceMessages=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"scenario_sequence_messages_div").dataTable(HQTableUtil.getDefaultPlainDatatableConfig());
HQJqueryUtil.findElementById(dialog.root,"scenario_output_tabs").tabs();var handleConfig={handles:"e",e:$(".debugger-resizable-e")};HQJqueryUtil.findElementById(dialog.root,"scenario_statements").resizable(handleConfig);HQJqueryUtil.findElementById(dialog.root,"scenario_sequence").resizable(handleConfig);HQJqueryUtil.findElementById(dialog.root,"scenario_output").resizable(handleConfig);$scope.sequenceEditor.setValue("\n\n");$scope.moduleEditor.setValue("\n\n");$scope.moduleEditor.setCursor(0,0);
$scope.moduleEditor.focus();$scope.$stmtoutputtabs_div=HQJqueryUtil.findElementById(dialog.root,"scenario_stmtoutput_tabs");$scope.$stmtoutputtabs_div.tabs();$scope.$stmtaudittabs_div=HQJqueryUtil.findElementById(dialog.root,"scenario_stmtaudit_tabs");$scope.$stmtaudittabs_div.tabs();$scope.$apply()};$scope.doDebug=function(){$scope.scenarioNameRequired=!HQStringUtil.isPopulated($scope.scenarioName);if($scope.scenarioNameRequired)return;$scope.submitScenario(true,$scope.scenarioName)};$scope.doSubmit=
function(){$scope.submitScenario(false,null)};$scope.submitScenario=function(debug,scenarioName){$scope.level1s=[];$scope.audit="";$scope.dialogMsg="";$scope.nowprocessing=true;$scope.scenarioNameRequired=false;$scope.clearOutput();var cbDone=function(response){$scope.nowprocessing=false;HQCodeMessageUtil.clearMessages($scope.moduleEditor);HQCodeMessageUtil.clearMessages($scope.sequenceEditor);$scope.level1s=response.level1s;$scope.audit=response.auditInfo;$scope.perstmtaudit=response.auditInfoPerStatement;
$scope.perstmtoutput=computePerStatement(response.level1s);setTimeout(function(){$scope.$stmtoutputtabs_div.tabs("refresh");$scope.$stmtoutputtabs_div.tabs({active:0});$scope.$stmtaudittabs_div.tabs("refresh");$scope.$stmtaudittabs_div.tabs({active:0})},1);if(response.traceFileName!=null){var openCB=function(){var config={trace:response.traceFileName};dialogService.getOpenDialogCallback()(HQ_DIALOG.DEBUGGER,config)};var config={message:"Do you want to open the trace file '"+response.traceFileName+
"' ?",okButtonTitle:"Open",okButtonCallback:openCB};dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_CONFIRMALERT,config)}};var cbError=function(details){$scope.nowprocessing=false;var eplFieldName="epl";var seqFieldName="sequence";var msgEPL=HQCollectionUtil.filterArray(details,function(item){return item.fieldName==eplFieldName});HQCodeMessageUtil.setMessages($scope.moduleMessages,$scope.moduleEditor,msgEPL);var msgSeq=HQCollectionUtil.filterArray(details,function(item){return item.fieldName==
seqFieldName});HQCodeMessageUtil.setMessages($scope.sequenceMessages,$scope.sequenceEditor,msgSeq);var other=HQCollectionUtil.filterArray(details,function(item){return item.fieldName!=seqFieldName&&item.fieldName!=eplFieldName});if(other.length!=0)if(other[0].fieldName="startDate")$scope.startDateErrorMsg=other[0].exceptionMessage;else dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_ERRORALERT,{message:other[0].exceptionMessage})};HQCodeMessageUtil.clearGutterAndMessages($scope.moduleEditor,
$scope.moduleMessages);HQCodeMessageUtil.clearGutterAndMessages($scope.sequenceEditor,$scope.sequenceMessages);var scenario={"startDate":$scope.startDate,"epl":$scope.moduleEditor.getValue(),"sequence":$scope.sequenceEditor.getValue()};restService.executeScenarioRun($scope.endpointName,$scope.engineURI,scenario,debug,scenarioName,cbDone,cbError)};$scope.doSaveEPL=function(){var filename="Module1"+"."+HQ_FILETYPE.MODULE.extension;var saveConfig={filename:filename,mode:HQ_FILEDIALOGOPTYPE.SAVE,body:$scope.moduleEditor.getValue(),
filetype:HQ_FILETYPE.MODULE};dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_FILESAVELOAD,saveConfig)};$scope.doLoadEPL=function(){var loadCallback=function(content){HQCodeMessageUtil.clearGutterAndMessages($scope.moduleEditor,$scope.moduleMessages);$scope.clearOutput();$scope.moduleEditor.setValue(content.body)};var config={mode:HQ_FILEDIALOGOPTYPE.LOAD,filetype:HQ_FILETYPE.MODULE,loadCallback:loadCallback};dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_FILESAVELOAD,config)};$scope.doSaveSequence=
function(){var filename="Sequence1"+"."+HQ_FILETYPE.SEQUENCE.extension;var saveConfig={filename:filename,mode:HQ_FILEDIALOGOPTYPE.SAVE,body:$scope.sequenceEditor.getValue(),filetype:HQ_FILETYPE.SEQUENCE};dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_FILESAVELOAD,saveConfig)};$scope.doLoadSequence=function(){var loadCallback=function(content){HQCodeMessageUtil.clearGutterAndMessages($scope.sequenceEditor,$scope.sequenceMessages);$scope.clearOutput();$scope.sequenceEditor.setValue(content.body)};
var config={mode:HQ_FILEDIALOGOPTYPE.LOAD,filetype:HQ_FILETYPE.SEQUENCE,loadCallback:loadCallback};dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_FILESAVELOAD,config)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-createscenario")};$scope.clearOutput=function(){$scope.level1s=[];$scope.audit="";$scope.perstmtoutput=[];$scope.perstmtaudit=[];$scope.startDateErrorMsg=""};var computePerStatement=function(level1s){if(level1s==null||level1s.length==0)return[];var perstmt={};
for(var i=0;i<level1s.length;i++){var level1=level1s[i];var level2s=level1.level2s;for(var j=0;j<level2s.length;j++){var level2=level2s[j];var stmtName=level2s[j].statementName;var level1sStmt=perstmt[stmtName];if(level1sStmt==null){level1sStmt=[];perstmt[stmtName]=level1sStmt}var newLevel1={date:level1.date,level3s:level2.level3s};level1sStmt.push(newLevel1)}}var rows=[];for(var key in perstmt)if(perstmt.hasOwnProperty(key))rows.push({statementName:key,level1s:perstmt[key]});rows.sort(function(a,
b){if(a.statementName<b.statementName)return-1;if(a.statementName>b.statementName)return 1;return 0});return rows}};function SequenceExecBrowseController($scope,dialogService,restService){$scope.endpointName=null;$scope.engineURI=null;$scope.sequenceTable=null;$scope.sequences=null;$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.sequences=dialog.config.sequences;$scope.sequenceTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"sequences_div").dataTable(HQTableUtil.getDefaultFullDatatableConfig({}));$scope.sequenceTable.delegate("tr",
"click",function(){var rownum=$scope.sequenceTable.fnGetPosition(this);if(rownum!=null){var selected=$scope.sequences.sequenceExecutions[rownum];var dialogConfig={endpointName:$scope.endpointName,engineURI:$scope.engineURI,sequenceExecutionName:selected.sequenceExecutionName};dialogService.getOpenDialogCallback()(HQ_DIALOG.SEQUENCEEXECDETAIL,dialogConfig)}});applyTable($scope.sequenceTable,$scope.sequences.sequenceExecutions)};$scope.doNew=function(dialog){var dialogConfig={endpointName:$scope.endpointName,
engineURI:$scope.engineURI};dialogService.getOpenDialogCallback()(HQ_DIALOG.SEQUENCEEXECCREATE,dialogConfig)};$scope.doRefresh=function(dialog){var cbFetched=function(response){$scope.sequences=response;applyTable($scope.sequenceTable,$scope.sequences.sequenceExecutions)};restService.fetchSequenceExecutions($scope.endpointName,$scope.engineURI,cbFetched)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-sequence")};var applyTable=function(table,sequences){var myarr=[];for(var i=0;i<
sequences.length;i++){var row=sequences[i];myarr.push([row["sequenceExecutionName"],row["description"],HQStringUtil.emptyString(row["state"])])}table.fnClearTable();table.fnAddData(myarr)}};function SequenceExecCreateController($scope,dialogService,restService){$scope.endpointName=null;$scope.engineURI=null;$scope.sequence={sequenceExecutionName:"",description:"",loop:""};$scope.editor=null;$scope.eventTypes=[];$scope.eventType=null;$scope.closeDialogFunc=null;$scope.messagesTable=null;$scope.sequenceErrorMsg=null;$scope.doInitialize=function(dialog){$scope.closeDialogFunc=dialog.close;$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;var editorTextarea=
HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"sequencecreate_editor_div")[0];var sequenceEditorConfig=HQCodeMirrorUtil.getDefaultConfig();sequenceEditorConfig.mode="text/x-esperseq";$scope.editor=CodeMirror.fromTextArea(editorTextarea,sequenceEditorConfig);$scope.messagesTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"sequencemessages_div").dataTable(HQTableUtil.getDefaultPlainDatatableConfig());if(dialog.config.sequence){$scope.sequence=dialog.config.sequence;$scope.editor.setValue($scope.sequence.sequence)}else $scope.editor.setValue("\n\n");
$scope.editor.setCursor(0,0);$scope.doRefreshTypes();$scope.$apply()};$scope.doRefreshTypes=function(){var cbFetchedTypes=function(response){$scope.eventTypes=response.eventTypes};restService.fetchEventTypes($scope.endpointName,$scope.engineURI,true,cbFetchedTypes)};$scope.clearMessages=function(){HQCodeMessageUtil.clearGutterAndMessages($scope.editor,$scope.messagesTable);$scope.sequenceErrorMsg=null};$scope.doValidate=function(start){$scope.clearMessages();if(!validateExpressionLocal())return;var cbDone=
function(response){dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:"Validation succeeded"})};var cbError=function(details){HQCodeMessageUtil.setMessages($scope.messagesTable,$scope.editor,details)};var seq={sequence:$scope.editor.getValue()};restService.validateSequence($scope.endpointName,$scope.engineURI,seq,cbDone,cbError)};$scope.doAddAndStart=function(start){$scope.clearMessages();if(!validateExpressionLocal())return;var cbDone=function(response){HQCodeMessageUtil.clearMessages($scope.editor);
var message;if(start){message="The Sequence by name '"+$scope.sequence.sequenceExecutionName+"' was started";dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:message})}else{message="The Sequence by name '"+$scope.sequence.sequenceExecutionName+"' was added";dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:message})}$scope.closeDialogFunc()};var cbError=function(details){HQCodeMessageUtil.setMessages($scope.messagesTable,$scope.editor,details)};$scope.sequence.sequence=
$scope.editor.getValue();$scope.sequence.state=start?"STARTED":"STOPPED";restService.createSequenceExecution($scope.endpointName,$scope.engineURI,$scope.sequence,cbDone,cbError)};$scope.doAddInterval=function(){var lineNumber=$scope.editor.getCursor().line;var callback=function(data){var addedText="";var delimiter="";if(data.minutes&&data.minutes.length){addedText+=delimiter+data.minutes+" minutes";delimiter=" "}if(data.seconds&&data.seconds.length){addedText+=delimiter+data.seconds+" seconds";delimiter=
" "}if(data.millisec&&data.millisec.length)addedText+=delimiter+data.millisec+" milliseconds";if(addedText.length>0){addedText="t\x3dt.plus("+addedText+")";if(lineNumber==null){var current=$scope.editor.getValue();var append=current+"\n"+addedText;$scope.editor.setValue(append)}else $scope.editor.setLine(lineNumber,addedText)}};dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INTERVAL,{okCallback:callback})};$scope.doAddEvent=function(){var cbFetched=function(data){var callback=function(formdata){var lineNumber=
$scope.editor.getCursor().line;var append=format(data,formdata);if(lineNumber==null){var current=$scope.editor.getValue();current=current+"\n"+append;$scope.editor.setValue(current)}else $scope.editor.setLine(lineNumber,append)};dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_EVENTDATA,{eventType:data,okCallback:callback})};if($scope.eventType!=null)restService.fetchEventTypeDetail($scope.endpointName,$scope.engineURI,$scope.eventType.eventTypeName,cbFetched)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-createsequence")};
$scope.doSave=function(){var filename="Sequence1"+"."+HQ_FILETYPE.SEQUENCE.extension;var saveConfig={filename:filename,mode:HQ_FILEDIALOGOPTYPE.SAVE,body:$scope.editor.getValue(),filetype:HQ_FILETYPE.SEQUENCE};dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_FILESAVELOAD,saveConfig)};$scope.doLoad=function(){var loadCallback=function(content){$scope.clearMessages();$scope.editor.setValue(content.body)};var config={mode:HQ_FILEDIALOGOPTYPE.LOAD,filetype:HQ_FILETYPE.SEQUENCE,loadCallback:loadCallback};
dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_FILESAVELOAD,config)};var format=function(eventType,formdata){var append=eventType.eventTypeName;append+="\x3d{";var delimiter="";for(var key in formdata){if(!formdata.hasOwnProperty(key))continue;var type=findType(key,eventType.properties);var value=formdata[key];append+=delimiter;append+=key;append+="\x3d";if(type=="int"||type=="long"||type=="double"||type=="float")append+=value;else append+="'"+value+"'";delimiter=","}append+="}";return append};
var findType=function(key,properties){for(var i=0;i<properties.length;i++)if(properties[i].propertyName==key)return properties[i].propertyType;return null};var validateExpressionLocal=function(){if(!HQStringUtil.isPopulated($scope.editor.getValue())){$scope.sequenceErrorMsg="Please provide an expression text";return false}return true}};function SequenceExecDetailController($scope,dialogService,restService){$scope.endpointName=null;$scope.engineURI=null;$scope.sequence=null;$scope.logentryTable=null;$scope.closeDialog=null;$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.sequence=dialog.config.sequence;$scope.closeDialog=dialog.close;var tableConfig=HQTableUtil.getDefaultPlainDatatableConfig({"bSort":false});$scope.logentryTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,
"sequencelogentry_div").dataTable(tableConfig);applyTable($scope.logentryTable,$scope.sequence.logEntries);var editorTextarea=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"sequenceexec_editor_div")[0];$scope.editor=CodeMirror.fromTextArea(editorTextarea,HQCodeMirrorUtil.getDefaultReadOnlyConfig());$scope.editor.setValue($scope.sequence.sequence+"\n\n");$scope.$apply()};$scope.doRefresh=function(){var cbFetched=function(response){$scope.sequence=response;applyTable($scope.logentryTable,$scope.sequence.logEntries)};
restService.fetchSequenceExecutionDetail($scope.endpointName,$scope.engineURI,$scope.sequence.sequenceExecutionName,cbFetched)};$scope.doUpdateState=function(newState){var cbUpdated=function(response){var message="Sequence '"+$scope.sequence.sequenceExecutionName+"' has been ";if(newState=="STARTED")message+="started";else message+="stopped";dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:message});$scope.sequence=response;applyTable($scope.logentryTable,$scope.sequence.logEntries)};
var update={sequenceExecutionName:$scope.sequence.sequenceExecutionName,state:newState};restService.updateSequenceExecution($scope.endpointName,$scope.engineURI,update,cbUpdated)};$scope.doRemove=function(edit){var cbRemoved=function(){$scope.closeDialog();if(edit){var dialogConfig={endpointName:$scope.endpointName,engineURI:$scope.engineURI,sequence:$scope.sequence};dialogService.getOpenDialogCallback()(HQ_DIALOG.SEQUENCEEXECCREATE,dialogConfig)}else{var message="Sequence '"+$scope.sequence.sequenceExecutionName+
"' has been removed";dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:message})}};restService.deleteSequenceExecution($scope.endpointName,$scope.engineURI,$scope.sequence.sequenceExecutionName,cbRemoved)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-sequencedetail")};var applyTable=function(table,logentries){var myarr=[];for(var i=0;i<logentries.length;i++){var row=logentries[i];myarr.push([HQDateUtil.printDate(row["createdDate"]),row["text"]])}myarr.reverse();
table.fnClearTable();table.fnAddData(myarr)}};function StatementBrowseController($scope,dialogService){$scope.endpointName=null;$scope.engineURI=null;$scope.parentRootDOM=null;$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.parentRootDOM=dialog.root};$scope.parentGetEndpointName=function(){return $scope.endpointName};$scope.parentGetEngineURI=function(){return $scope.engineURI};$scope.parentHandleStatementSelect=function(statementName){var dialogConfig={endpointName:$scope.endpointName,
engineURI:$scope.engineURI,statementName:statementName};dialogService.getOpenDialogCallback()(HQ_DIALOG.STATEMENTDETAIL,dialogConfig)}};function StatementCreateController($scope,restService,dialogService){$scope.endpointName=null;$scope.engineURI=null;$scope.statement={};$scope.dialog=null;$scope.eplErrorMsg=null;$scope.editor=null;$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.dialog=dialog;var editorTextarea=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"statementcreate_editor_div")[0];$scope.editor=CodeMirror.fromTextArea(editorTextarea,
HQCodeMirrorUtil.getDefaultConfig());$scope.editor.setValue("\n\n");$scope.editor.setCursor(0,0)};$scope.doCancel=function(){$scope.dialog.close()};$scope.doValidate=function(){if(!validateExpressionLocal())return;$scope.eplErrorMsg=null;var cbError=function(details){$scope.eplErrorMsg=details[0].exceptionMessage};var cbDone=function(){dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:"Validation succeeded"})};var epl=$scope.editor.getValue();restService.validateStatement($scope.endpointName,
$scope.engineURI,{"epl":epl},cbDone,cbError)};$scope.doCreate=function(){if(!validateExpressionLocal())return;$scope.eplErrorMsg=null;var handleCreated=function(response){var message="A statement by name '"+response.statementName+"' has been created";dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:message});$scope.dialog.close()};var handleError=function(details){$scope.eplErrorMsg=details[0].exceptionMessage};var epl=$scope.editor.getValue();restService.createStatement($scope.endpointName,
$scope.engineURI,{"engineURI":$scope.engineURI,"statementName":$scope.statement.statementName,"description":$scope.statement.description,"epl":epl,"pattern":$scope.statement.pattern},handleCreated,handleError)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-createstmt")};var validateExpressionLocal=function(){if(!HQStringUtil.isPopulated($scope.editor.getValue())){$scope.eplErrorMsg="Please provide an expression text";return false}return true}};function StatementDetailController($scope,dialogService,restService){$scope.endpointName=null;$scope.engineURI=null;$scope.statement=null;$scope.propertyTable=null;$scope.closeDialog=null;$scope.statementLastChangeDate=null;$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.statement=dialog.config.statement;$scope.statementLastChangeDate=HQDateUtil.printDate(dialog.config.statement.lastStateChange);$scope.closeDialog=
dialog.close;var editorTextarea=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"statementdetail_editor_div")[0];$scope.editor=CodeMirror.fromTextArea(editorTextarea,HQCodeMirrorUtil.getDefaultReadOnlyConfig());$scope.editor.setValue($scope.statement.epl+"\n\n");var table=HQJqueryUtil.findElementById(dialog.root,"properties_table");$scope.propertyTable=table.dataTable({"bPaginate":false,"bLengthChange":false,"bFilter":false});var myarr=[];for(var i=0;i<$scope.statement.properties.length;i++){var row=
$scope.statement.properties[i];myarr.push([row["propertyName"],row["propertyType"]])}if($scope.propertyTable!=null){$scope.propertyTable.fnClearTable();$scope.propertyTable.fnAddData(myarr)}$scope.$apply()};$scope.doInstantLiveCapture=function(){var eventletXml=$scope.getEventletXML();var config={eventletName:"Live capture "+$scope.statement.statementName,eventletXml:eventletXml};dialogService.getOpenDialogCallback()(HQ_DIALOG.EVENTLET,config)};$scope.doIterate=function(){var dialogConfig={endpointName:$scope.endpointName,
engineURI:$scope.engineURI,statementName:$scope.statement.statementName};dialogService.getOpenDialogCallback()(HQ_DIALOG.STATEMENTITERATE,dialogConfig)};$scope.doDestroy=function(){$scope.transitionStmtState("DESTROYED")};$scope.doStop=function(){$scope.transitionStmtState("STOPPED")};$scope.doStart=function(){$scope.transitionStmtState("STARTED")};$scope.doSaveLiveCapture=function(){var eventletXml=$scope.getEventletXML();var filename="Statement "+$scope.statement.statementName+"."+HQ_FILETYPE.EVENTLET.extension;
var saveConfig={filename:filename,mode:HQ_FILEDIALOGOPTYPE.SAVE,body:eventletXml,filetype:HQ_FILETYPE.EVENTLET};dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_FILESAVELOAD,saveConfig)};$scope.doEventletWizard=function(){var wizardConfig={resource:{statement:{endpoint:$scope.endpointName,engineUri:$scope.engineURI,name:$scope.statement.statementName}}};dialogService.getOpenDialogCallback()(HQ_DIALOG.EVENTLETWIZARD,wizardConfig)};$scope.transitionStmtState=function(newState){var updates={state:newState};
var cbUpdated=function(){var message="The statement by name '"+$scope.statement.statementName+"' has been transitioned to "+newState;dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:message});$scope.closeDialog()};restService.updateStatement($scope.endpointName,$scope.engineURI,$scope.statement.statementName,updates,cbUpdated)};$scope.getEventletXML=function(){var eventletXml="\x3ceventlet\x3e            \x3ccomposition\x3e                \x3cappendgrid/\x3e            \x3c/composition\x3e            \x3csources\x3e            \x3csource sourceId\x3d'1'\x3e                \x3cstatement name\x3d'replace__statementName' engineUri\x3d'replace__engineURI' endpoint\x3d'replace__endpoint'/\x3e            \x3c/source\x3e            \x3c/sources\x3e        \x3c/eventlet\x3e";
eventletXml=eventletXml.replace(/replace__statementName/gi,$scope.statement.statementName);eventletXml=eventletXml.replace(/replace__engineURI/gi,$scope.engineURI);eventletXml=eventletXml.replace(/replace__endpoint/gi,$scope.endpointName);return eventletXml};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-statement")}};function StatementIterateController($scope,restService){$scope.endpointName=null;$scope.engineURI=null;$scope.statementName=null;$scope.maxRows=100;$scope.maxRowsInvalid=false;$scope.tableelement=null;$scope.resultTable=null;$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.statementName=dialog.config.statementName;$scope.tableelement=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"statementiterate_table");$scope.resultTable=
HQTableUtil.createTableFromPropsAndEvents($scope.tableelement,dialog.config.rows.properties,dialog.config.rows.events)};$scope.doCancel=function(){$scope.dialog.close()};$scope.doPerformQuery=function(){$scope.maxRowsInvalid=!HQValidationUtil.validateIntOrBlank($scope.maxRows);if($scope.maxRowsInvalid)return;if($scope.resultTable!=null){$scope.resultTable.fnClearTable();$scope.resultTable.fnDestroy();$scope.resultTable=null}$scope.tableelement.children(":first").children(":first").empty();var handleResult=
function(response){$scope.resultTable=HQTableUtil.createTableFromPropsAndEvents($scope.tableelement,response.properties,response.events)};restService.iterateStatement($scope.endpointName,$scope.engineURI,$scope.statementName,$scope.maxRows,handleResult)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-stmtiterator")}};function StatementMemoryBrowseController($scope,restService){$scope.endpointName=null;$scope.engineURI=null;$scope.parentRootDOM=null;$scope.step=0;$scope.stepAccessible=0;$scope.steps=["one","two"];$scope.selectedStmtNames=[];$scope.allStatements={};$scope.refreshMemoryTarget=new EventTarget;$scope.confirmed=false;$scope.confirmedMsg=null;$scope.optionsButtonText=null;$scope.optionsShown=false;$scope.options={reportMemoryUse:true,dataWindowContainedDetail:false,groupByAggregationPerGroupDetail:false,
matchRecognizeStateAndPartitionDetail:false,patternSubexpressionCountDetail:false,patternEveryDistinctDetail:false,tableRowDetail:false};$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.confirmed=dialog.config.hasOwnProperty("confirmed")?dialog.config.confirmed:false;$scope.parentRootDOM=dialog.root;$scope.optionsButtonText=getOptionsButtonText($scope.optionsShown)};$scope.doShowHideOptions=function(){$scope.optionsShown=
!$scope.optionsShown;$scope.optionsButtonText=getOptionsButtonText($scope.optionsShown)};$scope.parentGetEndpointName=function(){return $scope.endpointName};$scope.parentGetEngineURI=function(){return $scope.engineURI};$scope.parentHandleStatementSelected=function(selectedStmtNames,allStatements){$scope.selectedStmtNames=selectedStmtNames;$scope.allStatements=allStatements;$scope.stepAccessible=selectedStmtNames.length==0?0:1};$scope.isFirstStep=function(){return $scope.step===0};$scope.isLastStep=
function(){return $scope.step===$scope.steps.length-1};$scope.isCurrentStep=function(step){return $scope.step===step};$scope.setCurrentStep=function(step){$scope.step=step;if(step==1){if(!$scope.checkConfirmed()){$scope.step=0;return}$scope.doFetch()}};$scope.getCurrentStep=function(){return $scope.steps[$scope.step]};$scope.isStepAccessible=function(step){return $scope.stepAccessible>=step};$scope.getNextLabel=function(){return"Report Metrics"};$scope.handlePrevious=function(){$scope.step-=$scope.isFirstStep()?
0:1};$scope.doHandleNext=function(dismiss){if(!$scope.checkConfirmed())return;if(!$scope.isLastStep()){$scope.step+=1;if($scope.step>$scope.stepAccessible)$scope.stepAccessible=$scope.step}$scope.doFetch()};$scope.doFetch=function(){var cbFetched=function(response){$scope.refreshMemoryTarget.fire({type:HQ_EVENTTARGET_TYPE.REFRESHMEMORY.name,statements:response.statements,allStatements:$scope.allStatements})};var request={statementNames:$scope.selectedStmtNames,optionsJson:JSON.stringify($scope.options)};
restService.fetchEngineStmtMetric($scope.endpointName,$scope.engineURI,request,cbFetched)};$scope.checkConfirmed=function(){if(!$scope.confirmed){$scope.confirmedMsg="Please acknowledge.";return false}$scope.confirmedMsg=null;return true};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("pushmonitoring-statementmemory")};var getOptionsButtonText=function(optionsShown){return optionsShown?"Hide Options":"Show Options"}};function StatementMemoryBrowseMemoryController($scope,dialogService){$scope.statements=[];$scope.cbRefresh=function(event){$scope.statements=[];var all=event.allStatements;var memoryStmts=event.statements;for(var i=0;i<memoryStmts.length;i++){var stmt=memoryStmts[i];var stmtDetail=$scope.findStatement(stmt.statementName,all);if(stmtDetail==null)continue;var stmtPartitions=stmt.partitions;if(stmtPartitions==null)continue;var partitions=[];for(var j=0;j<stmtPartitions.length;j++){var partition=stmtPartitions[j];
var detail=partition.detail;var viewInfo=computeViews(detail.views);var patternInfo=computePatterns(detail.patterns);var aggregationInfo=computeAggregation(detail.aggregation);var regexInfo=computeRegex(detail.matchRecognize);var tableInfo=computeTable(detail.table);var indexInfo=computeIndexes(detail.indexes);var subqueryInfo=computeSubqueries(detail.subqueries);var totalInfo=computeTotals(viewInfo,patternInfo,aggregationInfo,regexInfo,tableInfo,indexInfo,subqueryInfo);var name="Partition "+partition.id;
var lockTimeMSec=null;if(typeof detail.lockedTimeNano=="number")lockTimeMSec=(detail.lockedTimeNano/1E3/1E3).toFixed(3);var partitionrow={id:detail.id,name:name,lockTimeMSec:lockTimeMSec,viewInfo:viewInfo,patternInfo:patternInfo,aggregationInfo:aggregationInfo,regexInfo:regexInfo,tableInfo:tableInfo,indexInfo:indexInfo,subqueryInfo:subqueryInfo,totalInfo:totalInfo};partitions.push(partitionrow)}var statementrow={statementName:stmtDetail.statementName,epl:stmtDetail.eplFull,type:stmtDetail.type,description:stmtDetail.description,
partitions:partitions};$scope.statements.push(statementrow)}};$scope.refreshMemoryTarget.addListener(HQ_EVENTTARGET_TYPE.REFRESHMEMORY.name,$scope.cbRefresh);$scope.findStatement=function(statementName,all){for(var i=0;i<all.length;i++){var row=all[i];if(row.statementName==statementName)return row}return null};$scope.doExpandViewDetail=function(view){view.viewDetailExpanded=!view.viewDetailExpanded};$scope.doExpandAggGroup=function(agg){agg.aggGroupsExpanded=!agg.aggGroupsExpanded};$scope.doExpandMatchRecogPartition=
function(regex){regex.partitionsExpanded=!regex.partitionsExpanded};$scope.doExpandPatternSubSummary=function(pattern){pattern.subexpressionsExpanded=!pattern.subexpressionsExpanded};$scope.doExpandEveryDistinct=function(pattern){pattern.everyDistinctsExpanded=!pattern.everyDistinctsExpanded};$scope.doExpandTableRows=function(table){table.tableRowsExpanded=!table.tableRowsExpanded};var computeTotals=function(viewInfo,patternInfo,aggregationInfo,regexInfo,tableInfo,indexInfo,subqueryInfo){var totalsInfo=
new TotalsInfo;totalsInfo.totalBytes=HQCollectionUtil.sumIgnoreNull([viewInfo.totalBytes,patternInfo.totalBytes,aggregationInfo.totalBytes,regexInfo.totalBytes,tableInfo.totalBytes,indexInfo.totalBytes,subqueryInfo.totalBytes]);totalsInfo.totalBytesStr=HQStringUtil.getHumanSizeBytes(totalsInfo.totalBytes);if(viewInfo.totalBytes>0)totalsInfo.totals.push({name:"All Data Windows",bytesStr:viewInfo.totalBytesStr});if(patternInfo.totalBytes>0)totalsInfo.totals.push({name:"All Patterns",bytesStr:patternInfo.totalBytesStr});
if(aggregationInfo.totalBytes>0)totalsInfo.totals.push({name:"Aggregation",bytesStr:aggregationInfo.totalBytesStr});if(regexInfo.totalBytes>0)totalsInfo.totals.push({name:"Match Recognize",bytesStr:regexInfo.totalBytesStr});if(tableInfo.totalBytes>0)totalsInfo.totals.push({name:"Table",bytesStr:tableInfo.totalBytesStr});if(indexInfo.totalBytes>0)totalsInfo.totals.push({name:"Indexes",bytesStr:indexInfo.totalBytesStr});if(subqueryInfo.totalBytes>0)totalsInfo.totals.push({name:"Subqueries",bytesStr:subqueryInfo.totalBytesStr});
return totalsInfo};var computeAggregation=function(stmtagg){var aggInfo=new AggregationInfo;aggInfo.totalBytes=stmtagg==null?0:stmtagg.bytes;aggInfo.totalBytesStr=HQStringUtil.getHumanSizeBytes(aggInfo.totalBytes);aggInfo.groupCount=stmtagg==null?0:stmtagg.groupCount;aggInfo.displayagg=stmtagg!=null;if(stmtagg!=null&&stmtagg.hasOwnProperty("groups")){aggInfo.aggGroupsExpandable=true;for(var i=0;i<stmtagg.groups.length;i++){var grp=stmtagg.groups[i];aggInfo.groups.push({group:grp.groupKey,bytesStr:HQStringUtil.getHumanSizeBytes(grp.bytes)})}}return aggInfo};
var computeTable=function(stmttbl){var tableInfo=new TableInfo;tableInfo.totalBytes=stmttbl==null?0:stmttbl.bytes;tableInfo.totalBytesStr=HQStringUtil.getHumanSizeBytes(tableInfo.totalBytes);tableInfo.rowCount=stmttbl==null?0:stmttbl.rowCount;tableInfo.displaytable=stmttbl!=null;if(stmttbl!=null&&stmttbl.hasOwnProperty("rows")){tableInfo.tableRowsExpandable=true;for(var i=0;i<stmttbl.rows.length;i++){var tblrow=stmttbl.rows[i];tableInfo.rows.push({rowkey:tblrow.rowKey,bytesStr:HQStringUtil.getHumanSizeBytes(tblrow.bytes)})}}return tableInfo};
var computeRegex=function(stmtregex){var regexInfo=new RegexInfo;regexInfo.totalBytes=stmtregex==null?0:stmtregex.bytes;regexInfo.totalBytesStr=HQStringUtil.getHumanSizeBytes(regexInfo.totalBytes);regexInfo.partitionCount=stmtregex==null?0:stmtregex.partitionCount;regexInfo.eventCount=stmtregex==null?0:stmtregex.eventCount;regexInfo.displayregex=stmtregex!=null;if(stmtregex!=null&&stmtregex.hasOwnProperty("detail")){var detail=stmtregex.detail;regexInfo.regexdetail.push({name:"Num. States",value:detail.stateCount});
regexInfo.partitionsExpandable=true;for(var i=0;i<detail.partitions.length;i++){var partition=detail.partitions[i];regexInfo.partitions.push({partition:partition.partitionKey,bytesStr:HQStringUtil.getHumanSizeBytes(partition.bytes),stateCount:partition.stateCount,eventCount:partition.eventCount})}}return regexInfo};var computeViews=function(stmtviews){var viewInfo=new ViewsInfo;var bytesTotal=new NumberTotalNullable;var eventCountTotal=new NumberTotalNullable;for(var i=0;i<stmtviews.length;i++){var row=
stmtviews[i];viewInfo.views.push({stream:row.streamNum,viewName:row.viewName,bytesStr:HQStringUtil.getHumanSizeBytes(row.bytes),eventCount:row.eventCount,viewdetail:computeViewDetail(row),viewDetailExpandable:row.hasOwnProperty("contained"),viewDetailExpanded:false,viewDetail:row.hasOwnProperty("contained")?addByteStrToByteInArray(row.contained):[]});var hasView=HQStringUtil.isPopulated(row.viewName);bytesTotal.add(hasView?row.bytes:0);eventCountTotal.add(hasView?row.eventCount:0)}viewInfo.totalBytes=
bytesTotal.get();viewInfo.totalBytesStr=HQStringUtil.getHumanSizeBytes(viewInfo.totalBytes);viewInfo.totalEventCount=eventCountTotal.get();return viewInfo};var computeViewGroupExpandable=function(view){if(!view.hasOwnProperty("groupWin")||view.groupWin.groups==null)return null;return view.groupWin.groups.length>0};var computeViewDetail=function(view){var detail=[];if(view.hasOwnProperty("uniqueKeyCount"))detail.push({name:"Num. Unique Keys",value:view.uniqueKeyCount});return detail};var computePatterns=
function(stmtpatterns){var patternInfo=new PatternsInfo;var subexpressionTotal=0;for(var i=0;i<stmtpatterns.length;i++){var row=stmtpatterns[i];patternInfo.patterns.push({stream:row.streamNum,bytesStr:HQStringUtil.getHumanSizeBytes(row.bytes),subexpressionCount:row.subexpressionCount,eventCount:row.eventCount,subexpressionsExpanded:false,everyDistinctsExpanded:false,subexpressions:addByteStrToByteInArray(row.subexpressions),everyDistincts:addByteStrToByteInArray(row.everyDistincts)});patternInfo.totalBytes+=
row.bytes;subexpressionTotal+=row.subexpressionCount}patternInfo.totalBytesStr=HQStringUtil.getHumanSizeBytes(patternInfo.totalBytes);patternInfo.totalSubexpressionCount=subexpressionTotal;return patternInfo};var addByteStrToByteInArray=function(subs){if(subs==null)return null;for(var i=0;i<subs.length;i++)subs[i].bytesStr=HQStringUtil.getHumanSizeBytes(subs[i].bytes);return subs};var computeIndexes=function(stmtindexes){var indexInfo=new IndexInfo;for(var i=0;i<stmtindexes.length;i++){var row=stmtindexes[i];
var item={name:row.hasOwnProperty("name")?row.name:"",stream:row.streamNum,bytesStr:HQStringUtil.getHumanSizeBytes(row.bytes),keyCount:row.keyCount,eventCount:row.eventCount};indexInfo.indexes.push(item);indexInfo.totalBytes+=row.bytes}indexInfo.totalBytesStr=HQStringUtil.getHumanSizeBytes(indexInfo.totalBytes);return indexInfo};var computeSubqueries=function(stmtsubq){var subqInfo=new SubqueryInfo;for(var i=0;i<stmtsubq.length;i++){var row=stmtsubq[i];var subqTotalBytes=0;var items=[];if(row.view!=
null){subqInfo.totalBytes+=row.view.bytes;subqTotalBytes+=row.view.bytes;items.push({name:"Data Window "+row.view.viewName,bytesStr:HQStringUtil.getHumanSizeBytes(row.view.bytes),eventCount:row.view.eventCount,detail:computeViewDetail(row.view),viewDetailExpandable:row.view.hasOwnProperty("contained"),viewDetailExpanded:false,viewDetail:row.view.hasOwnProperty("contained")?addByteStrToByteInArray(row.view.contained):[]})}if(row.index!=null){subqInfo.totalBytes+=row.index.bytes;subqTotalBytes+=row.index.bytes;
items.push({name:"Index",bytesStr:HQStringUtil.getHumanSizeBytes(row.index.bytes),eventCount:row.index.eventCount})}if(row.aggregation!=null){subqInfo.totalBytes+=row.aggregation.bytes;subqTotalBytes+=row.aggregation.bytes;items.push({name:"Aggregation",bytesStr:HQStringUtil.getHumanSizeBytes(row.aggregation.bytes)})}subqInfo.subqueries.push({subqueryNum:row.subqueryNum,items:items,totalBytesStr:HQStringUtil.getHumanSizeBytes(subqTotalBytes)})}subqInfo.totalBytesStr=HQStringUtil.getHumanSizeBytes(subqInfo.totalBytes);
return subqInfo};var ViewsInfo=function(){this.totalBytesStr=0;this.totalBytes=0;this.totalEventCount=0;this.views=[]};var PatternsInfo=function(){this.totalBytesStr=0;this.totalBytes=0;this.totalSubexpressionCount=0;this.patterns=[]};var AggregationInfo=function(){this.totalBytesStr=0;this.totalBytes=0;this.groupCount=0;this.aggGroupsExpandable=false;this.aggGroupsExpanded=false;this.groups=[];this.displayagg=false};var TableInfo=function(){this.totalBytesStr=0;this.totalBytes=0;this.rowCount=0;
this.tableRowsExpandable=false;this.tableRowsExpanded=false;this.rows=[];this.displaytable=false};var RegexInfo=function(){this.totalBytesStr=0;this.totalBytes=0;this.partitionCount=0;this.regexdetail=[];this.partitionsExpandable=false;this.partitionsExpanded=false;this.partitions=[];this.displayregex=false};var IndexInfo=function(){this.totalBytesStr=0;this.totalBytes=0;this.indexes=[]};var SubqueryInfo=function(){this.totalBytesStr=0;this.totalBytes=0;this.subqueries=[]};var TotalsInfo=function(){this.totalBytesStr=
0;this.totalBytes=0;this.totals=[]}};function StatementMemoryBrowseStmtSelectController($scope,dialogService,restService){$scope.statements=[];$scope.selectionExpr=null;$scope.selectAll=true;$scope.searchExpr=null;$scope.doGet=function(all,selectAll){var handle=function(response){$scope.statements=[];for(var i=0;i<response.statements.length;i++){var row=response.statements[i];if(!checkType(row.type))continue;var stmt={selected:false,statementName:row.statementName,eplShort:HQStringUtil.escapeHTML(HQStringUtil.firstNChars(row.eplNoAnnotation,
60)),eplFull:row.eplNoAnnotation,type:row.type,description:row.description,shown:true};$scope.statements.push(stmt)}if(selectAll)$scope.doSelectAll();$scope.doApplySearch()};restService.fetchStatements($scope.parentGetEndpointName(),$scope.parentGetEngineURI(),$scope.selectionExpr,all,false,handle)};$scope.doApplySearch=function(){var filtered=HQStringUtil.isPopulated($scope.searchExpr);var filter=filtered?$.trim($scope.searchExpr).toLowerCase():"";for(var i=0;i<$scope.statements.length;i++){var row=
$scope.statements[i];if(!filtered){row.shown=true;continue}var b1=row.statementName.toLowerCase().indexOf(filter)!=-1;var b2=row.eplFull.toLowerCase().indexOf(filter)!=-1;var b3=row.type!=null&&row.type.toLowerCase().indexOf(filter)!=-1;var b4=row.description!=null&&row.description.toLowerCase().indexOf(filter)!=-1;row.shown=b1||b2||b3||b4}};$scope.doRefresh=function(){$scope.doGet(false)};$scope.doOpenCriteria=function(){var callback=function(expression){$scope.selectionExpr=expression;$scope.$apply()};
dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_STMTSELECTION,{okCallback:callback})};$scope.doClickCheckStmt=function(index){$scope.parentHandleStatementSelected(getSelectedNames(),$scope.statements)};$scope.doSelectAll=function(){for(var i=0;i<$scope.statements.length;i++)$scope.statements[i].selected=$scope.selectAll;$scope.selectAll=!$scope.selectAll;$scope.parentHandleStatementSelected(getSelectedNames(),$scope.statements)};var checkType=function(type){if(type=="CREATE_VARIABLE"||type==
"CREATE_SCHEMA"||type=="CREATE_INDEX"||type=="CREATE_CONTEXT"||type=="CREATE_DATAFLOW"||type=="CREATE_EXPRESSION"||type=="ON_SET"||type=="UPDATE"||type=="ON_SPLITSTREAM")return false;return true};var getSelectedNames=function(){var names=[];for(var i=0;i<$scope.statements.length;i++)if($scope.statements[i].selected)names.push($scope.statements[i].statementName);return names}};function StatementSelectionController($scope){$scope.okCallback=null;$scope.close=null;$scope.dialogSelectionExpr=null;$scope.doInitialize=function(dialog){$scope.okCallback=dialog.config.okCallback;$scope.close=dialog.close};$scope.doCloseCriteria=function(ok){if(ok)$scope.okCallback($scope.dialogSelectionExpr);$scope.close()};$scope.parentSetStatementSelectionExpression=function(text){$scope.dialogSelectionExpr=text};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-statementselection")}}
;function VariableBrowseController($scope,dialogService,restService){$scope.endpointName=null;$scope.engineURI=null;$scope.variableTable=null;$scope.variables=null;$scope.variable=null;$scope.newValue="";$scope.newValueNull=false;$scope.doInitialize=function(dialog){$scope.endpointName=dialog.config.endpointName;$scope.engineURI=dialog.config.engineURI;$scope.variables=dialog.config.variables;$scope.variableTable=HQJqueryUtil.findFirstChildElementUnderId(dialog.root,"variables_div").dataTable(HQTableUtil.getDefaultFullDatatableConfig({}));
$scope.variableTable.delegate("tr","click",function(){var rownum=$scope.variableTable.fnGetPosition(this);$scope.variable=null;if(rownum!=null){var selected=$scope.variables.variables[rownum];if(!selected.constant){$scope.newValue="";$scope.newValueNull=false;$scope.variable=selected}}$scope.$apply()});applyTable($scope.variableTable,$scope.variables.variables)};$scope.doRefresh=function(dialog){var cbFetched=function(response){$scope.variables=response;applyTable($scope.variableTable,$scope.variables.variables)};
restService.fetchVariables($scope.endpointName,$scope.engineURI,cbFetched)};$scope.doApply=function(dialog){var cbDone=function(){$scope.newValue=null;$scope.newValueNull=false;var message="The variable by name '"+$scope.variable.variableName+"' has been set to a new value";dialogService.getOpenDialogCallback()(HQ_DIALOG.SHARED_INFOALERT,{message:message});$scope.variable=null;$scope.doRefresh()};var newValues={valueString:$scope.newValue,isNull:$scope.newValueNull};restService.updateVariable($scope.endpointName,
$scope.engineURI,$scope.variable.variableName,newValues,cbDone)};$scope.doHelp=function(){HQHelpDialogHelper.openHelp("enginemgmt-variable")};$scope.doNewValueNullChange=function(){if($scope.newValueNull)$scope.newValue=null};var applyTable=function(table,variables){var myarr=[];for(var i=0;i<variables.length;i++){var row=variables[i];var stringValue=row["valueString"];myarr.push([row["variableName"],stringValue==undefined?"(null)":stringValue,HQStringUtil.emptyString(row["variableType"]),row["constant"]])}table.fnClearTable();
table.fnAddData(myarr)}};